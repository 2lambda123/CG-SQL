<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Introducing Blob Storage | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Introducing Blob Storage | CG/SQL"><meta data-react-helmet="true" name="description" content="Introduction and Context"><meta data-react-helmet="true" property="og:description" content="Introduction and Context"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.9ec987f3.css">
<link rel="preload" href="/styles.58a786a3.js" as="script">
<link rel="preload" href="/runtime~main.6e310b00.js" as="script">
<link rel="preload" href="/main.f2c34c0c.js" as="script">
<link rel="preload" href="/1.fae5e295.js" as="script">
<link rel="preload" href="/2.0eb37f9a.js" as="script">
<link rel="preload" href="/3.5c2742cc.js" as="script">
<link rel="preload" href="/ccc49370.b5baea19.js" as="script">
<link rel="preload" href="/fe11938d.001e1f5c.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div class="announcementBar_1l0Z" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_1xni">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Introducing Blob Storage</h1><div class="margin-vert--md"><time datetime="2022-03-17T00:00:00.000Z" class="blogPostDate_3bQP">March 17, 2022  Â· 10 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="introduction-and-context"></a>Introduction and Context<a aria-hidden="true" tabindex="-1" class="hash-link" href="#introduction-and-context" title="Direct link to heading">#</a></h2><p>The general idea here is that you might want to store composite data in a single column in the database.  This is a common way to get more generic schema, the idea being that you can have one or more blob columns that store in tables a lot of data that doesn&#x27;t have to be indexed. You could store it in other ways, like a JSON blob or some such, but we&#x27;ll be using blobs as the basis for storage here -- hence
the name blob &quot;storage&quot;.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-do-i-define-one-of-these-blobs"></a>How do I define one of these blobs?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-do-i-define-one-of-these-blobs" title="Direct link to heading">#</a></h3><p>In SQL/CQL, the main way you define structures, especially those that you want to maintain, is with tables.  Hence we introduce this</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>The <code>blob_storage attribute</code> indicates that the thing we&#x27;re about to define here is not really going to be a materialized table.  As a result, you will not be
able to (e.g.) <code>DROP</code> the table or <code>SELECT</code> from it, and there will be no schema upgrade for it should you request one. However, the usual schema rules still
apply which help you to create compatible versions of this structure.  For instance, new columns can be added only at the end, and only if they are nullable.
Here we add <code>source</code> to the schema in a hypothetical &quot;version 6&quot;.  Note that schema versions move forward globally in the schema, not locally in one table; this implies there are versions 1-5 elsewhere, not shown.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  source </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Additionally, since the storage is not backed by SQL with SQL&#x27;s constraint system, default values and constraints are not allowed in a table marked
with <code>cql:blob_storage</code>; it&#x27;s just data. Similarly, triggers, views, and indices may not use the &quot;table&quot;.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="where-do-you-keep-your-blob-storage"></a>Where do you keep your blob storage?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#where-do-you-keep-your-blob-storage" title="Direct link to heading">#</a></h3><p>Naturally, blob storage goes in a blob field, but recall CQL has discriminated types so we could make something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id long </span><span class="token keyword" style="font-style:italic">primary</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  news_info </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>From a SQL perspective <code>news_info</code> is just a blob.  That means if you want to do a <code>WHERE</code> clause or something like that on the info,
you&#x27;re out of luck.  Maybe you could write a user-defined function to crack the blob and so forth but really this isn&#x27;t the point.
If you&#x27;re using this feature then, by construction, you don&#x27;t need to index on this data.  It&#x27;s simply not suitable for use at all
if you need field-at-a-time access within SQL.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-do-i-make-one-of-these-blobs"></a>How do I make one of these blobs?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-do-i-make-one-of-these-blobs" title="Direct link to heading">#</a></h3><p>The natural place that CQL stores structures is in value cursors so the most natural thing to do is to provide a variation of the <code>SET</code>
statement that lets you load a blob from a cursor like so:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> make_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>This declares a cursor, loads it from argument values, and converts it to a blob.  Of course all of the usual cursor building forms can be
used to power your blob creation, you just do one serialization at the end.  The above is assembling a blob from arguments but you could
equally make the blob from data.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id_ long </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- use our columns sugar syntax for getting just news_info columns from</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a table with potentially lots of stuff (or an error if it&#x27;s missing columns)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> some_source_of_info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>There are <em>many</em> cursor fetch forms, including dummy data forms and other interesting bits of sugar.  You can fetch a cursor from arguments,
from other cursors, and even combinations.  We want all of that to work for blobs as well without adding tons of new syntax and code generation.
The obvious way to accomplish that is for cursors to be the source of blobs.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="how-do-i-unpack-one-of-these-blobs"></a>How do I unpack one of these blobs?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#how-do-i-unpack-one-of-these-blobs" title="Direct link to heading">#</a></h3><p>Again, the normal way that you work with records in CQL is by creating suitable cursors. These can be economically accessed on a field-by-field basis.
What we need is a way to easily recreate a cursor from the blob so we can read the data values. This gives rise to this form:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let b :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> news_info </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_ </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> nothing </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- note this can fail</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- now use c.who, c.what, etc.</span></div></div></div></div></div><p>Data loaded in a cursor is very economical to access on a field-by-field basis, and, since the deserialization of the blob happens all at once, that is also economical.
Importantly, we cannot assume that the blob is well formed, it could be coming from anywhere.  For secure-code reasons we must assume it is hostile.  Hence the
decoding validates the shape, internal lengths, and so forth.</p><p>If we had instead started with something this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">let b :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> news_info </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_ </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> nothing </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Then maybe we might like to write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">if b.who == &#x27;U2&#x27;) then ... end if;</span></div></div></div></div></div><p>However, this sort of thing would be very uneconomical. For one thing, the blob does not have fixed-offset fields: It is carrying all the serialized data for the string fields
and so forth.  Each &quot;dot&quot; operation would be costly and, furthermore, each &quot;dot&quot; operation could fail if the blob is badly formed.  Having to deal with a <code>b.who</code> that might fail
seems very bad indeed.</p><p>Once you have the cursor you can make new blobs with different combinations, slice the cursor fields using the <code>LIKE</code> operator, return the cursor with <code>OUT</code>, or <code>OUT UNION</code>,
or pass the blob fields as arguments to functions using the <code>FROM</code> forms. Cursors already are super flexible in terms of what you can do with their contents.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="what-is-the-representation-of-one-of-these-blobs"></a>What is the representation of one of these blobs?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#what-is-the-representation-of-one-of-these-blobs" title="Direct link to heading">#</a></h3><p>It&#x27;s important that we allow the blobs to evolve over time, so each blob has to be self-describing.  We also want to be able to throw an error if you use the wrong kind of blob when
loading a cursor, so the blob has to contain the following:</p><ul><li>the number of columns in the blob data type when it was stored</li><li>the type of each field is encoded as a single plain-text character<ul><li>the types are bool, int, long, (double) real, (string) text, blob;</li><li>we use &#x27;f&#x27; (flag) for bools, hence &quot;fildsb&quot;</li><li>these are encoded with one letter each, upper case meaning &#x27;not null&#x27; so the storage might be &quot;LFss&quot;</li><li>the buffer begins with a null terminated string that serve for both the count and the types</li></ul></li><li>Each nullable field may be present or null; 1 bit is used to store this fact.  The bits are in an array of bytes that comes immediately after the type info (which implicitly tells us its size)</li><li>Boolean values are likewise encoded as bits within the same array, so the total number of bits stored is nullables plus booleans (nullable booleans use 2 bits)</li><li>If you are reading a newer version of a record from an older piece of data that is missing a column then the column is assumed to be NULL</li><li>Any columns you add after the initial version (using @create) must be nullable; this is normal for adding columns to existing schema</li><li>Integers and longs are stored in varint format after zigzag encoding</li><li>Text is stored inline in null terminated strings (embedded nulls are not allowed in CQL text)</li><li>Nested blobs are stored inline, with a length prefix encoded like any other int</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="what-about-more-than-one-row-in-a-blob"></a>What about more than one row in a blob?<a aria-hidden="true" tabindex="-1" class="hash-link" href="#what-about-more-than-one-row-in-a-blob" title="Direct link to heading">#</a></h3><p>Well, this is a bit more advanced but in principle this could be done as well.  To make it useful, we would want to make a new cursor type that can iterate over rows in a blob. The syntax leaves
room for this, something like so:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- the usual stuff</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>This cursor would be another variation; it would keep its current index into the blob to read data out of it.  Such a blob would also have to include a count of rows as part of its storage.</p><p>However, that&#x27;s future looking. There is no such support at present.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="conclusion"></a>Conclusion<a aria-hidden="true" tabindex="-1" class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h3><p>With a fairly modest amount of work, we now support structured storage natively and have pretty rich language constructs.  We carefully chose language constructs that lead to economical
serialization and deserialization patterns and a record format that is versioned well, without resorting to something super loose like JSON.</p><p>As with many other features, it&#x27;s possible to replace the (de)serialization with code of your choice by supplying your own runtime methods.  So for instance, thrift encoding is possible;
though it is more flexible than is strictly necessary for the few SQL data types, it might be convenient.</p><p>Storage types that are going to be persisted in the database or go over a wire-protocol should be managed like schema with the usual validation rules.  On the other hand,
formats that will be used only transiently in memory can be changed at whim from version to version.  As mentioned above, the design specifically considers cases where a new
client discovers and old-format blob (with fewer columns) and, the reverse, cases where an old client recieves a datagram from a new client with too many columns.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="appendix"></a>Appendix<a aria-hidden="true" tabindex="-1" class="hash-link" href="#appendix" title="Direct link to heading">#</a></h4><p>A more complete example is included for reference.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a place where the blob appears in storage</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> some_table</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  y </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  news_blob </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that creates the blob from loose args</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> make_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that cracks the blob</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> crack_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">data</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that cracks the blob into loose args if needed</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- the OUT statement was created specifically to allow you to avoid this sort mass OUT awfulness</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> crack_blob_to_vars</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">data</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> when_ long</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> who :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">who</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> what :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">what</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> when_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">when_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this just defines a shape for the part we are keeping from the original structure</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  x </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  y </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this just defines a shape for the result we want</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- we&#x27;re never actually defining this procedure</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_result_shape</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> select_and_crack</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">whatever_condition </span><span class="token keyword" style="font-style:italic">bool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> some_table </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> whatever_condition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- crack the blob in c</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> n </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> n </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">news_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- assemble the result we want from the parts we have</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_result_shape</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> c </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- emit one row</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><div><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2022-03-17-blob-storage.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/from-general"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Using the FROM construct in more places Â»</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction-and-context" class="table-of-contents__link">Introduction and Context</a><ul><li><a href="#how-do-i-define-one-of-these-blobs" class="table-of-contents__link">How do I define one of these blobs?</a></li><li><a href="#where-do-you-keep-your-blob-storage" class="table-of-contents__link">Where do you keep your blob storage?</a></li><li><a href="#how-do-i-make-one-of-these-blobs" class="table-of-contents__link">How do I make one of these blobs?</a></li><li><a href="#how-do-i-unpack-one-of-these-blobs" class="table-of-contents__link">How do I unpack one of these blobs?</a></li><li><a href="#what-is-the-representation-of-one-of-these-blobs" class="table-of-contents__link">What is the representation of one of these blobs?</a></li><li><a href="#what-about-more-than-one-row-in-a-blob" class="table-of-contents__link">What about more than one row in a blob?</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.58a786a3.js"></script>
<script src="/runtime~main.6e310b00.js"></script>
<script src="/main.f2c34c0c.js"></script>
<script src="/1.fae5e295.js"></script>
<script src="/2.0eb37f9a.js"></script>
<script src="/3.5c2742cc.js"></script>
<script src="/ccc49370.b5baea19.js"></script>
<script src="/fe11938d.001e1f5c.js"></script>
</body>
</html>