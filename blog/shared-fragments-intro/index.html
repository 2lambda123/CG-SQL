<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-post-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CG/SQL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CG/SQL Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-49","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-rh="true">Introducing Shared Fragments | CG/SQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cgsql.dev/blog/shared-fragments-intro"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docusaurus_tag" content="default"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docsearch:docusaurus_tag" content="default"><meta data-rh="true" property="og:title" content="Introducing Shared Fragments | CG/SQL"><meta data-rh="true" name="description" content="Shared fragments are a real game-changer for CQL."><meta data-rh="true" property="og:description" content="Shared fragments are a real game-changer for CQL."><meta data-rh="true" property="og:type" content="article"><meta data-rh="true" property="article:published_time" content="2021-12-14T00:00:00.000Z"><meta data-rh="true" property="article:author" content="https://github.com/facebookincubator"><meta data-rh="true" property="article:tag" content="facebook,cg-sql"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cgsql.dev/blog/shared-fragments-intro"><link data-rh="true" rel="alternate" href="https://cgsql.dev/blog/shared-fragments-intro" hreflang="en"><link data-rh="true" rel="alternate" href="https://cgsql.dev/blog/shared-fragments-intro" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.7db86f2e.css">
<link rel="preload" href="/assets/js/runtime~main.4aa826ed.js" as="script">
<link rel="preload" href="/assets/js/main.79429da8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_KsVm">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CG/SQL</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_TMXw thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_V4zb margin-bottom--md">Recent posts</div><ul class="sidebarItemList_uHd5 clean-list"><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/blob-storage">Introducing Blob Storage</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/from-general">Using the FROM construct in more places</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/expression-frags">Introducing Expression Fragments</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/columns-sugar">Using the LIKE form in the SELECT statement</a></li><li class="sidebarItem_spIe"><a class="sidebarItemLink_eqrF" href="/blog/flow-analysis">Control Flow Analysis in CQL</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_rzP5" itemprop="headline">Introducing Shared Fragments</h1><div class="blogPostData_Zg1s margin-vert--md"><time datetime="2021-12-14T00:00:00.000Z" itemprop="datePublished">December 14, 2021</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_FlmR"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div id="post-content" class="markdown" itemprop="articleBody"><p>Shared fragments are a real game-changer for CQL.</p><p>Remember, these are designed to let you write part of a query and then substitute in parameters.  So it&#x27;s like a parameterized view in normal SQL terms.  But actually it&#x27;s more powerful than that, fragments also provide features that are more like Java generics.  Let&#x27;s do some examples.</p><p>Suppose we have a procedure which looks something like this:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_recursive_query (tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      to_exclude_ || &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude (id) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_recursive_query (tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      to_include_ || &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include (id) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With shared fragments you could write something like this:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC split_commas(str text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH splitter(tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT &#x27;&#x27;, IFNULL(str || &#x27;,&#x27;, &#x27;&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM splitter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  select tok from splitter where tok &lt;&gt; &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC ids_from_string(str text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH toks(tok) AS (CALL split_commas(str))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT CAST(tok AS LONG) AS id from toks;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We now have a shared fragment called <code>split_commas</code> which can be anywhere like maybe in a standard include file.  There are some immediate benefits:</p><ul><li>the fragment is compiled on its own before usage so any errors are reported in the fragment<ul><li>in contrast, with macros you get errors when you try to use the macro and they are all charged to the line the macro appears on so it&#x27;s hopeless figuring out what&#x27;s wrong</li></ul></li><li>the text of the shared fragment will be the same, so it can be re-used in all locations, this can be a big binary size savings<ul><li>in contrast, macros are pre-processed before CQL ever sees the text so it doesn&#x27;t &quot;know&quot; it&#x27;s the same code</li></ul></li><li>fragments compose cleanly as we&#x27;ll see; and they have typed arguments</li><li>fragments can be independently tested outside of the context in which they appear<ul><li>make a test context and explore the fragment, no worries about it breaking on edge cases later</li></ul></li></ul><p>The first fragment called <code>split_commas</code> does exactly what it sounds like, it takes a string argument and makes a list of the strings in it.</p><p>The second fragment uses the first to split a string and then it converts all the strings to long integers.</p><p>Now instead of the above we could write:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stringsplit.sql&gt; /* whereever you put the fragments */</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And of course since <code>ids_from_string</code> is somewhere shared (<code>stringsplit.sql</code>) so these fragments can be used
all over your code and you&#x27;ll only pay for the text one time.  This gives you great flexibility, very much
like parameterized views. You can have any number of these fragments, they will share code, they compose like crazy
and there is no schema cost!</p><h3 class="anchor anchorWithStickyNavbar_mojV" id="generics">Generics<a class="hash-link" href="#generics" title="Direct link to heading">â€‹</a></h3><p>A series of useful fragments for generating data would go a long way but there are other applications
of fragments and you might want to operate on various data sources without hard coding them all.  This is
where the generic form of fragments comes in. Consider a case where you want to be able to filter <code>stuff</code>
by say name and age.  You could create this fragment:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.name LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now imagine that we had added the shared fragment annotation to <code>get_stuff</code> (just like the above).
We could then write the following:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    get_stuff(*) AS (call get_stuff(to_include_, to_exclude_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    filter_stuff(*) AS (call filter_stuff(pattern_, min_age_, max_age_)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      using get_stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or with some sugar to forward arguments and assume the CTE name matches, more economically:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call get_stuff(*)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using get_stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The arg syntax <code>(*)</code> simply indicates that the arg names in the caller should match to the same names in the callee.  In
general <code>call foo(*)</code> expands to <code>call foo(from arguments like foo arguments)</code>.  <code>*</code> is rather more economical than that.</p><p>In this example <code>filter_stuff</code> doesn&#x27;t know where its data will be coming from, you bind its table parameter <code>source</code>
to a compatible data source of your choice. For example, this would also be legal:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC almost_the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="conditionals">Conditionals<a class="hash-link" href="#conditionals" title="Direct link to heading">â€‹</a></h3><p>It&#x27;s often desirable to have some options in the generated SQL without having to fork your entire query.  Shared
fragments address this as well with the conditional form.  In this form the top level of the fragment is an
<code>IF</code> statement and there are a number of alternatives.  Here are some simple modifications to the above that illustrate
some of the possibilities.</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.name LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above if the input pattern is NULL then it is not considered, it won&#x27;t be part of the generated SQL at all. Note that
<code>source</code> (same name) appears in both branches and therefore must be the same type as it will be fulfilled by one actual table
parameter.</p><p>Now the above could have been achieved with something like this:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pattern_ IS NULL OR S.name LIKE pattern_</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But that would have no useful selectivity.  But in general you might be able to avoid joins and so forth
with your constraints.  Consider something like this hypothetical:</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT DISTINCT S.* from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    INNER JOIN keywords K</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        K.keyword LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we save the DISTINCT and the JOIN if there is no pattern which might be important.  Of course
there are probably better ways to match keywords but this is just an illustration of what&#x27;s possible.</p><p>There are numerous ways this flexibility can be used, again a simple example, a real schema
transform would be more complex.</p><div class="language-SQL codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-SQL codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  schema_v2 bool not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF schema_v2 THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff_2 S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_mojV" id="validation">Validation<a class="hash-link" href="#validation" title="Direct link to heading">â€‹</a></h3><p>All of this requires a bunch of checking, at least this:</p><ul><li>the LIKE forms can only appear in a shared fragment</li><li>the CALL forms must refer to shared fragments</li><li>the CALL args must be compatible</li><li>the number and type of the provided tables in USING must be correct</li><li>the shared fragment must be a single select statement or an IF statement with an ELSE<ul><li>the statement lists of the IF/ELSE combo must all be single select statements</li><li>all the choices in the IF block must return the same shape (this is normal for procedures)</li></ul></li><li>the shared fragment can&#x27;t have any out arguments</li><li>the provided fragment arguments cannot themselves use the nested SELECT construct</li></ul><p>I think this is a total game changer for SQL authoring and should go a long way to making it easier to get your work done
on SQLite. A good base set of shared fragments as part any suite of procedures seems like a good idea.</p><p>There are more details in the section on shared fragments in <a href="https://cgsql.dev/cql-guide/ch14" target="_blank" rel="noopener noreferrer">Chapter 14</a> of The Guide.</p><p>These features are in the current build as of today (12/14/2021).</p><p>Happy Holidays and stay safe.</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_h6_j"><div class="col"><b>Tags:</b><ul class="tags_XVD_ padding--none margin-left--sm"><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/facebook">facebook</a></li><li class="tag_JSN8"><a class="tag_hD8n tagRegular_D6E_" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2021-12-14-shared-fragments.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_dcUD" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/blog/flow-analysis"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Control Flow Analysis in CQL</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/blog/result-variable"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Introducing @RC builtin variable</div></a></nav></main><div class="col col--2"><div class="tableOfContents_cNA8 thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#generics" class="table-of-contents__link toc-highlight">Generics</a></li><li><a href="#conditionals" class="table-of-contents__link toc-highlight">Conditionals</a></li><li><a href="#validation" class="table-of-contents__link toc-highlight">Validation</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_gHmE"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.4aa826ed.js"></script>
<script src="/assets/js/main.79429da8.js"></script>
</body>
</html>