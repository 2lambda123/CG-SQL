<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Introducing Shared Fragments | CG/SQL</title><meta data-react-helmet="true" property="og:title" content="Introducing Shared Fragments | CG/SQL"><meta data-react-helmet="true" name="description" content="Shared fragments are a real game-changer for CQL."><meta data-react-helmet="true" property="og:description" content="Shared fragments are a real game-changer for CQL."><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link rel="stylesheet" href="/styles.4959ceee.css">
<link rel="preload" href="/styles.dc8dd41c.js" as="script">
<link rel="preload" href="/runtime~main.8b98bfde.js" as="script">
<link rel="preload" href="/main.da0bdede.js" as="script">
<link rel="preload" href="/1.5511d707.js" as="script">
<link rel="preload" href="/2.226af8d9.js" as="script">
<link rel="preload" href="/3.44e6f513.js" as="script">
<link rel="preload" href="/ccc49370.92287297.js" as="script">
<link rel="preload" href="/a91ba28f.e876eee0.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><div class="col col--8 col--offset-2"><article><header><h1 class="margin-bottom--sm blogPostTitle_1mse">Introducing Shared Fragments</h1><div class="margin-vert--md"><time datetime="2021-12-14T00:00:00.000Z" class="blogPostDate_3bQP">December 14, 2021  Â· 8 min read</time></div><div class="avatar margin-vert--md"><a class="avatar__photo-link avatar__photo" href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener"><img src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noreferrer noopener">CG/SQL Team</a></h4><small class="avatar__subtitle">Maintainer of CG/SQL</small></div></div></header><section class="markdown"><p>Shared fragments are a real game-changer for CQL.</p><p>Remember, these are designed to let you write part of a query and then substitute in parameters.  So it&#x27;s like a parameterized view in normal SQL terms.  But actually it&#x27;s more powerful than that, fragments also provide features that are more like Java generics.  Let&#x27;s do some examples.</p><p>Suppose we have a procedure which looks something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_recursive_query (tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_exclude_ || &#x27;,&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude (id) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_recursive_query (tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      to_include_ || &#x27;,&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include (id) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>With shared fragments you could write something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC split_commas(str text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH splitter(tok, rest) AS (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT &#x27;&#x27;, IFNULL(str || &#x27;,&#x27;, &#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM splitter</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  select tok from splitter where tok &lt;&gt; &#x27;&#x27;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC ids_from_string(str text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH toks(tok) AS (CALL split_commas(str))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT CAST(tok AS LONG) AS id from toks;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>We now have a shared fragment called <code>split_commas</code> which can be anywhere like maybe in a standard include file.  There are some immediate benefits:</p><ul><li>the fragment is compiled on its own before usage so any errors are reported in the fragment<ul><li>in contrast, with macros you get errors when you try to use the macro and they are all charged to the line the macro appears on so it&#x27;s hopeless figuring out what&#x27;s wrong</li></ul></li><li>the text of the shared fragment will be the same, so it can be re-used in all locations, this can be a big binary size savings<ul><li>in contrast, macros are pre-processed before CQL ever sees the text so it doesn&#x27;t &quot;know&quot; it&#x27;s the same code</li></ul></li><li>fragments compose cleanly as we&#x27;ll see; and they have typed arguments</li><li>fragments can be independently tested outside of the context in which they appear<ul><li>make a test context and explore the fragment, no worries about it breaking on edge cases later</li></ul></li></ul><p>The first fragment called <code>split_commas</code> does exactly what it sounds like, it takes a string argument and makes a list of the strings in it.</p><p>The second fragment uses the first to split a string and then it converts all the strings to long integers.</p><p>Now instead of the above we could write:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stringsplit.sql&gt; /* whereever you put the fragments */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>And of course since <code>ids_from_string</code> is somewhere shared (<code>stringsplit.sql</code>) so these fragments can be used
all over your code and you&#x27;ll only pay for the text one time.  This gives you great flexibility, very much
like parameterized views. You can have any number of these fragments, they will share code, they compose like crazy
and there is no schema cost!</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="generics"></a>Generics<a aria-hidden="true" tabindex="-1" class="hash-link" href="#generics" title="Direct link to heading">#</a></h3><p>A series of useful fragments for generating data would go a long way but there are other applications
of fragments and you might want to operate on various data sources without hard coding them all.  This is
where the generic form of fragments comes in. Consider a case where you want to be able to filter <code>stuff</code>
by say name and age.  You could create this fragment:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.name LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Now imagine that we had added the shared fragment annotation to <code>get_stuff</code> (just like the above).
We could then write the following:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    get_stuff(*) AS (call get_stuff(to_include_, to_exclude_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    filter_stuff(*) AS (call filter_stuff(pattern_, min_age_, max_age_)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      using get_stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Or with some sugar to forward arguments and assume the CTE name matches, more economically:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call get_stuff(*)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using get_stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>The arg syntax <code>(*)</code> simply indicates that the arg names in the caller should match to the same names in the callee.  In
general <code>call foo(*)</code> expands to <code>call foo(from arguments like foo arguments)</code>.  <code>*</code> is rather more economical than that.</p><p>In this example <code>filter_stuff</code> doesn&#x27;t know where its data will be coming from, you bind its table parameter <code>source</code>
to a compatible data source of your choice. For example, this would also be legal:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC almost_the_right_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using stuff as source)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="conditionals"></a>Conditionals<a aria-hidden="true" tabindex="-1" class="hash-link" href="#conditionals" title="Direct link to heading">#</a></h3><p>It&#x27;s often desirable to have some options in the generated SQL without having to fork your entire query.  Shared
fragments address this as well with the conditional form.  In this form the top level of the fragment is an
<code>IF</code> statement and there are a number of alternatives.  Here are some simple modifications to the above that illustrate
some of the possibilities.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.name LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>In the above if the input pattern is NULL then it is not considered, it won&#x27;t be part of the generated SQL at all. Note that
<code>source</code> (same name) appears in both branches and therefore must be the same type as it will be fulfilled by one actual table
parameter.</p><p>Now the above could have been achieved with something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">pattern_ IS NULL OR S.name LIKE pattern_</span></div></div></div></div></div><p>But that would have no useful selectivity.  But in general you might be able to avoid joins and so forth
with your constraints.  Consider something like this hypothetical:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT DISTINCT S.* from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    INNER JOIN keywords K</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        K.keyword LIKE pattern_ AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><p>Here we save the DISTINCT and the JOIN if there is no pattern which might be important.  Of course
there are probably better ways to match keywords but this is just an illustration of what&#x27;s possible.</p><p>There are numerous ways this flexibility can be used, again a simple example, a real schema
transform would be more complex.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-SQL codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  schema_v2 bool not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  IF schema_v2 THEN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff_2 S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff S</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   END IF;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="validation"></a>Validation<a aria-hidden="true" tabindex="-1" class="hash-link" href="#validation" title="Direct link to heading">#</a></h3><p>All of this requires a bunch of checking, at least this:</p><ul><li>the LIKE forms can only appear in a shared fragment</li><li>the CALL forms must refer to shared fragments</li><li>the CALL args must be compatible</li><li>the number and type of the provided tables in USING must be correct</li><li>the shared fragment must be a single select statement or an IF statement with an ELSE<ul><li>the statement lists of the IF/ELSE combo must all be single select statements</li><li>all the choices in the IF block must return the same shape (this is normal for procedures)</li></ul></li><li>the shared fragment can&#x27;t have any out arguments</li><li>the provided fragment arguments cannot themselves use the nested SELECT construct</li></ul><p>I think this is a total game changer for SQL authoring and should go a long way to making it easier to get your work done
on SQLite. A good base set of shared fragments as part any suite of procedures seems like a good idea.</p><p>There are more details in the section on shared fragments in <a href="https://cgsql.dev/cql-guide/ch14" target="_blank" rel="noopener noreferrer">Chapter 14</a> of The Guide.</p><p>These features are in the current build as of today (12/14/2021).</p><p>Happy Holidays and stay safe.</p></section><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/facebook">facebook</a><a class="margin-horiz--sm" href="/blog/tags/cg-sql">cg-sql</a></div></footer></article><div><a href="https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2021-12-14-shared-fragments.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/flow-analysis"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Control Flow Analysis in CQL</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/result-variable"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Introducing @RC builtin variable Â»</div></a></div></nav></div></div><div class="col col--2"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#generics" class="table-of-contents__link">Generics</a></li><li><a href="#conditionals" class="table-of-contents__link">Conditionals</a></li><li><a href="#validation" class="table-of-contents__link">Validation</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.dc8dd41c.js"></script>
<script src="/runtime~main.8b98bfde.js"></script>
<script src="/main.da0bdede.js"></script>
<script src="/1.5511d707.js"></script>
<script src="/2.226af8d9.js"></script>
<script src="/3.44e6f513.js"></script>
<script src="/ccc49370.92287297.js"></script>
<script src="/a91ba28f.e876eee0.js"></script>
</body>
</html>