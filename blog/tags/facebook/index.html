<!doctype html>
<html lang="en" dir="ltr" class="blog-wrapper blog-tags-post-list-page plugin-blog plugin-id-default">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CG/SQL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CG/SQL Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-49","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="CG/SQL" href="/opensearch.xml"><title data-rh="true">20 posts tagged with &quot;facebook&quot; | CG/SQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cgsql.dev/blog/tags/facebook"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" property="og:title" content="20 posts tagged with &quot;facebook&quot; | CG/SQL"><meta data-rh="true" name="docusaurus_tag" content="blog_tags_posts"><meta data-rh="true" name="docsearch:docusaurus_tag" content="blog_tags_posts"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cgsql.dev/blog/tags/facebook"><link data-rh="true" rel="alternate" href="https://cgsql.dev/blog/tags/facebook" hreflang="en"><link data-rh="true" rel="alternate" href="https://cgsql.dev/blog/tags/facebook" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1HF376U378-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.46cfcd93.css">
<link rel="preload" href="/assets/js/runtime~main.db58bdb1.js" as="script">
<link rel="preload" href="/assets/js/main.aefc5f50.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CG/SQL</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_re4s thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_pO2u margin-bottom--md">Recent posts</div><ul class="sidebarItemList_Yudw clean-list"><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/blob-storage">Introducing Blob Storage</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/from-general">Using the FROM construct in more places</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/expression-frags">Introducing Expression Fragments</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/columns-sugar">Using the LIKE form in the SELECT statement</a></li><li class="sidebarItem__DBe"><a class="sidebarItemLink_mo7H" href="/blog/flow-analysis">Control Flow Analysis in CQL</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><header class="margin-bottom--xl"><h1>20 posts tagged with &quot;facebook&quot;</h1><a href="/blog/tags">View All Tags</a></header><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/blob-storage">Introducing Blob Storage</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-03-17T00:00:00.000Z" itemprop="datePublished">March 17, 2022</time> Â· <!-- -->10 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction-and-context">Introduction and Context<a class="hash-link" href="#introduction-and-context" title="Direct link to heading">â€‹</a></h2><p>The general idea here is that you might want to store composite data in a single column in the database.  This is a common way to get more generic schema, the idea being that you can have one or more blob columns that store in tables a lot of data that doesn&#x27;t have to be indexed. You could store it in other ways, like a JSON blob or some such, but we&#x27;ll be using blobs as the basis for storage here -- hence
the name blob &quot;storage&quot;.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-define-one-of-these-blobs">How do I define one of these blobs?<a class="hash-link" href="#how-do-i-define-one-of-these-blobs" title="Direct link to heading">â€‹</a></h3><p>In SQL/CQL, the main way you define structures, especially those that you want to maintain, is with tables.  Hence we introduce this</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>blob_storage attribute</code> indicates that the thing we&#x27;re about to define here is not really going to be a materialized table.  As a result, you will not be
able to (e.g.) <code>DROP</code> the table or <code>SELECT</code> from it, and there will be no schema upgrade for it should you request one. However, the usual schema rules still
apply which help you to create compatible versions of this structure.  For instance, new columns can be added only at the end, and only if they are nullable.
Here we add <code>source</code> to the schema in a hypothetical &quot;version 6&quot;.  Note that schema versions move forward globally in the schema, not locally in one table; this implies there are versions 1-5 elsewhere, not shown.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  source </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@create</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">6</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Additionally, since the storage is not backed by SQL with SQL&#x27;s constraint system, default values and constraints are not allowed in a table marked
with <code>cql:blob_storage</code>; it&#x27;s just data. Similarly, triggers, views, and indices may not use the &quot;table&quot;.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="where-do-you-keep-your-blob-storage">Where do you keep your blob storage?<a class="hash-link" href="#where-do-you-keep-your-blob-storage" title="Direct link to heading">â€‹</a></h3><p>Naturally, blob storage goes in a blob field, but recall CQL has discriminated types so we could make something like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id long </span><span class="token keyword" style="font-style:italic">primary</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">key</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  news_info </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>From a SQL perspective <code>news_info</code> is just a blob.  That means if you want to do a <code>WHERE</code> clause or something like that on the info,
you&#x27;re out of luck.  Maybe you could write a user-defined function to crack the blob and so forth but really this isn&#x27;t the point.
If you&#x27;re using this feature then, by construction, you don&#x27;t need to index on this data.  It&#x27;s simply not suitable for use at all
if you need field-at-a-time access within SQL.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-make-one-of-these-blobs">How do I make one of these blobs?<a class="hash-link" href="#how-do-i-make-one-of-these-blobs" title="Direct link to heading">â€‹</a></h3><p>The natural place that CQL stores structures is in value cursors so the most natural thing to do is to provide a variation of the <code>SET</code>
statement that lets you load a blob from a cursor like so:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> make_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This declares a cursor, loads it from argument values, and converts it to a blob.  Of course all of the usual cursor building forms can be
used to power your blob creation, you just do one serialization at the end.  The above is assembling a blob from arguments but you could
equally make the blob from data.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">id_ long </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- use our columns sugar syntax for getting just news_info columns from</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a table with potentially lots of stuff (or an error if it&#x27;s missing columns)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> some_source_of_info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are <em>many</em> cursor fetch forms, including dummy data forms and other interesting bits of sugar.  You can fetch a cursor from arguments,
from other cursors, and even combinations.  We want all of that to work for blobs as well without adding tons of new syntax and code generation.
The obvious way to accomplish that is for cursors to be the source of blobs.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-do-i-unpack-one-of-these-blobs">How do I unpack one of these blobs?<a class="hash-link" href="#how-do-i-unpack-one-of-these-blobs" title="Direct link to heading">â€‹</a></h3><p>Again, the normal way that you work with records in CQL is by creating suitable cursors. These can be economically accessed on a field-by-field basis.
What we need is a way to easily recreate a cursor from the blob so we can read the data values. This gives rise to this form:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let b :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> news_info </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_ </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> nothing </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- note this can fail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- now use c.who, c.what, etc.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Data loaded in a cursor is very economical to access on a field-by-field basis, and, since the deserialization of the blob happens all at once, that is also economical.
Importantly, we cannot assume that the blob is well formed, it could be coming from anywhere.  For secure-code reasons we must assume it is hostile.  Hence the
decoding validates the shape, internal lengths, and so forth.</p><p>If we had instead started with something this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let b :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> news_info </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> info </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> id_ </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> nothing </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Then maybe we might like to write:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">if b.who == &#x27;U2&#x27;) then ... end if;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>However, this sort of thing would be very uneconomical. For one thing, the blob does not have fixed-offset fields: It is carrying all the serialized data for the string fields
and so forth.  Each &quot;dot&quot; operation would be costly and, furthermore, each &quot;dot&quot; operation could fail if the blob is badly formed.  Having to deal with a <code>b.who</code> that might fail
seems very bad indeed.</p><p>Once you have the cursor you can make new blobs with different combinations, slice the cursor fields using the <code>LIKE</code> operator, return the cursor with <code>OUT</code>, or <code>OUT UNION</code>,
or pass the blob fields as arguments to functions using the <code>FROM</code> forms. Cursors already are super flexible in terms of what you can do with their contents.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-is-the-representation-of-one-of-these-blobs">What is the representation of one of these blobs?<a class="hash-link" href="#what-is-the-representation-of-one-of-these-blobs" title="Direct link to heading">â€‹</a></h3><p>It&#x27;s important that we allow the blobs to evolve over time, so each blob has to be self-describing.  We also want to be able to throw an error if you use the wrong kind of blob when
loading a cursor, so the blob has to contain the following:</p><ul><li>the number of columns in the blob data type when it was stored</li><li>the type of each field is encoded as a single plain-text character<ul><li>the types are bool, int, long, (double) real, (string) text, blob;</li><li>we use &#x27;f&#x27; (flag) for bools, hence &quot;fildsb&quot;</li><li>these are encoded with one letter each, upper case meaning &#x27;not null&#x27; so the storage might be &quot;LFss&quot;</li><li>the buffer begins with a null terminated string that serve for both the count and the types</li></ul></li><li>Each nullable field may be present or null; 1 bit is used to store this fact.  The bits are in an array of bytes that comes immediately after the type info (which implicitly tells us its size)</li><li>Boolean values are likewise encoded as bits within the same array, so the total number of bits stored is nullables plus booleans (nullable booleans use 2 bits)</li><li>If you are reading a newer version of a record from an older piece of data that is missing a column then the column is assumed to be NULL</li><li>Any columns you add after the initial version (using @create) must be nullable; this is normal for adding columns to existing schema</li><li>Integers and longs are stored in varint format after zigzag encoding</li><li>Text is stored inline in null terminated strings (embedded nulls are not allowed in CQL text)</li><li>Nested blobs are stored inline, with a length prefix encoded like any other int</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="what-about-more-than-one-row-in-a-blob">What about more than one row in a blob?<a class="hash-link" href="#what-about-more-than-one-row-in-a-blob" title="Direct link to heading">â€‹</a></h3><p>Well, this is a bit more advanced but in principle this could be done as well.  To make it useful, we would want to make a new cursor type that can iterate over rows in a blob. The syntax leaves
room for this, something like so:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- the usual stuff</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This cursor would be another variation; it would keep its current index into the blob to read data out of it.  Such a blob would also have to include a count of rows as part of its storage.</p><p>However, that&#x27;s future looking. There is no such support at present.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">â€‹</a></h3><p>With a fairly modest amount of work, we now support structured storage natively and have pretty rich language constructs.  We carefully chose language constructs that lead to economical
serialization and deserialization patterns and a record format that is versioned well, without resorting to something super loose like JSON.</p><p>As with many other features, it&#x27;s possible to replace the (de)serialization with code of your choice by supplying your own runtime methods.  So for instance, thrift encoding is possible;
though it is more flexible than is strictly necessary for the few SQL data types, it might be convenient.</p><p>Storage types that are going to be persisted in the database or go over a wire-protocol should be managed like schema with the usual validation rules.  On the other hand,
formats that will be used only transiently in memory can be changed at whim from version to version.  As mentioned above, the design specifically considers cases where a new
client discovers and old-format blob (with fewer columns) and, the reverse, cases where an old client recieves a datagram from a new client with too many columns.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="appendix">Appendix<a class="hash-link" href="#appendix" title="Direct link to heading">â€‹</a></h4><p>A more complete example is included for reference.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:blob_storage</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  when_ long </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- timestamp of some kind</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a place where the blob appears in storage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> some_table</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  y </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  news_blob </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that creates the blob from loose args</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> make_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that cracks the blob</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> crack_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">data</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- a procedure that cracks the blob into loose args if needed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- the OUT statement was created specifically to allow you to avoid this sort mass OUT awfulness</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> crack_blob_to_vars</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">data</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">news_info</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> who </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> what </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> when_ long</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">data</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> who :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">who</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> what :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">what</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> when_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">when_</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this just defines a shape for the part we are keeping from the original structure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  x </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  y </span><span class="token keyword" style="font-style:italic">int</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this just defines a shape for the result we want</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- we&#x27;re never actually defining this procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> my_result_shape</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> select_and_crack</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">whatever_condition </span><span class="token keyword" style="font-style:italic">bool</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> c </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> some_table </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> whatever_condition</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">loop</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> c</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- crack the blob in c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> n </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> news_info</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> n </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">blob</span><span class="token plain"> c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">news_blob</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- assemble the result we want from the parts we have</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_result_shape</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> result </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> c </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> my_basic_columns</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- emit one row</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">union</span><span class="token plain"> result</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing Blob Storage" href="/blog/blob-storage"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/from-general">Using the FROM construct in more places</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-02-21T00:00:00.000Z" itemprop="datePublished">February 21, 2022</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>This new feature is a pretty simple generalization of the <code>FROM</code> construct as applied to expression lists.
Note this isn&#x27;t the same as using <code>FROM</code> the usual way in a <code>select</code> statement.   An example will clear
this right up.</p><p>Suppose you wanted to create a procedure that inserts a row into a table.  You could write this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> Shape_xy </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> insert_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Shape_xy </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we&#x27;re using <code>from</code> to introduce some shape of values.  It can appear in a lot of places.</p><p>Suppose now I want to insert two of those shapes. I could write this slightly more complicated procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> insert_two_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">xy1 </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> xy2 </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> xy1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> xy2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This also composes with cursors, so maybe you need to get two <code>xy</code> values from diverse
locations.  You can mix and match.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> write_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> somewhere T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> D </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> somewhere_else T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> C </span><span class="token operator" style="color:rgb(137, 221, 255)">and</span><span class="token plain"> D </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- strange combos for illustration only</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_two_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_two_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">5</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_two_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> insert_two_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">8</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So, as you can see, we can start from data in one or more cursors and we can turn that data,
plus other expressions, into arguments, composing them as we like. This gives you the ability
to call procedures and functions using shapes from a mixed set of sources.  None of this is new.</p><p>However, the other places where expression lists happen -- <code>fetch</code>, <code>update cursor</code>, and <code>insert</code> -- only
allowed you specify a single object as the input source such as <code>insert into Shape_xy from C</code>.</p><p>With a little work, this is trivially generalized so that all value lists can use the <code>from</code> construct.</p><p>Here&#x27;s a complete example showing all the new forms.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> Shape_xy </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">int</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> Shape_uv </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">u </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> v </span><span class="token keyword" style="font-style:italic">text</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> Shape_uvxy </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_uv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> ShapeTrix</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;1&#x27;</span><span class="token plain"> u</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;2&#x27;</span><span class="token plain"> v </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- This new form is equivalent to the old form:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">--    insert into Shape_xy from C(like Shape_xy)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- but the values(...) form generalizes, see below.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Shape_xy </span><span class="token keyword" style="font-style:italic">values</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> D </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> Shape_uv</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> R </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_uvxy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- This form works just like the function call case</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- that was previously supported (it uses the same code even).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- This form lets you load R from any combination of sources</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- as long as you make a suitable row.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> R </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- Same thing is supported in update cursor</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- the x, y come from C and the u,v come from D.x, D.y.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- Note that C.u and C.v would not even be type compatible.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">update</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> R </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- And in a select-values clause</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> S </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">with</span><span class="token plain"> cte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">l</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">n</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">values</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Shape_xy</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> cte</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> S</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Shape_uvxy </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> S</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see, you can choose a subset of the <code>from</code> shape using <code>like</code>.</p><p>These combinations let you flexibily assemble rows of data for
cursors, calls, and insertions, using any combination of data sources
you might want, without resorting to listing every column by hand.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Using the FROM construct in more places" href="/blog/from-general"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/expression-frags">Introducing Expression Fragments</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-02-19T00:00:00.000Z" itemprop="datePublished">February 19, 2022</time> Â· <!-- -->5 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Following on the heels of shared fragments, we&#x27;re introducing the same kind of thing
for shared fragments that are expressions rather than tables.  The syntax is as follows:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this isn&#x27;t very exciting because regular max would do the job</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:shared_fragment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> max_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above can be used in the context of a SQL statement like so:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> max_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">column1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> T1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">column2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> the_max </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo T1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The consequence of the above is that the body of <code>max_func</code> is inlined into the generated SQL.  However, like
the other shared fragments, this is done in such a way that the text can be shared between instances so
you only pay for the cost of the text<!-- -->*<!-- --> in your program one time, no matter how many time you use it.</p><p>*<!-- --> You still pay for the cost of a pointer to the text.</p><p>In particular, for the above, the compiler will generate the following SQL:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> T1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">column1 x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> column2 y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But each line will be its own string literal, so, more accurately, it will concatenate the following three strings:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token string" style="color:rgb(195, 232, 141)">&quot;select (&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">                                      </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// string1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token string" style="color:rgb(195, 232, 141)">&quot; select case when x &gt;= y then x else y end&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// string2</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token string" style="color:rgb(195, 232, 141)">&quot; from (select T1.column1 x, column2 y))&quot;</span><span class="token plain">        </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// string3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Importantly, <code>string2</code> is fixed for any given fragment.  The only thing that changes is <code>string3</code>, i.e., the arguments.
The C compiler, and then the linker, will unify the <code>string2</code> literal across all translation units so you only
pay for the cost of that text one time.  It also means that the text of the arguments appears exactly one time,
no matter how complex they are.  For these benefits, we pay the cost of the select wrapper on the arguments.  This
is cost is frequently negative.  Consider this following:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> max_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A direct expansion of the above would result in something like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above could be accomplished with a simple pre-processor macro, but the fragments code generates the following:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> T</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">max</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">m</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> U</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Expression fragments can nest, so you could write:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:shared_fragment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> max3_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> z </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> max_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> max_func</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> z</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Again, this particular example is a waste because regular <code>max</code> would already do the job.</p><p>To give another example, common mappings from one kind of code to another using case/when can be written
and shared this way:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this sort of thing happens all the time</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token variable" style="color:rgb(191, 199, 213)">@attribute</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql:shared_fragment</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> remap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">case</span><span class="token plain"> x</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1001</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1057</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">3</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2010</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">4</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2011</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">9999</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the following:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> remap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">c</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> remap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">d</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> remap</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">T3</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">e</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> E</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The text for <code>remap</code> will appear three times in the generated SQL query but only one time in your binary.</p><p>Restrictions:</p><ul><li>the function must consist of exactly one simple select statement<ul><li>no <code>FROM</code>, <code>WHERE</code>, <code>HAVING</code>, etc. -- the result is an expression</li></ul></li><li>the select list must have exactly one value<ul><li>Note: the expression can be a nested <code>SELECT</code> which could have all the usual <code>SELECT</code> elements</li></ul></li><li>the usual shared fragment rules apply, e.g. no out-parameters, exactly one statement, etc.</li></ul><p>FAQ:</p><p>Q: Why does the expression fragment have a <code>select</code> in it?</p><p>A: Expression fragments are only interesting in SQL contexts where normal procedure and function calls are not available.
The <code>select</code> keyword makes it clear to the author and the compiler that the expression will be evaluated by
SQLite and the rules for what is allowed to go in the expression are the SQLite rules.</p><p>Q: Why no <code>FROM</code> clause?</p><p>A: We&#x27;re trying to produce an expression, not a table-value with one column.  If you want a table-value with
one column, the original shared fragments solution already do exactly that.  This gives you a solution for
sharing code in, say, the <code>WHERE</code> clause or the select list.</p><p>Q: Isn&#x27;t this just the same as doing, say, <code>#define max_func(x,y) case when (x) &gt;= (y) then x else y end;</code>?</p><p>A: Macros can give you a ton of flexibility, but they have many problems:</p><ul><li>if the macro has an error, you see the error in the call site with really bad diagnostic info</li><li>the compiler doesn&#x27;t know that the sharing is going on so it won&#x27;t be able to share text between call sites</li><li>the arguments can be evaluated many times each which could be expensive, bloaty, or wrong</li><li>there is no type-checking of arguments to the macro so you may or may not get compilation errors after expansion</li><li>you have to deal with all the usual pre-processor hazards</li></ul><p>In general, macros <em>can</em> be used for meta-programming (as in C and C++), but that doesn&#x27;t mean it&#x27;s a good idea.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing Expression Fragments" href="/blog/expression-frags"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/columns-sugar">Using the LIKE form in the SELECT statement</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2022-02-03T00:00:00.000Z" itemprop="datePublished">February 3, 2022</time> Â· <!-- -->4 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>One of the signature features of the CQL language is the ability to use the &quot;LIKE&quot; form to
slice out columns that conform to a shape.  This notion appears in many places in the language.
For instance if I have a table <code>Foo</code>. I can make a cursor for that shape like so:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which says I want the columns of <code>C</code> to be like the columns of <code>Foo</code>.</p><p>If I have a cursor <code>D</code> that has the <code>Foo</code> columns but maybe more and maybe in a different order I can load <code>C</code>
as follows:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">fetch</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> D</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Which again saves me from having to list all the (potentially dozens) of Foo columns.  This construct is in many places:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> P</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Foo </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>even</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> P</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">f </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> b </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> Bar</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Foo </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> f</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">insert</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">into</span><span class="token plain"> Bar </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> b</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And other examples...  This is discussed more fully in
<a href="https://cgsql.dev/cql-guide/ch05#reshaping-data-cursor-like-forms" target="_blank" rel="noopener noreferrer">Chapter 5</a> of the Guide.</p><p>However, one of the few places that shapes are interesting but not supported was in the select list.
And so, just a couple of days ago, we added the <code>COLUMNS</code> construct to the language which allows for
a sugared syntax for extracting columns in bulk.  It&#x27;s kind of a generalization of the <code>select T.*</code>
pattern but with CQL-style slicing and type-checking.</p><p>These forms are supported:</p><ul><li>columns from a join table or tables</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- same as A.*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(A) from ...;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- same as A.*, B.*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(A, B) from ...;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>columns from a particular join table that match a shape</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- the columns of A that match the shape Foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(A like Foo) from ...;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- get the Foo shape from A and the Far shape from B</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(A like Foo, B like Bar) from ...;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>columns from any join table that match a shape</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">--- get the Foo shape from anywhere in the join</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(like Foo) from ...;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- get the Foo and Bar shapes, from anywhere in the join</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(like Foo, like Bar) from ...;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>specific columns</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- x and y columns plus the foo shape</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(T1.x, T2.y, like Foo) from ...;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>distinct columns from the above (not distinct values!)</li></ul><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- removes duplicate column names</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- e.g. there will be one copy of &#x27;pk&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(distinct A, B) from A join B using(pk);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- if both Foo and Bar have an (e.g.) &#x27;id&#x27; field you only get one copy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(distinct like Foo, like Bar) from ...;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- if a specific column is mentioned it is always included</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- but later clauses that are not a specific column will avoid it</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- if F or B has an x it won&#x27;t appear again, just T.x</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(distinct T.x, F like Foo, B like Bar) from F, B ..;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Of course this is all just sugar, so it all ends up being a column list with table
qualifications -- but the syntax is very powerful.  For instance, for narrowing a
wide table, or for fusing joins that share common keys</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- just the Foo columns</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(like Foo) from Superset_Of_Foo_From_Many_Joins_Even;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- only one copy of &#x27;pk&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select columns(distinct A,B,C) from</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  A join B using (pk) join C using (pk);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And of course you can define shapes however you like and then use them
to slice off column chucks of your choice.  There are many ways to build
up shapes from other shapes.  Probably the easiest is to declare procedures
that return the shape you want and never actual create them.  E.g.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare proc shape1() (x integer, y real, z text);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare proc shape2() (like shape1, u bool, v bool);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With this combination you can easily define common column shapes and slice them
out of complex queries without having to type the columns names over and over...</p><p>Note that the <code>COLUMNS(...)</code> form is not a general replacement for the select list.
For instance, general expressions are not allowed inside of <code>COLUMNS(...)</code> but,
where extraction of lots of columns is needed, or even re-ordering of colummns,
it&#x27;s a very good option indeed and it composes well with the other <code>select</code> features.</p><p>This was the last significant area where shapes are useful but totally absent.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Using the LIKE form in the SELECT statement" href="/blog/columns-sugar"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/flow-analysis">Control Flow Analysis in CQL</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-12-30T00:00:00.000Z" itemprop="datePublished">December 30, 2021</time> Â· <!-- -->12 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>One of the biggest changes to CQL in 2021 was the addition of control flow
analysis. Given an understanding of how execution can flow within a user&#x27;s
program, CQL can do things like infer when a nullable variable must contain a
nonnull value and improve its type appropriately, or issue an error when a
nonnull variable may be used before it has been initialized.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="improving-nullability">Improving Nullability<a class="hash-link" href="#improving-nullability" title="Direct link to heading">â€‹</a></h3><p>As of mid-2021, and with increasing sophistication throughout the remainder of
the year, CQL has been able to infer that a variable of a nullable type must not
be <code>NULL</code> within a portion of a user&#x27;s program:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> another_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t0 </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> t1 </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> some_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t0 </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> t1 </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> t0 </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t0` must be nonnull here if we made it this far</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> t1 </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t0` and `t1` are nonnull here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> another_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> t1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t0` is nonnull here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> another_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;default&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The ability of the CQL compiler to infer non-nullability greatly reduces the
need to use the functions <code>ifnull_crash</code> and <code>ifnull_throw</code> to coerce values to
a nonnull typeâ€”functions that, if they are ever used incorrectly, usually result
in programs misbehaving.</p><p>For a detailed description and many additional examples of what is possibleâ€”CQL
can handle much more than what is shown aboveâ€”see <a href="https://cgsql.dev/cql-guide/ch03#nullability-improvements" target="_blank" rel="noopener noreferrer">the user guide&#x27;s section on
nullability
improvements</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="enforcing-initialization-before-use">Enforcing Initialization Before Use<a class="hash-link" href="#enforcing-initialization-before-use" title="Direct link to heading">â€‹</a></h3><p>In CQL, it is possible to declare a variable of a nonnull type without giving it
a value. If the variable is of a non-reference type, it is assigned a default
value of <code>0</code>. If the variable is of a reference type (<code>BLOB</code>, <code>OBJECT</code>, or
<code>TEXT</code>), however, it is simply set to <code>NULL</code> despite the nonnull type as no
default value exists.</p><p>To help prevent accessing a reference variable of a nonnull type and getting
back <code>NULL</code>, CQL recently began enforcing that such variables are initialized
before use. The following code, therefore, now results in an error:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> requires_text_notnull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- error!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Using the same engine for control flow analysis that is behind nullability
improvements, CQL can improve a variable to be initialized:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> some_condition </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;some example text&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t` is initialized here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  THROW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t` must be initialized here if we made it this far</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> requires_text_notnull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- okay!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Thanks to CQL&#x27;s ability to understand the control flow of users&#x27; programs, the
above example works just fine.</p><p>CQL now also enforces that all procedures with <code>OUT</code> parameters of a nonnull
reference type properly initialize said parameters before they return:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> some_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> another_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t` is initialized here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> yet_another_proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t` is initialized here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- `t` must be initialized here because all possible</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- branches initialized it, so `some_proc` is okay!</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As with nullability improvements, understanding the nuances of what will be
considered initialized is easier if one has a sense for how control flow
analysis works in the compiler.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="understanding-control-flow-analysis-in-cql">Understanding Control Flow Analysis in CQL<a class="hash-link" href="#understanding-control-flow-analysis-in-cql" title="Direct link to heading">â€‹</a></h3><p>To develop an intuition for how control flow analysis works in CQL, let&#x27;s begin
by taking a look at the following example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> p2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> p0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> p2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    THROW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are a couple of things we must verify in order to ensure the code is
type-safe:</p><ul><li><p>With regard to the parameters of <code>p0</code>: Since <code>t</code> is an <code>OUT</code> parameter of type
<code>TEXT NOT NULL</code>, <code>p0</code> must always assign it a value before it returns. If it
does not, a caller of <code>p0</code> may end up with a variable of a <code>NOT NULL</code> type
that actually contains <code>NULL</code>.</p></li><li><p>With regard to the calling of <code>p2</code> in <code>p0</code>: Since <code>p2</code> requires a first
argument of type <code>INTEGER NOT NULL</code>, some sort of check must be performed to
ensure that <code>i</code> is not <code>NULL</code> before <code>p2(i)</code> is executed.</p></li></ul><p>If we carefully study <code>p0</code>, we can determine that both of the above conditions
are satisfied. Making this determination, however, is not exactly trivial, and
real-world code is often significantly more complicated than thisâ€”and it evolves
over time. For these reasons, having a compiler that can make such
determinations automatically is critical; most modern production compilers
perform these sorts of checks.</p><p>The easiest way to understand how CQL does its job is to take the above example
line-by-line. This is not exactly how CQL works under the hood, but it should
provide an intuitive sense of how control flow analysis works in the compiler:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> p0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Right away, CQL can see that <code>t</code> is declared both <code>OUT</code> and <code>TEXT NOT NULL</code> and
thus requires initialization before <code>p0</code> returns. CQL can, therefore, add a fact
about what it is analyzing to its previously null set of facts:</p><blockquote><ul><li><code>t</code> requires initialization.</li></ul></blockquote><p>We can then continue:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain">   </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here, the compiler notices that we&#x27;re at an <code>IF</code> statement. In CQL, <code>IF</code>
statements contain one or more <strong>branches</strong>, and the compiler considers every
<code>IF</code> to be the start of a <strong>branch group</strong>. The same line also indicates the
condition for the first branch: <code>i IS NULL</code>. CQL can update its set of facts:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:</li></ul></li></ul></blockquote><p>It then proceeds to the next line:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Another branch group and branch:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:<ul><li>In branch group:<ul><li>In branch when <code>b</code>:</li></ul></li></ul></li></ul></li></ul></blockquote><p>Continuing:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Since <code>p1</code> takes an <code>OUT</code> argument of type <code>TEXT NOT NULL</code>, this call
initializes <code>t</code>, and so CQL can update its set of facts once again:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:<ul><li>In branch group:<ul><li>In branch when <code>b</code>:<ul><li><code>t</code> is initialized.</li></ul></li></ul></li></ul></li></ul></li></ul></blockquote><p>Jumping ahead a couple of lines:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>At this point, we&#x27;re in another branch. We also have yet another fact to add
because <code>t</code> is initialized here as well due to the <code>SET</code>:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:<ul><li>In branch group:<ul><li>In branch when <code>b</code>:<ul><li><code>t</code> is initialized.</li></ul></li><li>In ELSE branch:<ul><li><code>t</code> is initialized.</li></ul></li></ul></li></ul></li></ul></li></ul></blockquote><p>Moving ahead one more line, things get a bit more interesting:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> b </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">CALL</span><span class="token plain"> p1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">t</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here, we&#x27;re at the end of an <code>IF</code>, and thus the end of a branch group. Whenever
CQL reaches the end of a branch group, it <em>merges</em> the effects of all of its
branches.</p><p>One very important thing to note here is that the current branch group has an
<code>ELSE</code> branch, and so the set of branches covers all possible cases. That means
if something is initialized in every branch within the branch group, we can
consider it to be initialized after the branch group has ended: Initialization
will always occur. This allows CQL to simplify its set of facts as follows as it
leaves the branch group:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:<ul><li><code>t</code> is initialized.</li></ul></li></ul></li></ul></blockquote><p>Stepping forward one line again, we reach a <code>RETURN</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">RETURN</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We&#x27;re now at a point where we can exit the procedure. CQL will, therefore,
verify that if something requires initialization, it has been initialized. Since
we have both the facts &quot;<code>t</code> requires initialization&quot; and &quot;<code>t</code> is initialized&quot;,
all is well!</p><p>The fact that the current branch returns early is added to the set of facts:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li>In branch group:<ul><li>In branch when <code>i IS NULL</code>:<ul><li><code>t</code> is initialized.</li><li>Returns.</li></ul></li></ul></li></ul></blockquote><p>Moving ahead one more line, we reach the end of another branch and branch group,
and again something interesting happens:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">IS</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Upon ending the branch group, we know that the branch group has exactly one
branch, that the branch is entered only when <code>i IS NULL</code>, and that the branch
returns. What that tells CQL is that, if execution is going to continue after
the branch group, its sole branch must <em>not</em> have been taken, and so CQL knows
the <em>opposite</em> of its condition for entry will be true from this point onward:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li><code>i</code> is not null.</li></ul></blockquote><p>The next <code>IF</code> is rather similar to what we&#x27;ve seen already in its structure, so
we can jump ahead several lines to the next point of interest:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> p2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        THROW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><em>Before</em> we analyze the above-indicated line, we have the following set of facts:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li><code>i</code> is not null.</li><li>In branch group:<ul><li>In branch when <code>i == 0</code>:<ul><li><code>t</code> is initialized.</li></ul></li><li>In branch when <code>i &gt; 0</code>:</li></ul></li></ul></blockquote><p>In the call <code>p2(i)</code>, we know that <code>i</code> was declared to have type <code>INTEGER</code> and
that <code>p2</code> requires an <code>INTEGER NOT NULL</code>, but we also have the fact &quot;<code>i</code> is not
null&quot;. For this reason, we can consider <code>p2(i)</code> to be a valid call. We can also
add the fact that <code>t</code> is initialized to our current set of facts:</p><blockquote><ul><li>...<ul><li>In branch when <code>i &gt; 0</code>:<ul><li><code>t</code> is initialized.</li></ul></li></ul></li></ul></blockquote><p><strong>NOTE:</strong> When it comes to code generation, it is not so simple as to say
<code>p2(i)</code> is valid and proceed as usual. That&#x27;s because <code>p2</code> expects an argument
of type <code>INTEGER NOT NULL</code>, but we merely have a value of type <code>INTEGER</code> <em>that
we happen to know</em> cannot be null: <code>INTEGER NOT NULL</code> and <code>INTEGER</code> do not share
the same underlying representation, and so we cannot pass the declared-nullable
variable <code>i</code> directly to <code>p2</code>. To solve this problem, CQL <em>rewrites the
expression</em> such that <code>p2(i)</code> becomes <code>p2(cql_inferred_notnull(i))</code>, where
<code>cql_inferred_notnull</code> is an internal-only function that handles the
nullable-to-nonnull representational conversion for us. This explains its
presence in the following examples.</p><p>Jumping ahead again, we encounter a <code>THROW</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> p2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql_inferred_notnull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> THROW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The fact that the branch will throw is added to the current set of facts:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li><code>i</code> is not null.</li><li>In branch group:<ul><li>In branch when <code>i == 0</code>:<ul><li><code>t</code> is initialized.</li></ul></li><li>In branch when <code>i &gt; 0</code>:<ul><li><code>t</code> is initialized.</li></ul></li><li>In ELSE branch:<ul><li>Throws.</li></ul></li></ul></li></ul></blockquote><p>We then proceed to the end of the <code>IF</code>:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> i </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">THEN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        </span><span class="token keyword" style="font-style:italic">SET</span><span class="token plain"> t :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> p2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql_inferred_notnull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">ELSE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        THROW</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">END</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">IF</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Once again, CQL merges the effects of the branches in the branch group to finish
the analysis of the <code>IF</code>. Since it can see that <code>t</code> was initialized in all
branches except the one that throws, and since the branches cover all possible
cases, the set of facts is simplified as follows given the knowledge that, if
<code>THROW</code> was not encountered, <code>t</code> must have been initialized:</p><blockquote><ul><li><code>t</code> requires initialization.</li><li><code>i</code> is not null.</li><li><code>t</code> is initialized.</li></ul></blockquote><p>Moving ahead one final time, we encounter the end of the procedure:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROC</span><span class="token plain"> p0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">b </span><span class="token keyword" style="font-style:italic">BOOL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> i </span><span class="token keyword" style="font-style:italic">INTEGER</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">OUT</span><span class="token plain"> t </span><span class="token keyword" style="font-style:italic">TEXT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">END</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The only thing left to do at this point is to validate that anything requiring
initialization has been initialized. Since we have both &quot;<code>t</code> requires
initialization&quot; and &quot;<code>t</code> is initialized&quot;, everything is in order.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="looking-ahead">Looking Ahead<a class="hash-link" href="#looking-ahead" title="Direct link to heading">â€‹</a></h3><p>As a recently generalized piece of functionality within the CQL compiler,
control flow analysis will soon be used to enforce additional properties of
users&#x27; programs. In particular, CQL will be able to ensure that cursors are
always fetched before they&#x27;re used and that cursors are always checked to have a
row before their fields are accessed.</p><p>Hopefully you now understand the fundamentals of control flow analysis in CQL
and the benefits it brings to your programs. Best wishes for 2022!</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Control Flow Analysis in CQL" href="/blog/flow-analysis"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/shared-fragments-intro">Introducing Shared Fragments</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-12-14T00:00:00.000Z" itemprop="datePublished">December 14, 2021</time> Â· <!-- -->8 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Shared fragments are a real game-changer for CQL.</p><p>Remember, these are designed to let you write part of a query and then substitute in parameters.  So it&#x27;s like a parameterized view in normal SQL terms.  But actually it&#x27;s more powerful than that, fragments also provide features that are more like Java generics.  Let&#x27;s do some examples.</p><p>Suppose we have a procedure which looks something like this:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_recursive_query (tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      to_exclude_ || &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude (id) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_exclude_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_recursive_query (tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      &#x27;&#x27;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      to_include_ || &#x27;,&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include (id) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT CAST(tok AS LONG)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM to_include_recursive_query</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE tok &lt;&gt; &#x27;&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  )</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With shared fragments you could write something like this:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC split_commas(str text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH splitter(tok, rest) AS (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT &#x27;&#x27;, IFNULL(str || &#x27;,&#x27;, &#x27;&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    UNION ALL</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, 1, instr(rest, &#x27;,&#x27;) - 1),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      substr(rest, instr(rest, &#x27;,&#x27;) + 1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    FROM splitter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE rest &lt;&gt; &#x27;&#x27;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  select tok from splitter where tok &lt;&gt; &#x27;&#x27;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC ids_from_string(str text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH toks(tok) AS (CALL split_commas(str))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT CAST(tok AS LONG) AS id from toks;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We now have a shared fragment called <code>split_commas</code> which can be anywhere like maybe in a standard include file.  There are some immediate benefits:</p><ul><li>the fragment is compiled on its own before usage so any errors are reported in the fragment<ul><li>in contrast, with macros you get errors when you try to use the macro and they are all charged to the line the macro appears on so it&#x27;s hopeless figuring out what&#x27;s wrong</li></ul></li><li>the text of the shared fragment will be the same, so it can be re-used in all locations, this can be a big binary size savings<ul><li>in contrast, macros are pre-processed before CQL ever sees the text so it doesn&#x27;t &quot;know&quot; it&#x27;s the same code</li></ul></li><li>fragments compose cleanly as we&#x27;ll see; and they have typed arguments</li><li>fragments can be independently tested outside of the context in which they appear<ul><li>make a test context and explore the fragment, no worries about it breaking on edge cases later</li></ul></li></ul><p>The first fragment called <code>split_commas</code> does exactly what it sounds like, it takes a string argument and makes a list of the strings in it.</p><p>The second fragment uses the first to split a string and then it converts all the strings to long integers.</p><p>Now instead of the above we could write:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stringsplit.sql&gt; /* whereever you put the fragments */</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(to_include_ text, to_exclude_ text)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And of course since <code>ids_from_string</code> is somewhere shared (<code>stringsplit.sql</code>) so these fragments can be used
all over your code and you&#x27;ll only pay for the text one time.  This gives you great flexibility, very much
like parameterized views. You can have any number of these fragments, they will share code, they compose like crazy
and there is no schema cost!</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="generics">Generics<a class="hash-link" href="#generics" title="Direct link to heading">â€‹</a></h3><p>A series of useful fragments for generating data would go a long way but there are other applications
of fragments and you might want to operate on various data sources without hard coding them all.  This is
where the generic form of fragments comes in. Consider a case where you want to be able to filter <code>stuff</code>
by say name and age.  You could create this fragment:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.name LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now imagine that we had added the shared fragment annotation to <code>get_stuff</code> (just like the above).
We could then write the following:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    get_stuff(*) AS (call get_stuff(to_include_, to_exclude_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    filter_stuff(*) AS (call filter_stuff(pattern_, min_age_, max_age_)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      using get_stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Or with some sugar to forward arguments and assume the CTE name matches, more economically:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call get_stuff(*)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using get_stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The arg syntax <code>(*)</code> simply indicates that the arg names in the caller should match to the same names in the callee.  In
general <code>call foo(*)</code> expands to <code>call foo(from arguments like foo arguments)</code>.  <code>*</code> is rather more economical than that.</p><p>In this example <code>filter_stuff</code> doesn&#x27;t know where its data will be coming from, you bind its table parameter <code>source</code>
to a compatible data source of your choice. For example, this would also be legal:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC almost_the_right_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    (call filter_stuff(*) using stuff as source)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  SELECT * from filter_stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ORDER BY name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  LIMIT 5;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="conditionals">Conditionals<a class="hash-link" href="#conditionals" title="Direct link to heading">â€‹</a></h3><p>It&#x27;s often desirable to have some options in the generated SQL without having to fork your entire query.  Shared
fragments address this as well with the conditional form.  In this form the top level of the fragment is an
<code>IF</code> statement and there are a number of alternatives.  Here are some simple modifications to the above that illustrate
some of the possibilities.</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.name LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In the above if the input pattern is NULL then it is not considered, it won&#x27;t be part of the generated SQL at all. Note that
<code>source</code> (same name) appears in both branches and therefore must be the same type as it will be fulfilled by one actual table
parameter.</p><p>Now the above could have been achieved with something like this:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">pattern_ IS NULL OR S.name LIKE pattern_</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>But that would have no useful selectivity.  But in general you might be able to avoid joins and so forth
with your constraints.  Consider something like this hypothetical:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC filter_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  pattern_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  min_age_ integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  max_age_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF pattern_ IS NOT NULL THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT DISTINCT S.* from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    INNER JOIN keywords K</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        K.keyword LIKE pattern_ AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        source(*) LIKE stuff</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from source S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.age BETWEEN min_age_ and max_age_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Here we save the DISTINCT and the JOIN if there is no pattern which might be important.  Of course
there are probably better ways to match keywords but this is just an illustration of what&#x27;s possible.</p><p>There are numerous ways this flexibility can be used, again a simple example, a real schema
transform would be more complex.</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">@attribute(cql:shared_fragment)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE PROC get_stuff(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_include_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  to_exclude_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  schema_v2 bool not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  IF schema_v2 THEN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff_2 S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  ELSE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WITH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_include(id) AS (CALL ids_from_string(to_include_)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        to_exclude(id) AS (CALL ids_from_string(to_exclude_))</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    SELECT * from stuff S</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    WHERE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id in (select * from to_include) AND</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        S.id not in (select * from to_exclude);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   END IF;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="validation">Validation<a class="hash-link" href="#validation" title="Direct link to heading">â€‹</a></h3><p>All of this requires a bunch of checking, at least this:</p><ul><li>the LIKE forms can only appear in a shared fragment</li><li>the CALL forms must refer to shared fragments</li><li>the CALL args must be compatible</li><li>the number and type of the provided tables in USING must be correct</li><li>the shared fragment must be a single select statement or an IF statement with an ELSE<ul><li>the statement lists of the IF/ELSE combo must all be single select statements</li><li>all the choices in the IF block must return the same shape (this is normal for procedures)</li></ul></li><li>the shared fragment can&#x27;t have any out arguments</li><li>the provided fragment arguments cannot themselves use the nested SELECT construct</li></ul><p>I think this is a total game changer for SQL authoring and should go a long way to making it easier to get your work done
on SQLite. A good base set of shared fragments as part any suite of procedures seems like a good idea.</p><p>There are more details in the section on shared fragments in <a href="https://cgsql.dev/cql-guide/ch14" target="_blank" rel="noopener noreferrer">Chapter 14</a> of The Guide.</p><p>These features are in the current build as of today (12/14/2021).</p><p>Happy Holidays and stay safe.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing Shared Fragments" href="/blog/shared-fragments-intro"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/result-variable">Introducing @RC builtin variable</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-02-21T00:00:00.000Z" itemprop="datePublished">February 21, 2021</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>We&#x27;ve long needed a way to see the most recent SQLite result code SQLite in the context
of say a <code>catch</code> block (most other times you can assume SQLITE_OK was the last
result code otherwise control flow would transfer elsewhere. Sometimes SQLITE_ROW
or SQLITE_DONE might be the current result code.</p><p>Soon we&#x27;ll provide a sample header that declares the most common error codes in an enum but
for now you could do something like this:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- pasted from the sqlite.c</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">#define SQLITE_BUSY         5   /* The database file is locked */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this is a contrived example</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> get_first_foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> can_retry </span><span class="token keyword" style="font-style:italic">bool</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- can_retry is set to 0 automatically, language semantics guarantee this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> try</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> bar </span><span class="token keyword" style="font-style:italic">limit</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> catch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> can_retry :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token variable" style="color:rgb(191, 199, 213)">@rc</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> SQLITE_BUSY</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- rethrow the original error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> catch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing @RC builtin variable" href="/blog/result-variable"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/select-if-nothing">Introducing Select .. If Nothing</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-02-14T00:00:00.000Z" itemprop="datePublished">February 14, 2021</time> Â· <!-- -->2 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>The nested select statement is frequently misused, in particular if you get no rows back from the expression that&#x27;s an error.  So for instance:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This will throw (with a peculiar error, <code>SQLITE_DONE</code>) if there is no such row.</p><p>Sometimes people try to fix this problem with a nullcheck:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>That doesn&#x27;t help at all.  It&#x27;s not a null value situation, there&#x27;s no row at all.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Is likewise unhelpful.  To help with this situation we add two forms:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- useful if foo.x is already known to be not null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- useful if foo.x might be null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> x </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">OR</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">NULL</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Both of these deal with the case where there is no row.  The second lets you have a simple default for both
no row or null value.  That form is equivalent to:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> x_ :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> IFNULL</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> id </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> y </span><span class="token keyword" style="font-style:italic">IF</span><span class="token plain"> NOTHING </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>i.e. both problem cases are handled.</p><p>Of course the -1 here could be any valid expression, even a second <code>(select...)</code></p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing Select .. If Nothing" href="/blog/select-if-nothing"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/free-empty-results">Change in No-Result Semantics</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-02-10T00:00:00.000Z" itemprop="datePublished">February 10, 2021</time> Â· <!-- -->One min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Important change in CQL semantics.</p><p>Previously if you did an early return, or fall through the end, from a procedure that is supposed to return a result set
but did not in fact provide one, you would get a fake SQLITE_ERROR.  Now you get an empty result set for &quot;free&quot;.</p><p>This interpretation seems much more natural and avoids a lot of really annoying stub selects to comply with the contract.</p><p>This also works for the <code>out</code> statement in the same fashion.</p><p>If you want to return an error, use <code>throw</code>. This is a lot more natural...</p><p>examples:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- this gives you an empty result set if x &lt;= 0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- so does this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token keyword" style="font-style:italic">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> foo </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">y </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"> x</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- so does this</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> maybe_out</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">x </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> x </span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">declare</span><span class="token plain"> C </span><span class="token keyword" style="font-style:italic">cursor</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> etc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> C</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Change in No-Result Semantics" href="/blog/free-empty-results"><b>Read More</b></a></div></footer></article><article class="margin-bottom--xl" itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h2 class="blogPostTitle_Ikge" itemprop="headline"><a itemprop="url" href="/blog/type-kinds-intro">Introducing Type &quot;Kinds&quot;</a></h2><div class="blogPostData_SAv4 margin-vert--md"><time datetime="2021-01-20T00:00:00.000Z" itemprop="datePublished">January 20, 2021</time> Â· <!-- -->3 min read</div><div class="margin-top--md margin-bottom--sm row"><div class="col col--6 authorCol_sTYa"><div class="avatar margin-bottom--sm"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" class="avatar__photo-link"><img class="avatar__photo" src="https://avatars2.githubusercontent.com/u/69631?s=200&amp;v=4" alt="CG/SQL Team"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/facebookincubator" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">CG/SQL Team</span></a></div><small class="avatar__subtitle" itemprop="description">Maintainer of CG/SQL</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>Further adding to the type calculus of the CQL language we introduced the ability to encode the &quot;kind&quot; of primitive types.  This
can be used in a number of ways -- like &quot;units&quot; for natural things and like a &quot;type&quot; for synthetic keys and other such.  It&#x27;s easier
to illustrate by example.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare job_id type long&lt;job_id&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare person_id type long&lt;person_id&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare j job_id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">decalre p person_id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set p := j;  -- this is an error</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>With the above in place, other expressions like  <code>p == j</code> would also produce errors as these <code>long</code> values are no longer type compatible.  This is
a great way to add enforcement to your schema and procedures.  Likewise you can use these annotations to add &quot;units&quot; to your data types.  e.g.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare meters type real&lt;meters&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare grams type real&lt;grams&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare m meters;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare g grams;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Variables of type <code>grams</code> (e.g. <code>g</code>) are not compatible with variables of type <code>meters</code> (e.g. <code>m</code>) even though both are <code>real</code>.</p><p>Likewise, attemping to insert <code>grams</code> into a column that is typed to <code>meters</code> will give errors.  Of course SQLite doesn&#x27;t know about any of this
so all the <code>&lt;&gt;</code> stuff is removed in the generated SQL.  This is just about type enforcement at compile time.</p><p>Enumerations like:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum surface integer (paper, canvas);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum writer integer (pen, paper, brush);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>enable this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare s surface;                  -- s is now of type integer&lt;surface&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare w writer;                   -- w is now of type integer&lt;writer&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set s := surface.paper;             -- ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set s := writer.pen;                -- error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set w := writer.pencil;             -- ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case when s == w then 1 else 0 end; -- error (w/s not comparable)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set w := s;                         -- error again</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>additionally in DML/DDL:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">create table draw_action(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  w writer,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  s surface</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into draw_action values(w, s); -- ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into draw_action values(s, w); -- error!</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>So the type kinds can be quite helpful when dealing with loose variables.</p><p>The notion of specific types was added to the language nearly two years ago to support the <code>object</code> type because there was a great desire
to prevent <code>object&lt;dictionary&gt;</code> being assigned from <code>object&lt;list&gt;</code> but this &quot;type kind&quot;, whether it&#x27;s with units (e.g. &quot;meters&quot;, &quot;grams&quot;)
or a type name (e.g. &quot;job_id&quot;) adds a lot of high value type checking.</p><p>The kind can be added, stripped, or changed with a <code>cast</code> operation and the type system allows a constant or variable with no kind (e.g. &quot;1&quot;)
to mix and match with any kind so long as the base type is compatible as usual.  So you get the most value by using the specific type
consistently but you won&#x27;t go insane adding test cases that use constants for instance.</p><p>As of this writing the expression kinds are checked for compatibility everywhere plus or minus bugs.  There are extensive tests.</p></div><footer class="row docusaurus-mt-lg"><div class="col col--9"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/facebook">facebook</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/blog/tags/cg-sql">cg-sql</a></li></ul></div><div class="col text--right col--3"><a aria-label="Read more about Introducing Type &quot;Kinds&quot;" href="/blog/type-kinds-intro"><b>Read More</b></a></div></footer></article><nav class="pagination-nav" aria-label="Blog list page navigation"><a class="pagination-nav__link pagination-nav__link--next" href="/blog/tags/facebook/page/2"><div class="pagination-nav__label">Older Entries</div></a></nav></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.db58bdb1.js"></script>
<script src="/assets/js/main.aefc5f50.js"></script>
</body>
</html>