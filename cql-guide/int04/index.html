<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-cql-guide docs-doc-id-int04">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CG/SQL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CG/SQL Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-49","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="CG/SQL" href="/opensearch.xml"><title data-rh="true">Part 4: Testing | CG/SQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cgsql.dev/cql-guide/int04"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" property="og:title" content="Part 4: Testing | CG/SQL"><meta data-rh="true" name="description" content="&lt;!---"><meta data-rh="true" property="og:description" content="&lt;!---"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cgsql.dev/cql-guide/int04"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/int04" hreflang="en"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/int04" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1HF376U378-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.46cfcd93.css">
<link rel="preload" href="/assets/js/runtime~main.254dc0fd.js" as="script">
<link rel="preload" href="/assets/js/main.aefc5f50.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CG/SQL</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/ch01">CQL Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/x1">Appendix</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cql-guide/int01">CQL Internals</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int01">Part 1: Lexing, Parsing, and the AST</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int02">Part 2: Semantic Analysis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int03">Part 3: C Code Generation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cql-guide/int04">Part 4: Testing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int05">Part 5: CQL Runtime</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int06">Part 6: Schema Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int07">Part 7: JSON Generation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int08">Part 8: Test Helpers</a></li></ul></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CQL Internals</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Part 4: Testing</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Part 4: Testing</h1></header><h3 class="anchor anchorWithStickyNavbar_LWe7" id="preface">Preface<a class="hash-link" href="#preface" title="Direct link to heading">â€‹</a></h3><p>Part 4 continues with a discussion of the essentials testing frameworks for the CQL compiler.
As in the previous sections, the goal here is not to go over every detail but rather to give
a sense of how testing happens in general -- the core strategies and implementation choices --
so that when reading the tests you will have an idea how it all hangs together. To accomplish
this, various key tools will be explained in detail as well as selected examples of their use.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="testing">Testing<a class="hash-link" href="#testing" title="Direct link to heading">â€‹</a></h2><p>There are several types of tests in the system, all of which are launched by the <code>test.sh</code>
script which builds the compiler and does a full test pass, there are well over 3000 tests
as of this writing.  Broadly these are in these few categories:</p><ul><li><p><strong>parse tests</strong> : these are in <code>test.sql</code></p><ul><li>the test script verifies that the compiler can parse this file with no errors</li><li>the parse pass echoes what it read in normalized form, this is compared against a reference copy and any differences are noted</li><li>each difference can be accepted or rejected; rejecting a difference stops the script</li><li>verification here is very light and in fact much of parsing is actually tested in the next pass</li></ul></li><li><p><strong>semantic tests</strong> : these are in <code>sem_test.sql</code></p><ul><li>the file has no parse errors but it has MANY semantic errors, nearly every such error in fact</li><li>semantic analysis is run with the <code>--test</code> flag which produces AST fragments and echoed CQL</li><li>the test file includes patterns which either must appear, or must not appear, in the output to pass the test</li><li>the AST includes full type information, so virtually anything about the semantic results can be, and is, verified</li><li>many tests are designed to exercise the parser as well, ensuring that the correct AST was built and then analyzed<ul><li>e.g. operator precedence can be verified here</li><li>the AST echoing logic can also be verified here, e.g. placement of parenthesis in the echoed output</li></ul></li><li>any semantic rewrites can be verified here because the rewritten form is emitted in the test output, not the original input</li><li>all other operations that happen during the semantic pass (e.g. constant evaluation) are also tested here</li><li>the full semantic output is also normalized (e.g. removing line numbers) and is compared against a reference copy, any differences are noted</li><li>each difference can be accepted or rejected; rejecting a difference stops the script</li><li>there are additional files to test different modes like &quot;previous schema&quot; validation (q.v.) as well as dev mode and the schema migrator, the files in this family are: <code>sem_test.sql</code>, <code>sem_test_dev.sql</code>, <code>sem_test_migrate.sql</code>, <code>sem_test_prev.sql</code></li></ul></li><li><p><strong>code gen tests</strong> : the basic test in this family is <code>cg_test.sql</code> which has the C codegen tests</p><ul><li>these test files do pattern matching just like the semantic case except the codegen output is checked rather than the AST</li><li>the test output is normalized and checked against a reference, just like the semantic tests</li><li>there is generally no need to check for errors in test output because all errors are detected during semantic analysis</li><li>there are MANY tests in this family, at least one for each of the various generators:<ul><li><code>cg_test.sql</code>, <code>cg_test_assembly_query.sql</code>, <code>cg_test_base_fragment.sql</code>, <code>cg_test_base_java_fragment.sql</code>, <code>cg_test_c_type_getters.sql</code>, <code>cg_test_extension_fragment.sql</code>, <code>cg_test_extension_java_fragment.sql</code>, <code>cg_test_generate_copy.sql</code>, <code>cg_test_generated_from.sql</code>, <code>cg_test_json_schema.sql</code>, <code>cg_test_no_result_set.sql</code>, <code>cg_test_out_object.sql</code>, <code>cg_test_out_union.sql</code>, <code>cg_test_prev_invalid.sql</code>, <code>cg_test_query_plan.sql</code>, <code>cg_test_schema_upgrade.sql</code>, <code>cg_test_single_proc_not_nullable.sql</code>, <code>cg_test_single_proc_nullable.sql</code>, <code>cg_test_suppressed.sql</code>, <code>cg_test_test_helpers.sql</code>, <code>cg_test_with_object.sql</code>,</li></ul></li></ul></li><li><p><strong>run tests</strong> : the main run test creatively named <code>run_test.sql</code></p><ul><li>this test code is compiled and excuted</li><li>the test contains expectations like any other unit test</li><li>it has CQL parts and C parts, the C parts test the C API to the procedures, plus do initial setup</li><li>these test include uses of all CQL features and all of the CQL runtime features</li><li>the schema upgrader tests are arguably &quot;run tests&quot; as well in that they run the code but they have a much different verification strategy</li></ul></li><li><p><strong>unit test</strong> : the compiler supports the <code>--run_unit_tests</code> flag</p><ul><li>this causes the compile to self-test certain of its helper functions that are otherwise difficult to test</li><li>mostly this is buffers that need to be growable to but in practice only grow with huge input files</li><li>other exotic cases that would be hard to reliability hit in some other fashion are covered by this code</li></ul></li></ul><p>Test coverage is maintained at 100% line coverage (sometimes there are a few
hours when it drops to 99.9% or something like that but this never lasts).
Branch coverage is not especially targetted but is nonethless quite high. To
see the true branch coverage you have to build the compiler with the asserts
(Contract and Invariant) off.  Last time it was measured, it was well over 80%.</p><p>To start the tests you should run <code>test.sh</code>, this launches <code>common/test_common.sh</code> to do the work.
This structure allows anyone to make their own harness that launches the common test passes and adds
their own extra tests, or passes in additional flags.  <code>test.sh</code> itself uses <code>make</code> to
build the compiler.</p><p>As mentioned above, <code>test.sh</code> normally allows the user to accept or reject differences in output, but
this is automatically disabled in non-terminal environments, and manually disabled if the script is
run with <code>--non_interactive</code>. <code>ok.sh</code> can be run to copy all of the outputs from the most recent test
run over the previous references.</p><p>To get the coverage report, use <code>cov.sh</code> which in turn launches <code>test.sh</code> with suitable flags
and then assembles the coverage report using <code>gcovr</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="parse-tests">Parse Tests<a class="hash-link" href="#parse-tests" title="Direct link to heading">â€‹</a></h3><p>Looking at <code>test/test_common.sh</code> we find the source for the most basic test.  This is entirely
unremarkable stuff.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function-name function" style="color:rgb(130, 170, 255)">basic_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;--------------------------------- STAGE 2 -- BASIC PARSING TEST&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> running </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/test.sql&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${CQL}</span><span class="token plain"> --dev --in </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/test.sql&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/test.out&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> basic parsing </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">test</span><span class="token plain"> failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;  computing diffs (empty if none)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  on_diff_exit test.out</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li>it&#x27;s &quot;STAGE 2&quot; because &quot;STAGE 1&quot; was the build</li><li>all it tries to do is run the compiler over <code>test/test.sql</code></li><li>if there are errors the test fails</li><li>if there are any differences between <code>test.out</code> and <code>test.out.ref</code> the test fails</li></ul><p>That&#x27;s it.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="sematic-tests">Sematic Tests<a class="hash-link" href="#sematic-tests" title="Direct link to heading">â€‹</a></h3><p>The semantic tests are not much different but this is where the pattern matching comes in.</p><p>First let&#x27;s look at the shell script:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function-name function" style="color:rgb(130, 170, 255)">semantic_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;--------------------------------- STAGE 4 -- SEMANTIC ANALYSIS TEST&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> running semantic analysis </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> sem_check --sem --ast --dev --in </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.sql&quot;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.out&quot;</span><span class="token plain"> </span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">2</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.err&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;CQL semantic analysis returned unexpected error code&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.err&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> validating output trees</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cql-verify&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.sql&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/sem_test.out&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> failed verification</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> running dev semantic analysis </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">. same thing again </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> sem_test_dev.sql</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;  computing diffs (empty if none)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  on_diff_exit sem_test.out</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  on_diff_exit sem_test.err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">. same thing again </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> sem_test_dev.out and .err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There are basically 3 steps:</p><ul><li>run the compiler over <code>test/sem_test.sql</code><ul><li>fail if this generates no errors (yes you read that right, see below)</li></ul></li><li>do the pattern matching on the output using <code>cql-verify</code> to ensure the patterns match (discussed below)<ul><li>fail if the output is not consistent with the patterns</li></ul></li><li>compare the reference output for the AST and the errors<ul><li>fail if there are any differences</li></ul></li></ul><p>In the first step the compiler MUST produce an error code, let&#x27;s look at <code>sem_check</code> to see why:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function-name function" style="color:rgb(130, 170, 255)">sem_check</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token variable" style="color:rgb(191, 199, 213)">${CQL}</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$@</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">$?</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token plain"> -ne </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;1&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;All semantic analysis checks have errors in the test&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;the normal return code is &quot;1&quot; -- any other return code is bad news&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;A return code of zero indicates we reported success in the face of errors&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;A return code other than 1 indicates an unexpected fatal error of some type&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">return</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In short <code>sem_test.sql</code> is FULL of semantic errors, that&#x27;s part of the test.  If the compiler
reports success something is <em>seriously</em> wrong.</p><p>In the next phase we&#x27;re going to do some pattern matching, let&#x27;s look at a couple of examples
to illustrate how this works.  The program <code>cql-verify</code> actually does all this matching and
that program is itself written in (mostly) CQL which is cute.
It can be found in the <code>tester</code> directory.</p><p>Here&#x27;s a very simple example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- TEST: we&#x27;ll be using printf in lots of places in the tests as an external proc</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + {declare_proc_no_check_stmt}: ok</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- - Error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">DECLARE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">PROCEDURE</span><span class="token plain"> printf </span><span class="token keyword" style="font-style:italic">NO</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">CHECK</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The code under test is of course <code>DECLARE PROCEDURE printf NO CHECK</code>.  The patterns happen
immediately before this code.  Let&#x27;s look at each line:</p><ul><li><code>-- TEST: etc.</code> : this is just a comment, it means nothing and serves no purpose other than documentation</li><li><code>-- + {declare_proc_no_check_stmt}: ok</code> : the comment stats with <code>&quot; + &quot;</code>, this is a trigger<ul><li>the test output from the statement under test must include indicated text</li><li>this happens to be the text for the AST of <code>declare_proc_no_check_stmt</code> after semantic success</li><li>there is no type info hence the <code>ok</code> designation (recall <code>SEM_TYPE_OK</code>)</li></ul></li><li><code>-- Error</code> : the comment starts with <code>&quot; - &quot;</code>, this is a trigger<ul><li>the test output from the statement under test must NOT include indicated text</li><li>in this case that means no reported erros</li></ul></li></ul><p>Easy enough.  Now does this happen?</p><p>The test output includes:</p><ul><li>text like &quot;The statement ending at line XXXX&quot; where XXXX is appropriate line number</li><li>an echo of the statement that was analyzed (after any rewrites)</li><li>the AST of that statement including semantic type info that was computed</li></ul><p>Using the value of XXXX the tester searches the test file in this case <code>sem_test.sql</code>, it
extracts the test patterns that happen AFTER the previous XXXX value for the previous statement
and up to the indicated line number.  This is The Price Is Right algorithm where you
read up to the designated lines without going over.</p><p>Each pattern is matched, or not matched, using the SQL <code>LIKE</code> or <code>NOT LIKE</code> operator.  In case
of errors the tester writes out the actual output and the expected patterns having all this information
handy.</p><p>The line numbers are all changed to literally &quot;XXXX&quot; after this pass so that the difference in
later passes is not a cascade of of trivial line number changes in otherwise identical output.</p><p>Let&#x27;s look at another example:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- TEST: create a table using type discrimation: kinds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + {create_table_stmt}: with_kind: { id: integer&lt;some_key&gt;, cost: real&lt;dollars&gt;, value: real&lt;dollars&gt; }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + {col_def}: id: integer&lt;some_key&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + {col_def}: cost: real&lt;dollars&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + {col_def}: value: real&lt;dollars&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- - Error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> with_kind</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">some_key</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  cost </span><span class="token keyword" style="font-style:italic">real</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">dollars</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">value</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">real</span><span class="token operator" style="color:rgb(137, 221, 255)">&lt;</span><span class="token plain">dollars</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This reads pretty easily now:</p><ul><li><code>{create_table_stmt}</code> : the struct type of the table must be an exact match for what is expected</li><li><code>{col_def}</code> : there are 3 different <code>{col_def}</code> nodes, one for each column</li><li><code>- Error</code> : there are no reported errors</li></ul><p>So there are no errors reported nor are there any in the AST.  At least the part of the AST that was
checked.  The AST actually had other stuff too but it&#x27;s normal to just test the &quot;essential&quot; stuff.
There are many tests that try many variations and we don&#x27;t want to check every fact in every case
of every test.</p><p>If you want to see the whole AST output for this, it&#x27;s easy enough.  It&#x27;s sitting in <code>sem_test.out.ref</code></p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">The statement ending at line XXXX</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE with_kind(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id INTEGER&lt;some_key&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  cost REAL&lt;dollars&gt;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  value REAL&lt;dollars&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  {create_table_stmt}: with_kind: { id: integer&lt;some_key&gt;, cost: real&lt;dollars&gt;, value: real&lt;dollars&gt; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | {create_table_name_flags}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | | {table_flags_attrs}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | | | {int 0}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | | {name with_kind}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  | {col_key_list}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    | {col_def}: id: integer&lt;some_key&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    | | {col_def_type_attrs}: ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    |   | {col_def_name_type}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    |     | {name id}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    |     | {type_int}: integer&lt;some_key&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    |       | {name some_key}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    | {col_key_list}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      | {col_def}: cost: real&lt;dollars&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      | | {col_def_type_attrs}: ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      |   | {col_def_name_type}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      |     | {name cost}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      |     | {type_real}: real&lt;dollars&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      |       | {name dollars}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      | {col_key_list}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">        | {col_def}: value: real&lt;dollars&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          | {col_def_type_attrs}: ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">            | {col_def_name_type}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              | {name value}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">              | {type_real}: real&lt;dollars&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">                | {name dollars}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As you can see there was potentially a lot more than could have been verified but those view key lines were
selected because their correctness really implies the rest.  In fact just the <code>{create_table_stmt}</code> line
really was enough to know that everthing was fine.</p><p>Let&#x27;s look at one more example, this time on that is checking for errors.  Many tests check for
errors because correctly reporting errors is the primary job of <code>sem.c</code>.  It&#x27;s fair to say that
there are more tests for error cases than there are for correct cases because there are a lot
more ways to write code incorrectly than correctly.  Here&#x27;s the test:</p><div class="language-SQL codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-SQL codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- TEST: join with bogus ON expression type</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- + Error % expected numeric expression &#x27;ON&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- +1 Error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- + {select_stmt}: err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- + {on}: err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select * from foo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">inner join bar as T2 on &#x27;v&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">where &#x27;w&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">having &#x27;x&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">limit &#x27;y&#x27;;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ul><li><code>+ Error % expected numeric expression &#x27;ON&#x27;</code> : there must be a reported Error message with the indicated error text</li><li><code>+1 Error</code> : this indicates that there must be <em>exactly</em> 1 match for the pattern &quot;Error&quot; (i.e. exactly one error)<ul><li>note that there are several problems with the test statement but error processing is supposed to stop after the first</li></ul></li><li><code>-- + {on}: err</code> : verifies that the ON clause was marked as being in error</li><li><code>-- + {select_stmt}: err</code> : verifies that the error correctly propogated up to the top level statement</li></ul><p>Note that the patterns can be in any order and every pattern is matched against the whole input so for instance:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- + {on}: err</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- + {on}: err</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above does not imply that there are two such <code>{on}</code> nodes.  The second line will match the same text as the first.
To to enforce that there were exactly two matches you use:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- +2 {on}: err</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is no syntax for &quot;at least two matches&quot; though one could easily be added.  So far it hasn&#x27;t been especially
necessary.</p><p>As we&#x27;ll see this simple pattern is used in many other tests.  All that is required for it work is output with
lines of the form &quot;The statement ending at line XXXX&quot;</p><p>The <code>sem_test_dev.sql</code> test file is a set of tests that are run with the <code>--dev</code> flag passed to CQL.  This
is the mode where certain statements that are prohibited in production code are verified.  This file is
very small indeed and the exact prohibitions are left as an exercise to the reader.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="code-generation-tests">Code Generation Tests<a class="hash-link" href="#code-generation-tests" title="Direct link to heading">â€‹</a></h3><p>The test logic for the &quot;codegen&quot; family of tests (<code>cg_test*.sql</code>) is virtually identical to the semantic
test family. The same testing utililty is used, and it works the same way, looking for the same marker.
The only difference in this stage is that the test output is generated code, not an AST. The codegen tests
are a great way to lock down important code fragments in the output.  Note that the codegen tests do not actually
execute any generated code.  That&#x27;s the next category.</p><p>Here&#x27;s an sample test:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- TEST: unused temp in unary not emitted</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- - cql_int32 _tmp_int_0 = 0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- - cql_int32 _tmp_int_1 = 0;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + o = i.value;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- + o = - 1;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> unused_temp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">out</span><span class="token plain"> o </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">set</span><span class="token plain"> o :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">coalesce</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This test is verifying one of the optimizations that we talked about in
<a href="https://cgsql.dev/cql-guide/int03#result-variables" target="_blank" rel="noopener noreferrer">Part 3</a>.
In many cases temporary variables for results (such as function calls) can be elided.</p><ul><li><code>- cql_int32 _tmp_int_0 = 0;</code> : verifies that this temporary is NOT created</li><li><code>- cql_int32 _tmp_int_1 = 0;</code> : likewise</li><li><code>+ o = i.value;</code> : the first alternative in coalesce directly assigns to <code>o</code></li><li><code>+ o = - 1;</code> : as does the second</li></ul><p>It might be helpful to look at the full output, which as always is in a <code>.ref</code> file.
In this case <code>cg_test.c.ref</code>.  Here is the full output with the line number
normalized:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// The statement ending at line XXXX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">/*</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">CREATE PROC unused_temp (i INTEGER, OUT o INTEGER NOT NULL)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">BEGIN</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">  SET o := coalesce(i, -1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">END;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name">_PROC_</span><span class="token macro property"> </span><span class="token macro property string" style="color:rgb(195, 232, 141)">&quot;unused_temp&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// export: DECLARE PROC unused_temp (i INTEGER, OUT o INTEGER NOT NULL);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(130, 170, 255)">unused_temp</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">cql_nullable_int32 i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> cql_int32 </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">_Nonnull o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">cql_contract_argument_notnull</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token keyword" style="font-style:italic">void</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain">o</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">2</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">o </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">// set out arg to non-garbage</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">do</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain">i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">is_null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">o </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> i</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain">value</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">break</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">*</span><span class="token plain">o </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">-</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">1</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">while</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">undef</span><span class="token macro property"> </span><span class="token macro property expression">_PROC_</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As we can see, the test has picked out the bits that it wanted to verify. The <code>coalesce</code>
function is verified elsewhere -- in this test we&#x27;re making sure that this pattern doesn&#x27;t cause
extra temporaries.</p><p>Let&#x27;s take a quick look at the part of <code>test_common.sh</code> that runs this:</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function-name function" style="color:rgb(130, 170, 255)">code_gen_c_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;--------------------------------- STAGE 5 -- C CODE GEN TEST&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> running codegen </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">test</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${CQL}</span><span class="token plain"> --test --cg </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_c.h&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_c.c&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_exports.out&quot;</span><span class="token plain"> --in </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test.sql&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    --global_proc cql_startup --generate_exports </span><span class="token operator file-descriptor important" style="color:rgb(137, 221, 255)">2</span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_c.err&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ERROR:&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token function" style="color:rgb(130, 170, 255)">cat</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_c.err&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> validating codegen</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cql-verify&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test.sql&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/cg_test_c.c&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ERROR: failed verification&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> testing </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> successful compilation of generated C</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token function" style="color:rgb(130, 170, 255)">rm</span><span class="token plain"> -f out/cg_test_c.o</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> do_make out/cg_test_c.o</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ERROR: failed to compile the C code from the code gen test&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;  computing diffs (empty if none)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  on_diff_exit cg_test_c.c</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  on_diff_exit cg_test_c.h</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">. other tests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Briefly reviewing this, we see the following important steps:</p><ul><li><code>{CQL} --test --cg etc.</code> : run the compiler on the test input<ul><li>the test fails if there are any errors</li></ul></li><li><code>cql-verify</code> : performs the pattern matching<ul><li>the output has the same statement markers as in the semantic case</li></ul></li><li><code>do_make</code> : use <code>make</code> to build the generated code ensuring it compiles cleanly<ul><li>if the C compiler returns any failure, the test fails</li></ul></li><li><code>on_diff_exit</code> : compares the test output to the reference output<ul><li>any difference fails the test</li></ul></li></ul><p>This is all remarkably similar to the semantic tests. All the code generators
are tested in the same way.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="run-tests">Run Tests<a class="hash-link" href="#run-tests" title="Direct link to heading">â€‹</a></h3><p>The last category of tests actually does execution.  The main &quot;run test&quot; happens
at &quot;stage 13&quot;, because there are <em>many</em> codegen tests for the various
output formats and these all pass before before we try to execute anything.
This is not so bad because the tests are quite quick with a full test pass taking
less than 90s on my laptop.</p><div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token function-name function" style="color:rgb(130, 170, 255)">run_test</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;--------------------------------- STAGE 13 -- RUN CODE TEST&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> running codegen </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">test</span><span class="token plain"> with execution</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> cc -E -x c -w </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${TEST_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/run_test.sql&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token operator" style="color:rgb(137, 221, 255)">&gt;</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/run_test_cpp.out&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> preprocessing failed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">elif</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">${CQL}</span><span class="token plain"> --nolines </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    --cg </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/run_test.h&quot;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/run_test.c&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    --in </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/run_test_cpp.out&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    --global_proc cql_startup --rt c</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> codegen failed.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">elif</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">echo </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;  compiling code&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> do_make run_test </span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> build failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">elif</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">!</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">echo </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;  executing tests&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&quot;./</span><span class="token string variable" style="color:rgb(191, 199, 213)">${OUT_DIR}</span><span class="token string" style="color:rgb(195, 232, 141)">/a.out&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token builtin class-name" style="color:rgb(255, 203, 107)">echo</span><span class="token plain"> tests failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    failed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">fi</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">..</span><span class="token plain">.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The main structure is mostly what one would expect:</p><ul><li><code>cc -E -x c</code> : this is used to pre-process the run test file so that we can use C pre-processor features to define tests<ul><li>there are quite a few helpful macros as we&#x27;ll see</li><li>if pre-processing fails, the test fails</li></ul></li><li><code>{CQL} --nolines --cg ...</code> : this is used to create the <code>.h</code> and <code>.c</code> file for the compiland<ul><li><code>--nolines</code> is used to suppress the <code>#</code> directives that would associate the generated code with the .sql file</li><li>compilation failures cause the test to fail</li></ul></li><li><code>do_make</code> : as before this causes <code>make</code> to build the compiland (<code>run_test</code>)<ul><li>this build target includes the necessary bootstrap code to open a database and start the tests</li><li>any failures cause the test to fail</li></ul></li><li><code>a.out</code> : the tests execute<ul><li>the tests return a failure status code if anything goes wrong</li><li>any failure causes the test to fail</li></ul></li></ul><p>The test file <code>run_test.sql</code> includes test macros from <code>cqltest.h</code> -- all of these are very
simple.  The main ones are <code>BEGIN_SUITE</code>, <code>END_SUITE</code>, <code>BEGIN_TEST</code> and <code>END_TEST</code> for
structure; and <code>EXPECT</code> to verify a boolean expression.</p><p>Here&#x27;s a simple test case with several expectations:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">BEGIN_TEST(arithmetic)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO((1 + 2) * 3 == 9);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(1 + 2 * 3 == 7);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(6 / 3 == 2);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(7 - 5 == 2);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(6 % 5 == 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(5 / 2.5 == 2);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(-(1+3) == -4);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(-1+3 == 2);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(1+-3 == -2);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(longs.neg == -1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(-longs.neg == 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  EXPECT_SQL_TOO(- -longs.neg == -1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">END_TEST(arithmetic)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We should also reveal <code>EXPECT_SQL_TOO</code>, discussed below:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token operator" style="color:rgb(137, 221, 255)">--</span><span class="token plain"> use this </span><span class="token keyword" style="font-style:italic">for</span><span class="token plain"> both normal eval and SQLite eval</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="font-style:italic">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(130, 170, 255)">EXPECT_SQL_TOO</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">x</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(130, 170, 255)">EXPECT</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">x</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(130, 170, 255)">EXPECT</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token macro property expression">select x</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token macro property expression punctuation" style="color:rgb(199, 146, 234)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now back to the test:</p><ul><li><code>EXPECT(x)</code> : verifies that <code>x</code> is true (i.e. a non-zero numeric)<ul><li>not used directly in this example</li></ul></li><li><code>EXPECT_SQL_TOO</code> : as the definition shows,<ul><li><code>x</code> must be true (as above)</li><li><code>(select x)</code> must also be true,<ul><li>i.e. when SQLite is asked to evaluate the expression the result is also a &quot;pass&quot;</li></ul></li><li>this is used to verify consistency of order of operations and other evaluations that must be the same in both forms</li><li>note that when <code>(select ...)</code> is used, CQL plays no part in evaluating the expression, the text of the expression goes to SQLite and any variables are bound as described in Part 3.</li></ul></li></ul><p>The run test exercises many features, but the testing strategy is always the same:</p><ul><li>exercise some code pattern</li><li>use <code>EXPECT</code> to validate the results are correct</li><li>the expressions in the <code>EXPECT</code> are usually crafted carefully to show that a certain mistake is not being made<ul><li>e.g. expressions where the result would be different if there are bugs in order of operations</li><li>e.g. expressions that would crash with divide by zero if code that isn&#x27;t supposed to run actually ran</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="schema-upgrade-testing">Schema Upgrade Testing<a class="hash-link" href="#schema-upgrade-testing" title="Direct link to heading">â€‹</a></h3><p>The schema upgrade tester is quite a bit different than the others and relies heavily on execution
of the upgraders.  Before we get into that there is a preliminary topic:</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="previous-schema-validation">&quot;Previous Schema&quot; Validation<a class="hash-link" href="#previous-schema-validation" title="Direct link to heading">â€‹</a></h4><p>In order to ensure that it is possible to create an upgrader, CQL provides features to validate
the current schema against the previous schema ensuring that nothing has been done that would
make an upgrader impossible. This is more fully discussed in
<a href="https://cgsql.dev/cql-guide/ch11" target="_blank" rel="noopener noreferrer">Chapter 11</a> of the Guide.</p><p>&quot;Previous Schema&quot; validation is a form of semantic check and so its testing happens as
described above. Importantly, as with the other back-end passes the schema upgrader does
not have to concern itself with error cases as they are already ruled out.  The upgrader
itself will be the subject of Part 5.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="packing-list">Packing List<a class="hash-link" href="#packing-list" title="Direct link to heading">â€‹</a></h4><p>The test assets for upgrade tests are found in the <code>upgrade</code> directory and consist of</p><ul><li><code>SchemaPersistentV0.sql</code> : baseline version of the test schema</li><li><code>SchemaPersistentV1.sql</code> : v1 of the test schema</li><li><code>SchemaPersistentV2.sql</code> : v2 of the test schema</li><li><code>SchemaPersistentV3.sql</code> : v3 of the test schema</li><li><code>downgrade_test.c</code> : a test that simulates attemping to go backwards in schema versions</li><li><code>upgrade_test.c</code> : the C harness that launches the upgraders and fires the tests</li><li><code>upgrade_test.sh</code> : the shell script that makes all this happen</li><li><code>upgrade_validate.sql</code> : some simple code that sanity checks the recorded schema version against tables in it<ul><li>used to ensure that the schema we are on is the schema we think we are on, not to validate all facets of it</li><li>also renders the contents of <code>sqlite_master</code> in a canonical form</li></ul></li></ul><p>We haven&#x27;t yet discussed the internals of schema upgrade, so for purposes of this part we&#x27;re only going
to discuss how the testing proceeds.  The upgrade will be considered &quot;magic&quot; for now.</p><p>In addition to these assets, we also have reference files:</p><ul><li><code>upgrade_schema_v0.out.ref</code> : expected content of v0</li><li><code>upgrade_schema_v1.out.ref</code> : expected content of v1</li><li><code>upgrade_schema_v2.out.ref</code> : expected content of v2</li><li><code>upgrade_schema_v3.out.ref</code> : expected content of v3</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade_validatesql"><code>upgrade_validate.sql</code><a class="hash-link" href="#upgrade_validatesql" title="Direct link to heading">â€‹</a></h4><p>This file has a single procedure <code>validate_transition</code> which does the two jobs:</p><ul><li>emits the canonicalized version of <code>sqlite_master</code> to the output<ul><li>this is needed because <code>sqlite_master</code> text can vary between Sqlite versions</li></ul></li><li>checks for basic things that should be present in a given version</li></ul><p>The output of the validator looks like this:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">reference results for version 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">----- g1 -----</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type: table</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tbl_name: g1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE g1(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id INTEGER PRIMARY KEY,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name TEXT)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">----- sqlite_autoindex_test_cql_schema_facets_1 -----</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type: index</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tbl_name: test_cql_schema_facets</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">----- test_cql_schema_facets -----</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">type: table</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">tbl_name: test_cql_schema_facets</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE TABLE test_cql_schema_facets(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  facet TEXT NOT NULL PRIMARY KEY,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  version LONG_INT NOT NULL)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The formatting rules are very simple and so the output is pretty readable.</p><p>The verifications are very simple.</p><p>First this happens:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">let version :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> cast</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">test_cql_get_facet_version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;cql_schema_version&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">integer</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The printing happens, then this simple validation:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  let recreate_sql :</span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">select</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">sql</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">from</span><span class="token plain"> sqlite_master</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">where</span><span class="token plain"> name </span><span class="token operator" style="color:rgb(137, 221, 255)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;test_this_table_will_become_create&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> nothing </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> switch version</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">when</span><span class="token plain"> </span><span class="token number" style="color:rgb(247, 140, 108)">0</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">if</span><span class="token plain"> recreate_sql </span><span class="token operator" style="color:rgb(137, 221, 255)">is</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">or</span><span class="token plain"> recreate_sql </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">like</span><span class="token plain"> </span><span class="token string" style="color:rgb(195, 232, 141)">&#x27;%xyzzy INTEGER%&#x27;</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">then</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ERROR! test_this_table_will_become_create should have a column named xyzzy in v%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">if</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token punctuation" style="color:rgb(199, 146, 234)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">call</span><span class="token plain"> printf</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token string" style="color:rgb(195, 232, 141)">&quot;ERROR! expected schema version v%d\n&quot;</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"> version</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>In short, the version number must be one of the valid versions and each version is expecting
that particular table to be in some condition it can recognize.</p><p>The real validation is done by noting any changes in the reference output plus a series of invariants.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="prosecution-of-the-upgrade-test">Prosecution of the Upgrade Test<a class="hash-link" href="#prosecution-of-the-upgrade-test" title="Direct link to heading">â€‹</a></h4><p><strong> Launch </strong></p><p>We kick things off as follows:</p><ul><li><code>test.sh</code> calls <code>upgrade/upgrade_test.sh</code><ul><li>this test doesn&#x27;t usually run standalone (but it can)</li></ul></li></ul><p><strong> Build Stage </strong></p><p>This creates the various binaries we will need:</p><ul><li><code>upgrade_validate.sql</code> is compiled down to C<ul><li>this code works for all schema versions, it&#x27;s generic</li></ul></li><li><code>SchemaPersistentV[0-3].sql</code> are compiled into C (this takes two steps)<ul><li>first, the CQL upgrader is generated from the schema</li><li>second, the CQL upgrader is compiled to C</li></ul></li><li><code>make</code> is used to lower all of the C into executables <code>upgrade[0-3]</code> plus <code>downgrade_test</code><ul><li>the shared validation code is linked into all 4 upgraders</li><li><code>downgrade_test.c</code> is linked with the code for <code>upgrade1</code></li></ul></li></ul><p><strong> Basic Upgrades </strong></p><p>Here we test going from scratch to each of the 4 target versions:</p><ul><li><code>upgrade[0-3]</code> are each run in turn with no initial database<ul><li>i.e. their target database is deleted before each run</li></ul></li><li>the validation output is compared against the reference output<ul><li>any differences fail the test</li></ul></li></ul><p><strong> Previous Schema Validation </strong></p><p>This sanity checks that the chain of schema we have built should work
when upgrading from one version to the next:</p><ul><li>try each schema with this predecessor:<ul><li><code>SchemaPersistentV1.sql</code> with <code>SchemaPersistentV0.sql</code> as the previous</li><li><code>SchemaPersistentV2.sql</code> with <code>SchemaPersistentV1.sql</code> as the previous</li><li><code>SchemaPersistentV3.sql</code> with <code>SchemaPersistentV2.sql</code> as the previous</li></ul></li><li>if any of these produce errors something is structurally wrong with the test or else previous schema validation is broken</li></ul><p><strong> Two-Step Upgrades </strong></p><p>Now we verify that we can go from any version to any other version with a stop in between to persist.</p><p>An example should make this clearer:</p><ul><li>We start from scratch and go to v2<ul><li>this should produce the v2 reference schema output as before</li></ul></li><li>We run the v4 upgrader on this v2 schema<ul><li>this should produce the v4 reference schema output as before</li><li>i.e. if we go from nothing to v2 to v4 we get the same as if we just go to v4 directly</li></ul></li></ul><p>There are quite a few combinations like this, the test output lists them all:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v0, then to v0 -- must match direct update to v0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v0, then to v1 -- must match direct update to v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v1, then to v1 -- must match direct update to v1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v0, then to v2 -- must match direct update to v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v1, then to v2 -- must match direct update to v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v2, then to v2 -- must match direct update to v2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v0, then to v3 -- must match direct update to v3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v1, then to v3 -- must match direct update to v3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v2, then to v3 -- must match direct update to v3</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Upgrade from nothing to v3, then to v3 -- must match direct update to v3</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note that one of the combinations tested is starting on <code>Vn</code> and &quot;upgrading&quot;
from there to <code>Vn</code>. This should do nothing.</p><p><strong> Testing downgrade </strong></p><p>Here we make sure that any attempt to &quot;go backwards&quot; results in an error.</p><ul><li>the <code>v3</code> schema created by the previous test is used as input to the downgrade test</li><li>the downgrade test was linked with the <code>v2</code> upgrader</li><li>when executed the <code>v2</code> upgrader should report the error<ul><li>this test&#x27;s verifier checks for a correct error report</li></ul></li><li>the test test fails if the error is no correctly reported</li></ul><p>The combination of testing reference outputs plus testing these many invariants
at various stages results in a powerful integration test.  The actual schema
for the varios versions includes all the supported transitions such as
creating and deleting tables and columns, and recreating views, indicies, and triggers.</p><p>All of the possible transitions are more fully discussed in
<a href="https://cgsql.dev/cql-guide/ch10" target="_blank" rel="noopener noreferrer">Chapter 10</a> of the Guide which pairs nicely
with the previous schema validions discussed in
<a href="https://cgsql.dev/cql-guide/ch11" target="_blank" rel="noopener noreferrer">Chapter 11</a>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="testing-the-line-directives-produced-by-cql">Testing the <code>#line</code> directives produced by CQL<a class="hash-link" href="#testing-the-line-directives-produced-by-cql" title="Direct link to heading">â€‹</a></h3><p>[An additional section should be added for the code that verifies the source line number mappings
even though this is a pretty exotic case.]</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">â€‹</a></h3><p>While there are a few more isolated verifications that happen in <code>test.sh</code> and of course
there is the plumbing necessary to let <code>cov.sh</code> use the test script to create coverage reports,
the above forms make up the vast majority of the test patterns.</p><p>Generally, the test files are designed to hold as many tests as can reasonably fit with
the gating factor being cases where different flags are necessary.  There are two different
stages were many different tiny input files are used to create trivial failures like missing
command line arguments and such.  But those cases are all just looking for simple error
text and a failure code, so they should be self-evident.  With so many options, many
such baby tests are needed.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-07-29T21:15:05.000Z">7/29/2022</time></b> by <b>Vaishnavi Mantha</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/cql-guide/int03"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Part 3: C Code Generation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cql-guide/int05"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Part 5: CQL Runtime</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preface" class="table-of-contents__link toc-highlight">Preface</a></li><li><a href="#testing" class="table-of-contents__link toc-highlight">Testing</a><ul><li><a href="#parse-tests" class="table-of-contents__link toc-highlight">Parse Tests</a></li><li><a href="#sematic-tests" class="table-of-contents__link toc-highlight">Sematic Tests</a></li><li><a href="#code-generation-tests" class="table-of-contents__link toc-highlight">Code Generation Tests</a></li><li><a href="#run-tests" class="table-of-contents__link toc-highlight">Run Tests</a></li><li><a href="#schema-upgrade-testing" class="table-of-contents__link toc-highlight">Schema Upgrade Testing</a></li><li><a href="#testing-the-line-directives-produced-by-cql" class="table-of-contents__link toc-highlight">Testing the <code>#line</code> directives produced by CQL</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.254dc0fd.js"></script>
<script src="/assets/js/main.aefc5f50.js"></script>
</body>
</html>