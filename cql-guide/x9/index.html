<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Appendix 9: Using the CQL Amalgam | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Appendix 9: Using the CQL Amalgam | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/x9"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/x9"><link rel="stylesheet" href="/styles.b4d35cce.css">
<link rel="preload" href="/styles.4cc7e11a.js" as="script">
<link rel="preload" href="/runtime~main.339db3f4.js" as="script">
<link rel="preload" href="/main.545e0595.js" as="script">
<link rel="preload" href="/1.3a9ec2a8.js" as="script">
<link rel="preload" href="/2.b42165a9.js" as="script">
<link rel="preload" href="/3.9c3bdf8e.js" as="script">
<link rel="preload" href="/1be78505.655346c0.js" as="script">
<link rel="preload" href="/92.b9f2f94f.js" as="script">
<link rel="preload" href="/5456faf3.d505401c.js" as="script">
<link rel="preload" href="/17896441.25d1d0d8.js" as="script">
<link rel="preload" href="/1d7f01d0.6874cfaa.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch05">Chapter 5: Types of Cursors, OUT and OUT UNION, and FETCH flavors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/x9">Appendix 9: Using the CQL Amalgam</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int01">Part 1: Lexing, Parsing, and the AST</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int02">Part 2: Semantic Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int03">Part 3: C Code Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int04">Part 4: Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int05">Part 5: CQL Runtime</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int06">Part 6: Schema Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int07">Part 7: JSON Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int08">Part 8: Test Helpers</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Appendix 9: Using the CQL Amalgam</h1></header><div class="markdown"><p>This is a brief discussion of the CQL Amalgam and its normal usage patterns.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="building-the-amalgam"></a>Building the Amalgam<a aria-hidden="true" tabindex="-1" class="hash-link" href="#building-the-amalgam" title="Direct link to heading">#</a></h3><p>The amalgam has to include the results of bison and flex, so a normal build must run first.  The simplest
way to build it starting from the <code>sources</code> directory is:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token function" style="color:rgb(130, 170, 255)">make</span><span class="token plain"></span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">./make_amalgam.sh</span></div></div></div></div></div><p>The result goes in <code>out/cql_amalgam.c</code>.  It can then be built using <code>cc</code> with whatever flags you might
desire.  With a few <code>-D</code> directives it can readily be compiled with Microsoft C and it also works with
Emscripten (<code>emcc</code>) basically unchanged.  Clang and Gcc of course also work.</p><p>The standard test script <code>test.sh</code> builds the amalgam and attempts to compile it as well, this ensures
that the amalgam can at least compile at all times.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="testing-the-amalgam"></a>Testing the Amalgam<a aria-hidden="true" tabindex="-1" class="hash-link" href="#testing-the-amalgam" title="Direct link to heading">#</a></h3><p>Of course you can do whatever tests you might like by simply compiling the amalgam as is and then using
it to compile things.  But importantly the test script <code>test.sh</code> can test the amalgam build like so:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-bash codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">test.sh --use_amalgam</span></div></div></div></div></div><p>This runs all the normal tests using the binary built from the amalgam rather than the normal binary.</p><p>Normal CQL development practices result in this happening pretty often so the amalgam tends to stay
in good shape. The code largely works in either form with very few affordances for the amalgam build needed.
Most developers don&#x27;t even think about the amalgam build flavor; to a first approximation &quot;it just works&quot;.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="using-the-amalgam"></a>Using the Amalgam<a aria-hidden="true" tabindex="-1" class="hash-link" href="#using-the-amalgam" title="Direct link to heading">#</a></h3><p>To use the amalgam you&#x27;ll want to do something like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_IS_NOT_MAIN 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Suppresses a bunch of warnings because the code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// is in an #include context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// PR&#x27;s to remove these are welcome :D</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma clang diagnostic ignored &quot;-Wnullability-completeness&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &quot;cql_amalgam.c&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void go_for_it(const char *your_buffer) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  YY_BUFFER_STATE my_string_buffer = yy_scan_string(your_buffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // Note: &quot;--in&quot; is irrelevant because the scanner is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // going to read from the buffer above.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  //</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // If you don&#x27;t use yy_scan_string, you could use &quot;--in&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  // to get data from a file.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int argc = 4;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  char *argv[] = { &quot;cql&quot;, &quot;--cg&quot;, &quot;foo.h&quot;, &quot;foo.c&quot; };</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_main(argc, argv);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  yy_delete_buffer(my_string_buffer);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>So the general pattern is:</p><ul><li>predefine the options you want to use (see below)</li><li>include the amalgam</li><li>add any functions you want that will call the amalgam</li></ul><p>Most amalgam functions are <code>static</code> to avoid name conflicts. You will want to create your own public functions such as <code>go_for_it</code> above that use the amalgam in all the ways you desire.</p><p>You&#x27;ll want to avoid calling any internal functions other than <code>cql_main</code> because they are liable to change.</p><p>NOTE: The amalgam is C code not C++ code.  Do not attempt to use it inside of an <code>extern &quot;C&quot;</code> block in a C++ file.  It won&#x27;t build.  If you want a C++ API expose the C functions you need and write a wrapper class.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql-amalgam-options"></a>CQL Amalgam Options<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql-amalgam-options" title="Direct link to heading">#</a></h3><p>The amalgam includes the following useful <code>#ifdef</code> options to allow you to customize it.</p><ul><li>CQL_IS_NOT_MAIN</li><li>CQL_NO_SYSTEM_HEADERS</li><li>CQL_NO_DIAGNOSTIC_BLOCK</li><li>cql_emit_error</li><li>cql_emit_output</li><li>cql_open_file_for_write</li><li>cql_write_file</li></ul><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_is_not_main"></a>CQL_IS_NOT_MAIN<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_is_not_main" title="Direct link to heading">#</a></h4><p>If this symbol is defined then <code>cql_main</code> will not be redefined to be <code>main</code>.</p><p>As the comments in the source say:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef CQL_IS_NOT_MAIN</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Normally CQL is the main entry point.  If you are using CQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// in an embedded fashion then you want to invoke its main at</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// some other time. If you define CQL_IS_NOT_MAIN then cql_main</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// is not renamed to main.  You call cql_main when you want.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  #define cql_main main</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>Set this symbol so that you own main and cql_main is called at your pleasure.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_no_system_headers"></a>CQL_NO_SYSTEM_HEADERS<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_no_system_headers" title="Direct link to heading">#</a></h4><p>The amalgam includes the normal <code>#include</code> directives needed to make it compile.  Things like stdio and such.
In your situation these headers may not be appropriate.  If <code>CQL_NO_SYSTEM_HEADERS</code> is defined then the amalgam
will not include anything; you can then add whatever headers you need before you include the amalgam.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_no_diagnostic_block"></a>CQL_NO_DIAGNOSTIC_BLOCK<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_no_diagnostic_block" title="Direct link to heading">#</a></h4><p>The amalgam includes a set of recommended directives for warnings to suppress and include.  If you want
to make other choices for these you can suppress the defaults by defining <code>CQL_NO_DIAGNOSTIC_BLOCK</code>;
you can then add whatever diagnostic pragmas you want/need.</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_emit_error"></a>cql_emit_error<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_emit_error" title="Direct link to heading">#</a></h4><p>The amalgam uses <code>cql_emit_error</code> to write its messages to stderr.  The documentation is included in the
code which is attached here.  If you want the error messages to go somewhere else, define <code>cql_emit_error</code>
as the name of your error handling function.  It should accept a <code>const char *</code> and record that string
however you deem appropriate.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef cql_emit_error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// CQL &quot;stderr&quot; outputs are emitted with this API.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You can define it to be a method of your choice with</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// &quot;#define cql_emit_error your_method&quot; and then your method</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// will get the data instead. This will be whatever output the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// compiler would have emitted to to stderr.  This includes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// semantic errors or invalid argument combinations.  Note that</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// CQL never emits error fragments with this API, you always</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// get all the text of one error.  This is important if you</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// are filtering or looking for particular errors in a test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// harness or some such.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// be freed.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Note: you may use cql_cleanup_and_exit to force a failure from</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// within this API but doing so might result in unexpected cleanup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// paths that have not been tested.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void cql_emit_error(const char *err) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fprintf(stderr, &quot;%s&quot;, err);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (error_capture) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    bprintf(error_capture, &quot;%s&quot;, err);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>Typically you would <code>#define cql_emit_error your_error_function</code> before you include the amalgam and then
define your_error_function elsewhere in that file (before or after the amalgam is included are both fine).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_emit_output"></a>cql_emit_output<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_emit_output" title="Direct link to heading">#</a></h4><p>The amalgam uses <code>cql_emit_output</code> to write its messages to stdout.  The documentation is included in the
code which is attached here.  If you want the standard output to go somewhere else, define <code>cql_emit_output</code>
as the name of your output handling function.  It should accept a <code>const char *</code> and record that string
however you deem appropriate.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef cql_emit_output</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// CQL &quot;stdout&quot; outputs are emitted (in arbitrarily small pieces)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// with this API.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You can define it to be a method of your choice with</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// &quot;#define cql_emit_output your_method&quot; and then your method will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// get the data instead. This will be whatever output the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// compiler would have emitted to to stdout.  This is usually</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// reformated CQL or semantic trees and such -- not the normal </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// compiler output.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// be freed.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Note: you may use cql_cleanup_and_exit to force a failure from</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// within this API but doing so might result in unexpected cleanup</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// paths that have not been tested.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void cql_emit_output(const char *msg) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  printf(&quot;%s&quot;, msg);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>Typically you would <code>#define cql_emit_output your_output_function</code> before you include the amalgam and then
define your_error_function elsewhere in that file (before or after the amalgam is included are both fine).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_open_file_for_write"></a>cql_open_file_for_write<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_open_file_for_write" title="Direct link to heading">#</a></h4><p>If you still want normal file i/o for your output but you simply want to control the placement of the output
(such as forcing it to be on some virtual drive) you can replace this function by defining <code>cql_open_file_for_write</code>.</p><p>If all you need to do is control the origin of the <code>FILE *</code> that is written to, you can replace just this function.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef cql_open_file_for_write</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Not a normal integration point, the normal thing to do is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// replace cql_write_file but if all you need to do is adjust</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// the path or something like that you could replace</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// this method instead.  This presumes that a FILE * is still ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// for your scenario.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">FILE *_Nonnull cql_open_file_for_write(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const char *_Nonnull file_name)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  FILE *file;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (!(file = fopen(file_name, &quot;w&quot;))) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cql_error(&quot;unable to open %s for write\n&quot;, file_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cql_cleanup_and_exit(1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  return file;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>Typically you would <code>#define cql_open_file_for_write your_open_function</code> before you include the amalgam and then
define your_open_function elsewhere in that file (before or after the amalgam is included are both fine).</p><h4><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql_write_file"></a>cql_write_file<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql_write_file" title="Direct link to heading">#</a></h4><p>The amalgam uses <code>cql_write_file</code> to write its compilation outputs to the file system.  The documentation is included in the
code which is attached here.  If you want the compilation output to go somewhere else, define <code>cql_write_file</code>
as the name of your output handling function.  It should accept a <code>const char *</code> for the file name and another
for the data to be written.  You can then store those compilation results however you deem appropriate.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef cql_write_file</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// CQL code generation outputs are emitted in one &quot;gulp&quot; with this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// API. You can define it to be a method of your choice with</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// &quot;#define cql_write_file your_method&quot; and then your method will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// get the filename and the data. This will be whatever output the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// compiler would have emitted to one of it&#x27;s --cg arguments.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You can then write it to a location of your choice.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// You must copy the memory if you intend to keep it. &quot;data&quot; will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// be freed.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Note: you *may* use cql_cleanup_and_exit to force a failure </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// from within this API.  That&#x27;s a normal failure mode that is</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// well-tested.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void cql_write_file(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const char *_Nonnull file_name, </span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const char *_Nonnull data)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  FILE *file = cql_open_file_for_write(file_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fprintf(file, &quot;%s&quot;, data);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fclose(file);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><p>Typically you would <code>#define cql_write_file your_write_function</code> before you include the amalgam and then
define your_write_function elsewhere in that file (before or after the amalgam is included are both fine).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="other-notes"></a>Other Notes<a aria-hidden="true" tabindex="-1" class="hash-link" href="#other-notes" title="Direct link to heading">#</a></h3><p>The amalgam will use malloc/calloc for its allocations and it is designed to release all memory it
allocated when cql_main returns control to you. Even in the face of error.</p><p>Internal compilation errors result in an <code>assert</code> failure leading to an abort.  This is not supposed
to ever happen but there can always be bugs.  Normal errors just prevent later phases of the compiler
from running so you might not see file output, but rather just error output.  In all cases things
should be cleaned up.</p><p>The compiler can be called repeatedly with no troubles, it re-initializes on each use. The compiler is
not multi-threaded so if there is threading you should use some mutex arrangement to keep it safe.
A thread-safe version would require extensive modifications.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-11-02T00:34:04.000Z" class="docLastUpdatedAt_217_">11/2/2021</time> by <strong>Winnie Quinn</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/x8"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Appendix 8: CQL Best Practices</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cql-guide/int01"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Part 1: Lexing, Parsing, and the AST Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#building-the-amalgam" class="table-of-contents__link">Building the Amalgam</a></li><li><a href="#testing-the-amalgam" class="table-of-contents__link">Testing the Amalgam</a></li><li><a href="#using-the-amalgam" class="table-of-contents__link">Using the Amalgam</a></li><li><a href="#cql-amalgam-options" class="table-of-contents__link">CQL Amalgam Options</a></li><li><a href="#other-notes" class="table-of-contents__link">Other Notes</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4cc7e11a.js"></script>
<script src="/runtime~main.339db3f4.js"></script>
<script src="/main.545e0595.js"></script>
<script src="/1.3a9ec2a8.js"></script>
<script src="/2.b42165a9.js"></script>
<script src="/3.9c3bdf8e.js"></script>
<script src="/1be78505.655346c0.js"></script>
<script src="/92.b9f2f94f.js"></script>
<script src="/5456faf3.d505401c.js"></script>
<script src="/17896441.25d1d0d8.js"></script>
<script src="/1d7f01d0.6874cfaa.js"></script>
</body>
</html>