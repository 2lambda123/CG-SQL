<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-cql-guide docs-doc-id-ch09">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CG/SQL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CG/SQL Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-49","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>


<link rel="search" type="application/opensearchdescription+xml" title="CG/SQL" href="/opensearch.xml"><title data-rh="true">Chapter 9: Statements Summary and Error Checking | CG/SQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cgsql.dev/cql-guide/ch09"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" property="og:title" content="Chapter 9: Statements Summary and Error Checking | CG/SQL"><meta data-rh="true" name="description" content="&lt;!---"><meta data-rh="true" property="og:description" content="&lt;!---"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cgsql.dev/cql-guide/ch09"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/ch09" hreflang="en"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/ch09" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://1HF376U378-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.46cfcd93.css">
<link rel="preload" href="/assets/js/runtime~main.bd4d3655.js" as="script">
<link rel="preload" href="/assets/js/main.05e5be36.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><div class="announcementBar_mb4j" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_xLdY">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CG/SQL</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG menuWithAnnouncementBar_GW3s"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cql-guide/ch01">CQL Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch05">Chapter 5: Types of Cursors, Shapes, OUT and OUT UNION, and FETCH</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/ch15">Chapter 15: Query Plan Generation</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/x1">Appendix</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/int01">CQL Internals</a></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">CQL Guide</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Chapter 9: Statements Summary and Error Checking</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Chapter 9: Statements Summary and Error Checking</h1></header><p>The following is a brief discussion of the major statement types and the semantic rules that CQL enforces for each of the statements.  A detailed discussion of SQL statements (the bulk of these) is beyond the scope of this document and you should refer to the SQLite documentation for most details.  However, in many cases CQL does provide additional enforcement and it is helpful to describe the basic checking that happens for each fragment of CQL.  A much
more authoritative list of the things CQL checks for can be inferred from the error documentation.  &quot;Tricky&quot; errors have examples and suggested remediation.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-primary-sql-statements">The Primary SQL Statements<a class="hash-link" href="#the-primary-sql-statements" title="Direct link to heading">â€‹</a></h3><p>These are, roughly, the statements that involve the database.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-select-statement">The <code>SELECT</code> Statement<a class="hash-link" href="#the-select-statement" title="Direct link to heading">â€‹</a></h4><p>Top level statement list processing for select.  This is easily the hardest
statement to process. Each clause has its own set of complex rules and
the result of previous clauses constrains the next in a complex fashion.
Among the things that are verified:</p><ul><li>the mentioned tables exist and have the mentioned columns</li><li>the columns are type compatible in their context</li><li>any variables in the expressions are compatible</li><li>aggregate functions are used only in places where aggregation makes sense</li><li>column and table names are unambiguous, especially when self-joins are involved</li><li>compound selects (e.g. with UNION) are type-consistent in all the fragments</li><li>the projection of a select has unique column labels if they are used</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-select--statement">The <code>SELECT *</code> Statement<a class="hash-link" href="#the-select--statement" title="Direct link to heading">â€‹</a></h4><p><code>SELECT *</code> is special in that it creates its own struct type by assembling
all the columns of all the tables in the select&#x27;s join result.  CQL rewrites these
column names into a new <code>SELECT</code> with the specific columns explicitly listed.
While this makes the program slightly bigger it means that logically deleted columns
are never present in results because <code>SELECT *</code> won&#x27;t select them and attempting
to use a logically deleted column results in an error.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-table-statement">The <code>CREATE TABLE</code> Statement<a class="hash-link" href="#the-create-table-statement" title="Direct link to heading">â€‹</a></h4><p>Unlike the other parts of DDL we actually deeply care about the tables.
We have to grab all the columns and column types out of it and create
the appropriate structure type for the table.
Along the way we validate a bunch of stuff like:</p><ul><li>verify unique table name</li><li>no duplicate column names</li><li>recursive correctness of constraints (see constraints discussion below)</li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-unique-key-clause">The <code>UNIQUE KEY</code> Clause<a class="hash-link" href="#the-unique-key-clause" title="Direct link to heading">â€‹</a></h5><p>Similar to other constraints, we don&#x27;t actually do anything with this
other than offer some validation.  Again, we use the usual helpers
for name lookup within the context of the table that contains the constraint.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-foreign-key-clause">The <code>FOREIGN KEY</code> Clause<a class="hash-link" href="#the-foreign-key-clause" title="Direct link to heading">â€‹</a></h5><p>Similar to other constraints, we don&#x27;t actually do anything with this
other than offer some validation.  Again, we use the usual helpers
for name lookup within the context of the table with the foreign key.
Note that the foreign key has to be validated against two tables to fully validate it.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-primary-key-clause">The <code>PRIMARY KEY</code> Clause<a class="hash-link" href="#the-primary-key-clause" title="Direct link to heading">â€‹</a></h5><p>Similar to other constraints, we don&#x27;t actually do anything with this
other than offer some validation.  Again, we use the usual helpers
for name lookup within the context of the table with the primary key.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="the-check-clause">The <code>CHECK</code> Clause<a class="hash-link" href="#the-check-clause" title="Direct link to heading">â€‹</a></h5><p>Similar to other constraints, we don&#x27;t actually do anything with this
other than offer some validation.  The <code>CHECK</code> clause is validated
after the entire table has been processed so that even if it appears
early in the table, the clause can use any columns defined later in the
table.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-index-statement">The <code>CREATE INDEX</code> Statement<a class="hash-link" href="#the-create-index-statement" title="Direct link to heading">â€‹</a></h4><p>CQL doesn&#x27;t really do anything with indices but we do validate that they make sense (so we lookup all the names of all the columns and so forth.)</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-view-statement">The <code>CREATE VIEW</code> Statement<a class="hash-link" href="#the-create-view-statement" title="Direct link to heading">â€‹</a></h4><p>Create view analysis is very simple because the <code>select</code> analysis does the heavy lifting.  All we
have to do is validate that the view is unique, then validate the select statement.</p><p>Additionally, views must not be allowed to have any NULL type columns; all nulls must be converted to
some type with a CAST.   e.g. <code>create view foo as select NULL n</code> is not valid.  NULL is not a real storage type.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-trigger-statement">The <code>CREATE TRIGGER</code> Statement<a class="hash-link" href="#the-create-trigger-statement" title="Direct link to heading">â€‹</a></h4><p>The create trigger statement is quite a beast, and validations include:</p><ul><li>The trigger name must be unique</li><li>For <code>insert</code> the &quot;new.*&quot; table is available in expressions/statement</li><li>For <code>delete</code> the &quot;old.*&quot; table is available in expressions/statements</li><li>For <code>update</code> both are available<ul><li>If optional columns present in the <code>update</code>, they must be unique/valid</li></ul></li><li>The <code>when</code> expression must evaluate to a numeric</li><li>The statement list must be error free with the usual rules plus new/old</li><li>The <code>raise</code> function may be used inside a trigger (NYI)</li><li>The table name must be a table (not a view) UNLESS the trigger type is <code>INSTEAD OF</code></li><li>Select statements inside the statement block do not count as returns for the procedure and that includes the create trigger</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-drop-table-statement">The <code>DROP TABLE</code> Statement<a class="hash-link" href="#the-drop-table-statement" title="Direct link to heading">â€‹</a></h4><p>This is the basic checking for the drop table statement:</p><ul><li>the table must exist in some version</li><li>it has to be a table and not a view</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-drop-view-statement">The <code>DROP VIEW</code> Statement<a class="hash-link" href="#the-drop-view-statement" title="Direct link to heading">â€‹</a></h4><p>This is the basic checking for the drop view statement:</p><ul><li>the view must exist in some version</li><li>it has to be a view and not a table</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-drop-index-statement">The <code>DROP INDEX</code> Statement<a class="hash-link" href="#the-drop-index-statement" title="Direct link to heading">â€‹</a></h4><p>This is the basic checking for the drop index statement:</p><ul><li>the index must exist in some version</li><li>it could be deleted now, that&#x27;s ok, but the name has to be valid</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-drop-trigger-statement">The <code>DROP TRIGGER</code> Statement<a class="hash-link" href="#the-drop-trigger-statement" title="Direct link to heading">â€‹</a></h4><p>This is the basic checking for the drop trigger statement</p><ul><li>the trigger  must exist in some version</li><li>it could be deleted now, that&#x27;s ok, but the name has to be valid</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-raise-statement">The <code>RAISE</code> Statement<a class="hash-link" href="#the-raise-statement" title="Direct link to heading">â€‹</a></h4><p>CQL validates that <code>RAISE</code> is being used in the context of a trigger and that
it has the correct arguments</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-alter-table-add-column-statement">The <code>ALTER TABLE ADD COLUMN</code> Statement<a class="hash-link" href="#the-alter-table-add-column-statement" title="Direct link to heading">â€‹</a></h4><p>To validate <code>alter table add column</code> we check the following:</p><ul><li>the table must exist and not be a view (in any version)</li><li>the column definition of the new column must be self-consistent</li><li>no auto-increment columns may be added</li><li>added columns must be either nullable or have a default value</li></ul><p>Note: Alter statements are typically used in the context of migration, so it&#x27;s
possible the table that is mentioned is condemned in a future version.  We still have to run
the intervening upgrade steps so basically DDL gets to ignore the current deadness
of the table as in context it might be &quot;not dead yet&quot;.  This will be more obvious
in the context of the schema maintenance features. (q.v.)</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-delete-statement">The <code>DELETE</code> Statement<a class="hash-link" href="#the-delete-statement" title="Direct link to heading">â€‹</a></h4><p>The delete analyzer sets up a scope for the table being
deleted and then validates the WHERE clause, if present, against that scope.
Additionally, we verify that the table actually was defined and is not a view.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-update-statement">The <code>UPDATE</code> Statement<a class="hash-link" href="#the-update-statement" title="Direct link to heading">â€‹</a></h4><p>The update analyzer sets up the scope for the table(s) being updated.  If there are
optional clauses (e.g. <code>LIMIT</code>), they are evaluated just like in a select statement
with those same helper methods.  Expression fragments are evaluated similarly as
in a select statement.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-insert-statement">The <code>INSERT</code> Statement<a class="hash-link" href="#the-insert-statement" title="Direct link to heading">â€‹</a></h4><p>We check that the table exists and then we walk the columns and the value list
to make sure they are valid for the table. Also, we cannot insert into a view.</p><p>Details:</p><ul><li>The column list specifies the columns we will provide; they must exist and be unique.</li><li>The columns specified must suffice to insert a row (all not nulls and not default present.)</li><li>The insert list specifies the values that are to be inserted.</li><li>The type of each value must match the type of the column.</li><li>Auto-increment columns may be specified as NULL.</li><li>If there are too many or too few columns, that is considered an error.</li><li>If no columns are specified, that is the same as if all columns had been specified, in table order.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-throw-statement">The <code>THROW</code> Statement<a class="hash-link" href="#the-throw-statement" title="Direct link to heading">â€‹</a></h4><p>Throw can literally go anywhere, so it&#x27;s always ok.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-begin-transaction-statement">The <code>BEGIN TRANSACTION</code> Statement<a class="hash-link" href="#the-begin-transaction-statement" title="Direct link to heading">â€‹</a></h4><p>Begin transaction can go anywhere, so it&#x27;s always ok.</p><p>The sqlite documentation can be helpful here (CQL syntax is a subset).  See: <a href="https://www.sqlite.org/lang_transaction.html" target="_blank" rel="noopener noreferrer">https://www.sqlite.org/lang_transaction.html</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-commit-transaction-statement">The <code>COMMIT TRANSACTION</code> Statement<a class="hash-link" href="#the-commit-transaction-statement" title="Direct link to heading">â€‹</a></h4><p>Commit transaction can go anywhere, so it&#x27;s always ok.</p><p>The sqlite documentation can be helpful here (CQL syntax is a subset).  See: <a href="https://www.sqlite.org/lang_transaction.html" target="_blank" rel="noopener noreferrer">https://www.sqlite.org/lang_transaction.html</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-rollback-transaction-statement">The <code>ROLLBACK TRANSACTION</code> Statement<a class="hash-link" href="#the-rollback-transaction-statement" title="Direct link to heading">â€‹</a></h4><p>Rollback transaction can go anywhere but if you&#x27;re using the format
where you rollback to a particular save point, then we must have
seen that name in a <code>savepoint</code> statement previously. Otherwise, it&#x27;s an error.</p><p>The sqlite documentation can be helpful here again (CQL syntax is a subset).  See: <a href="https://www.sqlite.org/lang_transaction.html" target="_blank" rel="noopener noreferrer">https://www.sqlite.org/lang_transaction.html</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-savepoint-statement">The <code>SAVEPOINT</code> Statement<a class="hash-link" href="#the-savepoint-statement" title="Direct link to heading">â€‹</a></h4><p>The <code>savepoint</code> statement can go anywhere but we do record this savepoint name
as having been seen, so that we can verify it in rollback.  So this is sort of a weak declaration of the savepoint name.</p><p>The sqlite documentation can be helpful here (CQL syntax is a subset).  <a href="https://www.sqlite.org/lang_savepoint.html" target="_blank" rel="noopener noreferrer">https://www.sqlite.org/lang_savepoint.html</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-release-savepoint-statement">The <code>RELEASE SAVEPOINT</code> Statement<a class="hash-link" href="#the-release-savepoint-statement" title="Direct link to heading">â€‹</a></h4><p>Release savepoint can go anywhere but we must have
seen that name in a previous <code>savepoint</code> statement, otherwise it&#x27;s an error.</p><p>The sqlite documentation can be helpful here (CQL syntax is a subset). <a href="https://www.sqlite.org/lang_savepoint.html" target="_blank" rel="noopener noreferrer">https://www.sqlite.org/lang_savepoint.html</a></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-procedure-savepoint-statement">The <code>PROCEDURE SAVEPOINT</code> Statement<a class="hash-link" href="#the-procedure-savepoint-statement" title="Direct link to heading">â€‹</a></h4><p>A common pattern is to have a savepoint associated with a particular procedure. The savepoint&#x27;s scope is the same
as the procedure&#x27;s scope.  More precisely</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">procedure</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">proc</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- your code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>becomes:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">procedure</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain">  </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- @proc is always the name of the current procedure</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> try</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- your code</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">release</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> try</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">begin</span><span class="token plain"> catch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">rollback</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">transaction</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">to</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    </span><span class="token keyword" style="font-style:italic">release</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    throw</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">end</span><span class="token plain"> catch</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token keyword" style="font-style:italic">end</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This form is not quite syntactic sugar because there are some interesting rules:</p><ul><li>the <code>proc savepoint</code> form must be used at the top level of the procedure, hence no <code>leave</code> or <code>continue</code> may escape it</li><li>within <code>begin</code>/<code>end</code> the <code>return</code> form may not be used; you must use <code>rollback return</code> or <code>commit return</code> (see below)</li><li><code>throw</code> may be used to return an error as usual</li><li><code>proc savepoint</code> may be used again, at the top level, in the same procedure, if there are, for instance, several sequential stages</li><li>a procedure using <code>proc savepoint</code> could call another such procedure, or a procedure that manipulates savepoints in some other way</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-rollback-return-statement">The <code>ROLLBACK RETURN</code> Statement<a class="hash-link" href="#the-rollback-return-statement" title="Direct link to heading">â€‹</a></h4><p>This form may be used only inside of  a <code>proc savepoint</code> block.  It indicates that the savepoint should be rolled back and then the procedure
should return.  It is exactly equivalent to:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">rollback</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">transaction</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">to</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">release</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- wouldn&#x27;t actually be allowed inside of proc savepoint; see note below</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: to avoid errors, the loose <code>return</code> above is not actually allowed inside of <code>proc savepoint</code> -- you must use <code>rollback return</code> or <code>commit return</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-commit-return-statement">The <code>COMMIT RETURN</code> Statement<a class="hash-link" href="#the-commit-return-statement" title="Direct link to heading">â€‹</a></h4><p>This form may be used only inside of  a <code>proc savepoint</code> block.  It indicates that the savepoint should be released and then the procedure
should return.  It is exactly equivalent to:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">release</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">savepoint</span><span class="token plain"> </span><span class="token variable" style="color:rgb(191, 199, 213)">@proc</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  </span><span class="token keyword" style="font-style:italic">return</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><span class="token plain"> </span><span class="token comment" style="color:rgb(105, 112, 152);font-style:italic">-- wouldn&#x27;t actually be allowed inside of proc savepoint; see note below</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Of course this isn&#x27;t exactly a commit, in that there might be an outer savepoint or outer transaction that might
still be rolled back, but it is commited at its level of nesting, if you will.  Or, equivalently, you can think of
it as merging the savepoint into the transaction in flight.</p><p>Note: to avoid errors, the loose <code>return</code> above is not actually allowed inside of <code>proc savepoint</code> and you must use <code>rollback return</code> or <code>commit return</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-virtual-table-statement">The <code>CREATE VIRTUAL TABLE</code> Statement<a class="hash-link" href="#the-create-virtual-table-statement" title="Direct link to heading">â€‹</a></h4><p>The SQLite <code>CREATE VIRTUAL TABLE</code> form (<a href="https://sqlite.org/lang_createvtab.html" target="_blank" rel="noopener noreferrer">https://sqlite.org/lang_createvtab.html</a>) is problematic from CQL because:</p><ul><li>it is not parseable, because the module arguments can be literally anything (or nothing), even a letter to your grandma</li><li>the arguments do not necessarily say anything about the table&#x27;s schema at all</li></ul><p>So the CQL form departs from the standard syntax to this form:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> virtual </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> virt_table </span><span class="token keyword" style="font-style:italic">using</span><span class="token plain"> my_module </span><span class="token punctuation" style="color:rgb(199, 146, 234)">[</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain">module arguments</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">]</span><span class="token plain">  </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The part after the <code>AS</code> is used by CQL as a table declaration for the virtual table.  The grammar for that
is exactly the same as a normal <code>CREATE TABLE</code> statement.  However, that part is not transmitted to
SQLite; when the table is created, SQLite sees only the part it cares about, which is the part before the <code>AS</code>.</p><p>In order to have strict parsing rules, the module arguments follow one of these forms:</p><ol><li>no arguments at all</li><li>a list of identifiers, constants, and parenthesized sublists, just like in the <code>@attribute</code> form</li><li>the words <code>arguments following</code></li></ol><h5 class="anchor anchorWithStickyNavbar_LWe7" id="case-1-example">Case 1 Example<a class="hash-link" href="#case-1-example" title="Direct link to heading">â€‹</a></h5><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">create</span><span class="token plain"> virtual </span><span class="token keyword" style="font-style:italic">table</span><span class="token plain"> virt_table </span><span class="token keyword" style="font-style:italic">using</span><span class="token plain"> my_module </span><span class="token keyword" style="font-style:italic">as</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id </span><span class="token keyword" style="font-style:italic">integer</span><span class="token plain"> </span><span class="token operator" style="color:rgb(137, 221, 255)">not</span><span class="token plain"> </span><span class="token boolean" style="color:rgb(255, 88, 116)">null</span><span class="token punctuation" style="color:rgb(199, 146, 234)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name </span><span class="token keyword" style="font-style:italic">text</span><span class="token plain"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"></span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>becomes (to SQLite)</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> VIRTUAL </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> virt_table </span><span class="token keyword" style="font-style:italic">USING</span><span class="token plain"> my_module</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Note: empty arguments <code>USING my_module()</code> are not allowed in the SQLite docs but do seem to work in SQLite.
We take the position that no args should be formatted with no parentheses, at least for now.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="case-2-example">Case 2 Example<a class="hash-link" href="#case-2-example" title="Direct link to heading">â€‹</a></h5><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(foo, &#x27;goo&#x27;, (1.5, (bar, baz))) as (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(foo, &quot;goo&quot;, (1.5, (bar, baz)));</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>This form allows for very flexible arguments but not totally arbitrary arguments, so it can still be
parsed and validated.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="case-3-example">Case 3 Example<a class="hash-link" href="#case-3-example" title="Direct link to heading">â€‹</a></h5><p>This case recognizes the popular choice that the arguments are often the actual schema declaration
for the table in question. So:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">create virtual table virt_table using my_module(arguments following) as (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer not null,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name text</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>becomes</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CREATE VIRTUAL TABLE virt_table USING my_module(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id INTEGER NOT NULL,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  name TEXT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The normalized text (keywords capitalized, whitespace normalized) of the table declaration in the <code>as</code> clause is used as the arguments.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="other-details">Other details<a class="hash-link" href="#other-details" title="Direct link to heading">â€‹</a></h5><p>Virtual tables go into their own section in the JSON and they include the <code>module</code> and <code>moduleArgs</code> entries; they are additionally
marked <code>isVirtual</code> in case you want to use the same processing code for virtual tables as normal tables.  The JSON format is otherwise
the same, although some things can&#x27;t happen in virtual tables (e.g. there is no <code>TEMP</code> option so <code>&quot;isTemp&quot;</code> must be false in the JSON.)</p><p>For purposes of schema processing, virtual tables are on the <code>@recreate</code> plan, just like indices, triggers, etc.  This is the only option since
the <code>alter table</code> form is not allowed on a virtual table.</p><p>Semantic validation enforces &quot;no alter statements on virtual tables&quot; as well as other things like no indices, and no triggers, since SQLite
does not support any of those things.</p><p>CQL supports the notion of <a href="https://www.sqlite.org/vtab.html#epovtab" target="_blank" rel="noopener noreferrer">eponymous virtual tables</a>.  If you intend to register the virtual
table&#x27;s module in this fashion, you can use <code>create virtual table @eponymous ...</code> to declare this to CQL.  The only effect this has
is to ensure that CQL will not try to drop this table during schema maintenance as dropping such a table is an invalid operation.  In
all other ways, the fact that the table is eponymous makes no difference.</p><p>Finally, because virtual tables are on the <code>@recreate</code> plan, you may not have foreign keys that reference virtual tables. Such keys seem
like a bad idea in any case.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-primary-procedure-statements">The Primary Procedure Statements<a class="hash-link" href="#the-primary-procedure-statements" title="Direct link to heading">â€‹</a></h3><p>These are the statements which form the language of procedures, and do not involve the database.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-create-procedure-statement">The <code>CREATE PROCEDURE</code> Statement<a class="hash-link" href="#the-create-procedure-statement" title="Direct link to heading">â€‹</a></h4><p>Semantic analysis of stored procedures is fairly easy at the core:</p><ul><li>check for duplicate names</li><li>validate the parameters are well formed</li><li>set the current proc in flight (this not allowed to nest)</li><li>recurse on the statement list and prop errors</li><li>record the name of the procedure for callers
In addition, while processing the statement:</li><li>we determine if it uses the database; this will change the emitted signature of the proc to include a <code>sqlite3 *db</code>
input argument and it will return a sqlite error code (e.g. <code>SQLITE_OK</code>)</li><li>select statements that are loose in the proc represent the &quot;return&quot; of that
select;  this changes the signature to include a <code>sqlite3_stmt **pstmt</code> parameter corresponding to the returned statement</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-if-statement">The <code>IF</code> Statement<a class="hash-link" href="#the-if-statement" title="Direct link to heading">â€‹</a></h4><p>The top level if node links the initial condition with a possible
series of else_if nodes and then the else node.  Each condition is
checked for validity. The conditions must be valid expressions that
can each be converted to a boolean.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-set-statement">The <code>SET</code> Statement<a class="hash-link" href="#the-set-statement" title="Direct link to heading">â€‹</a></h4><p>The set statement is for variable assignment.  We just validate
that the target exists and is compatible with the source.
Cursor variables cannot be set with simple assignment and CQL generates
errors if you attempt to do so.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-let-statement">The <code>LET</code> Statement<a class="hash-link" href="#the-let-statement" title="Direct link to heading">â€‹</a></h4><p>Let combines a <code>DECLARE</code> and a <code>SET</code>.  The variable is declared to be
the exact type of the right hand side.  All the validations for <code>DECLARE</code>
and <code>SET</code> are applicable, but there is no chance that the variable will
not be compatible with the expression.  The expression could still be
erroneous in the first place.  The variable could be a duplicate.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-switch-statement">The <code>SWITCH</code> Statement<a class="hash-link" href="#the-switch-statement" title="Direct link to heading">â€‹</a></h4><p>The <code>SWITCH</code> form requires a number of conditions to successfully map
down to a <code>C</code> <code>switch</code> statement.  These are:</p><ul><li>the switch-expression must be a not-null integral type (<code>integer not null</code> or <code>long integer not null</code>)<ul><li>the <code>WHEN</code> expressions must be losslessly promotable to the type of the switch-expression</li></ul></li><li>the values in the <code>WHEN</code> clauses must be unique</li><li>If <code>ALL VALUES</code> is present then:<ul><li>the switch-expression must be of an enum type</li><li>the <code>WHEN</code> values must cover every value of the enum except those beginning with &#x27;_&#x27;</li><li>there can be no extra <code>WHEN</code> values not in the enum</li><li>there can be no <code>ELSE</code> clause</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-procedure-statement">The <code>DECLARE PROCEDURE</code> Statement<a class="hash-link" href="#the-declare-procedure-statement" title="Direct link to heading">â€‹</a></h4><p>There are three forms of this declaration:</p><ul><li>a regular procedure with no DML<ul><li>e.g. <code>declare proc X(id integer);</code></li></ul></li><li>a regular procedure that uses DML (it will need a db parameter and returns a result code)<ul><li>e.g. <code>declare proc X(id integer) using transaction;</code></li></ul></li><li>a procedure that returns a result set, and you provide the result columns<ul><li>e.g. <code>declare proc X(id integer) : (A bool not null, B text);</code>
The main validations here are that there are no duplicate parameter names, or return value columns.</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-function-statement">The <code>DECLARE FUNCTION</code> Statement<a class="hash-link" href="#the-declare-function-statement" title="Direct link to heading">â€‹</a></h4><p>Function declarations are similar to procedures; there must be a return type
(use proc if there is none).  The <code>DECLARE SELECT FUNCTION</code> form indicates a function
visible to SQLite; other functions are usable in the <code>call</code> statement.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-variable-statement">The <code>DECLARE</code> Variable Statement<a class="hash-link" href="#the-declare-variable-statement" title="Direct link to heading">â€‹</a></h4><p>This declares a new local or global variable that is not a cursor.
The type is computed with the same helper that is used for analyzing
column definitions.  Once we have the type we walk the list of variable
names, check them for duplicates and such (see above) and assign their type.  The canonical
name of the variable is defined here. If it is later used with a different casing the output
will always be as declared.   e.g. <code>declare Foo integer;  set foo = 1;</code> is legal but the output
will always contain the variable written as <code>Foo</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-cursor-statement">The <code>DECLARE</code> Cursor Statement<a class="hash-link" href="#the-declare-cursor-statement" title="Direct link to heading">â€‹</a></h4><p>There are two forms of the declare cursor, both of which allow CQL to infer the exact type of the cursor.</p><ul><li><code>declare foo cursor for select etc.</code><ul><li>the type of the cursor is the net struct type of the select list</li></ul></li><li><code>declare foo cursor for call proc();</code><ul><li>proc must be statement that produces a result set via select (see above)</li><li>the type of the cursor is the struct of the select returned by the proc</li><li>note if there is more than one loose select in the proc they must match exactly</li></ul></li><li>cursor names have the same rules regarding duplicates as other variables
With this in mind, both cases simply recurse on either the select or the call
and then pull out the structure type of that thing and use it for the cursor&#x27;s shape.  If the
<code>call</code> is not semantically valid according to the rules for calls or the <code>select</code> is not semantically valid,
then of course this declaration will generate errors.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-value-cursor-statement">The <code>DECLARE</code> Value Cursor Statement<a class="hash-link" href="#the-declare-value-cursor-statement" title="Direct link to heading">â€‹</a></h4><p>This statement declares a cursor that will be based on the return type of a procedure.
When using this form the cursor is also fetched, hence the name.  The fetch result of
the stored proc will be used for the value.  At this point, we use its type only.</p><ul><li>the call must be semantically valid</li><li>the procedure must return an OUT parameter (not a result set)</li><li>the cursor name must be unique</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-while-statement">The <code>WHILE</code> Statement<a class="hash-link" href="#the-while-statement" title="Direct link to heading">â€‹</a></h4><p>While semantic analysis is super simple.</p><ul><li>the condition must be numeric</li><li>the statement list must be error-free</li><li>loop_depth is increased allowing the use of interior leave/continue</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-loop-statement">The <code>LOOP</code> Statement<a class="hash-link" href="#the-loop-statement" title="Direct link to heading">â€‹</a></h4><p>Loop analysis is just as simple as &quot;while&quot; -- because the loop_stmt
literally has an embedded fetch, you simply use the fetch helper to
validate that the fetch is good and then visit the statement list.
Loop depth is increased as it is with while.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-call-statement">The <code>CALL</code> Statement<a class="hash-link" href="#the-call-statement" title="Direct link to heading">â€‹</a></h4><p>There are three ways that a call can happen:</p><ul><li>signatures of procedures that we know in full:<ul><li>call foo();</li><li>declare cursor for call foo();</li></ul></li><li>some external call to some outside function we don&#x27;t know<ul><li>e.g. call printf(&#x27;hello, world\n&#x27;);</li></ul></li></ul><p>The cursor form can be used if and only if the procedure has a loose select
or a call to a procedure with a loose select. In that case, the procedure will
have a structure type, rather than just &quot;ok&quot; (the normal signature for a proc).
If the user is attempting to do the second case, cursor_name will be set and
the appropriate verification happens here.</p><p>Note:  Recursively calling fetch cursor is not really doable in general
because at the point in the call we might not yet know that the method
does in fact return a select.  You could make it work if you put the select
before the recursive call.</p><p>Semantic rules:</p><ul><li>for all cases each argument must be error-free (no internal type conflicts)</li><li>for known procs<ul><li>the call has to have the correct number of arguments</li><li>if the formal is an out parameter the argument must be a variable<ul><li>the type of the variable must be an exact type match for the formal</li></ul></li><li>non-out parameters must be type-compatible, but exact match is not required</li></ul></li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare-out-call-statement">The <code>DECLARE OUT CALL</code> Statement<a class="hash-link" href="#the-declare-out-call-statement" title="Direct link to heading">â€‹</a></h4><p>This form is syntactic sugar and corresponds to declaring any <code>OUT</code> parameters
of the <code>CALL</code> portion that are not already declared as the exact type of the
<code>OUT</code> parameter.  This is intended to save you from declaring a lot of variables
just so that you can use them as <code>OUT</code> arguments.</p><p>Since any variables that already exist are not re-declared, there are no
additional semantic rules beyond the normal call except that it is an error
to use this form if no <code>OUT</code> variables needed to be declared.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-fetch-statement">The <code>FETCH</code> Statement<a class="hash-link" href="#the-fetch-statement" title="Direct link to heading">â€‹</a></h4><p>The fetch statement has two forms:</p><ul><li>fetch C into var1, var2, var3 etc.</li><li>fetch C;
The second form is called the auto_cursor.
In the first form the variables of the cursor must be assignment compatible
with declared structure type of the cursor and the count must be correct.
In the second form, the codegen will implicitly create local variables that
are exactly the correct type, but we&#x27;ll cover that later.  Since no semantic error is
possible in that case, we simply record that this is an auto_cursor and then
later we will allow the use of C.field during analysis.
Of course &quot;C&quot; must be a valid cursor.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-continue-statement">The <code>CONTINUE</code> Statement<a class="hash-link" href="#the-continue-statement" title="Direct link to heading">â€‹</a></h4><p>We just need to ensure that <code>continue</code> is inside a <code>loop</code> or <code>while</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-leave-statement">The <code>LEAVE</code> Statement<a class="hash-link" href="#the-leave-statement" title="Direct link to heading">â€‹</a></h4><p>We only need to ensure that <code>leave</code> is inside a <code>loop</code>, <code>while</code> or <code>switch</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-trycatch-statements">The <code>TRY/CATCH</code> Statements<a class="hash-link" href="#the-trycatch-statements" title="Direct link to heading">â€‹</a></h4><p>No analysis needed here other than that the two statement lists are ok.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-close-cursor-statement">The <code>CLOSE</code> CURSOR Statement<a class="hash-link" href="#the-close-cursor-statement" title="Direct link to heading">â€‹</a></h4><p>For close <!-- -->[cursor]<!-- -->, we just validate that the name is in fact a cursor
and it is not a boxed cursor.  Boxed cursor lifetime is managed by the
box object so manually closing it is not allowed.  Instead, the usual
reference-counting semantics apply; the boxed cursor variable typically falls out of
scope and is released, or is perhaps set to NULL to release its reference early.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-out-cursor-statement">The <code>OUT</code> CURSOR Statement<a class="hash-link" href="#the-out-cursor-statement" title="Direct link to heading">â€‹</a></h4><p>For out <!-- -->[cursor]<!-- -->, we first validate that the name is a cursor
then we set the output type of the procedure we&#x27;re in accordingly.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="the-meta-statements">The &quot;Meta&quot; Statements<a class="hash-link" href="#the-meta-statements" title="Direct link to heading">â€‹</a></h3><p>The program&#x27;s control/ the overall meaning of the program / or may give the compiler specific directives
as to how the program should be compiled.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-echo-statement">The <code>@ECHO</code> Statement<a class="hash-link" href="#the-echo-statement" title="Direct link to heading">â€‹</a></h4><p>Echo is valid in any top level contexts.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-previous-schema-statement">The <code>@PREVIOUS SCHEMA</code> Statement<a class="hash-link" href="#the-previous-schema-statement" title="Direct link to heading">â€‹</a></h4><p>Begins the region where previous schema will be compared against what has been
declared before this directive for alterations that could not be upgraded.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-schema_upgrade_script-statement">The <code>@SCHEMA_UPGRADE_SCRIPT</code> Statement<a class="hash-link" href="#the-schema_upgrade_script-statement" title="Direct link to heading">â€‹</a></h4><p>When upgrading the DDL, it&#x27;s necessary to emit create table statements
for the original version of the schema.  These create statements may conflict
with the current version of the schema.  This attribute tells CQL to
1) ignore DDL in stored procedures for declaration purposes; only DDL outside of a proc counts
2) do not make any columns &quot;hidden&quot; thereby allowing all annotations to be present
so they can be used to validate other aspects of the migration script.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-schema_upgrade_version-statement">The <code>@SCHEMA_UPGRADE_VERSION</code> Statement<a class="hash-link" href="#the-schema_upgrade_version-statement" title="Direct link to heading">â€‹</a></h4><p>For sql stored procedures that are supposed to update previous schema versions
you can use this attribute to put CQL into that mindset.  This will make
the columns hidden for the version in question rather than the current version.
This is important because older schema migration procedures might still refer to
old columns.  Those columns truly exist at that schema version.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-enforce_strict-statement">The <code>@ENFORCE_STRICT</code> Statement<a class="hash-link" href="#the-enforce_strict-statement" title="Direct link to heading">â€‹</a></h4><p>Switch to strict mode for the indicated item.  The choices and their meanings are:</p><ul><li>&quot;FOREIGN KEY ON DELETE&quot; indicates there must be some <code>ON DELETE</code> action in every FK</li><li>&quot;FOREIGN KEY ON UPDATE&quot; indicates there must be some <code>ON UPDATE</code> action in every FK</li><li>&quot;INSERT SELECT&quot; indicates that insert with <code>SELECT</code> for values may not include top level joins (avoiding a SQLite bug)</li><li>&quot;IS TRUE&quot; indicates that <code>IS TRUE</code> <code>IS FALSE</code> <code>IS NOT TRUE</code> <code>IS NOT FALSE</code> may not be used (*)</li><li>&quot;JOIN&quot; indicates only ANSI style joins may be used, and &quot;from A,B&quot; is rejected</li><li>&quot;PROCEDURE&quot; indicates no calls to undeclared procedures (like loose printf calls)</li><li>&quot;SELECT IF NOTHING&quot; indicates <code>(select ...)</code> expressions must include an <code>IF NOTHING</code> clause if they have a <code>FROM</code> part</li><li>&quot;TABLE FUNCTIONS&quot; indicates table valued functions cannot be used on left/right joins (avoiding a SQLite bug)</li><li>&quot;TRANSACTION&quot; indicates no transactions may be started, committed, or aborted</li><li>&quot;UPSERT&quot; indicates no upsert statement may be used (*)</li><li>&quot;WINDOW FUNCTION&quot; indicates no window functions may be used (*)</li><li>&quot;WITHOUT ROWID&quot; indicates <code>WITHOUT ROWID</code> may not be used</li></ul><p>The items marked with * are present so that features can be disabled to target downlevel versions of SQLite
that may not have those features.</p><p>See the grammar details for exact syntax.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-enforce_normal-statement">The <code>@ENFORCE_NORMAL</code> Statement<a class="hash-link" href="#the-enforce_normal-statement" title="Direct link to heading">â€‹</a></h4><p>Turn off strict enforcement for the indicated item.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-enforce_push-statement">The <code>@ENFORCE_PUSH</code> Statement<a class="hash-link" href="#the-enforce_push-statement" title="Direct link to heading">â€‹</a></h4><p>Push the current strict settings onto the enforcement stack.  This does not change the current settings.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-enforce_pop-statement">The <code>@ENFORCE_POP</code> Statement<a class="hash-link" href="#the-enforce_pop-statement" title="Direct link to heading">â€‹</a></h4><p>Pop the previous current strict settings from the enforcement stack.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-enforce_reset-statement">The <code>@ENFORCE_RESET</code> Statement<a class="hash-link" href="#the-enforce_reset-statement" title="Direct link to heading">â€‹</a></h4><p>Turns off all the strict modes.  Best used immediately after <code>@ENFORCE_PUSH</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-declare_schema_region-statement">The <code>@DECLARE_SCHEMA_REGION</code> Statement<a class="hash-link" href="#the-declare_schema_region-statement" title="Direct link to heading">â€‹</a></h4><p>A schema region is a partitioning of the schema such that it
only uses objects in the same partition or one of its declared
dependencies.  One schema region may be upgraded independently
from any others (assuming they happen such that dependents are done first.)
Here we validate:</p><ul><li>the region name is unique</li><li>the dependencies (if any) are unique and exist</li><li>the directive is not inside a procedure</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-begin_schema_region-statement">The <code>@BEGIN_SCHEMA_REGION</code> Statement<a class="hash-link" href="#the-begin_schema_region-statement" title="Direct link to heading">â€‹</a></h4><p>Entering a schema region makes all the objects that follow part of that
region.  It also means that all the contained objects must refer to
only pieces of schema that are in the same region or a dependent region.
Here we validate that region we are entering is in fact a valid region
and that there isn&#x27;t already a schema region.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-end_schema_region-statement">The <code>@END_SCHEMA_REGION</code> Statement<a class="hash-link" href="#the-end_schema_region-statement" title="Direct link to heading">â€‹</a></h4><p>Leaving a schema region puts you back in the default region.
Here we check that we are in a schema region.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-emit_enums-statement">The <code>@EMIT_ENUMS</code> Statement<a class="hash-link" href="#the-emit_enums-statement" title="Direct link to heading">â€‹</a></h4><p>Declared enumarations can be voluminous and it is undesirable for every
emitted <code>.h</code> file to contain every enumeration.  To avoid this problem
you can emit enumeration values of your choice using <code>@emit_enums x, y, z</code>
which places the named enumerations into the <code>.h</code> file associated with
the current translation unit. If no enumerations are listed, all enums
are emitted.</p><p>Note: generated enum definitions are protected by <code>#ifndef X ... #endif</code> so multiple
definitions are harmless and hence you can afford to use <code>@emit_enums</code>
for the same enum in several translations units, if desired.</p><p>Note: Enumeration values also appear in the JSON output in their own section.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-emit_constants-statement">The <code>@EMIT_CONSTANTS</code> Statement<a class="hash-link" href="#the-emit_constants-statement" title="Direct link to heading">â€‹</a></h4><p>This statement is entirely analogous to the the <code>@EMIT_ENUMS</code> except that
the parameters are one or more constant groups.  In fact constants are put
into groups precisely so that they can be emitted in logical bundles (and
to encourage keeping related constants together).  Placing <code>@EMIT_CONSTANTS</code>
causes the C version of the named groups to go into the current <code>.h</code> file.</p><p>Note: Global constants also appear in the JSON output in their own section.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="important-program-fragments">Important Program Fragments<a class="hash-link" href="#important-program-fragments" title="Direct link to heading">â€‹</a></h3><p>These items appear in a variety of places and are worthy of discussion.  They are generally handled uniformly.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="argument-lists">Argument Lists<a class="hash-link" href="#argument-lists" title="Direct link to heading">â€‹</a></h4><p>In each case we walk the entire list and do the type inference on each argument.
Note that this happens in the context of a function call, and depending
on what the function is, there may be additional rules for compatibility of the
arguments with the function.  The generic code doesn&#x27;t do those checks, there
is per-function code that handles that sort of thing.</p><p>At this stage the compiler computes the type of each argument and makes sure
that, independently, they are not bogus.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="procedures-that-return-a-result-set">Procedures that return a Result Set<a class="hash-link" href="#procedures-that-return-a-result-set" title="Direct link to heading">â€‹</a></h4><p>If a procedure is returning a select statement then we need to attach a
result type to the procedure&#x27;s semantic info.  We have to do some extra validation
at this point, especially if the procedure already has some other select that
might be returned.  The compiler ensures that all the possible select results are
are 100% compatible.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="general-name-lookups">General Name Lookups<a class="hash-link" href="#general-name-lookups" title="Direct link to heading">â€‹</a></h4><p>Every name is checked in a series of locations.  If the name is known to be
a table, view, cursor, or some other specific type of object then only those
name are considered.  If the name is more general a wider search is used.</p><p>Among the places that are considered:</p><ul><li>columns in the current join if any (this must not conflict with #2)</li><li>local or global variables</li><li>fields in an open cursor</li><li>fields in enumerations and global constants</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="data-types-with-a-discriminator">Data Types with a Discriminator<a class="hash-link" href="#data-types-with-a-discriminator" title="Direct link to heading">â€‹</a></h4><p>Discriminators can appear on any type, <code>int</code>, <code>real</code>, <code>object</code>, etc.</p><p>Where there is a discriminator the compiler checks that (e.g.) <code>object&lt;Foo&gt;</code> only combines
with <code>object&lt;Foo&gt;</code> or <code>object</code>.  <code>real&lt;meters&gt;</code> only combines with <code>real&lt;meters&gt;</code> or <code>real</code>.
In this way its not possible to accidentally add <code>meters</code> to <code>kilograms</code> or to store
an <code>int&lt;task_id&gt;</code> where an <code>int&lt;person_id&gt;</code> is required.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-case-expression">The <code>CASE</code> Expression<a class="hash-link" href="#the-case-expression" title="Direct link to heading">â€‹</a></h4><p>There are two parts to this: the &quot;when&quot; expression and the &quot;then&quot; expression.
We compute the aggregate type of the &quot;when&quot; expressions as we go, promoting it
up to a larger type if needed (e.g. if one &quot;when&quot; is an int and the other is
a real, then the result is a real).  Likewise, nullability is computed as
the aggregate.  Note that if nothing matches, the result is null, so we always
get a nullable resultm unless there is an &quot;else&quot; expression.
If we started with case expression, then each &quot;when&quot; expression must be comparable
to the case expression.  If we started with case when xx then yy;  then
each case expression must be numeric (typically boolean).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-between-expressions">The <code>BETWEEN</code> EXPRESSIONS<a class="hash-link" href="#the-between-expressions" title="Direct link to heading">â€‹</a></h4><p>Between requires type compatibility between all three of its arguments.
Nullability follows the usual rules: if any might be null then the result
type might be null.  In any case, the result&#x27;s core type is BOOL.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-cast-expression">The <code>CAST</code> Expression<a class="hash-link" href="#the-cast-expression" title="Direct link to heading">â€‹</a></h4><p>For cast expressions we use the provided semantic type;
the only trick is that we preserve the extra properties of the input argument.
e.g. CAST does not remove <code>NOT NULL</code>.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-coalesce-function">The <code>COALESCE</code> Function<a class="hash-link" href="#the-coalesce-function" title="Direct link to heading">â€‹</a></h4><p>Coalesce requires type compatibility between all of its arguments.  The result
is a not null type if we find a not null item in the list.  There should be
nothing after that item.  Note that ifnull and coalesce are really the same thing
except ifnull must have exactly two arguments.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="the-in-and-not-in-expressions">The <code>IN</code> AND <code>NOT IN</code> Expressions<a class="hash-link" href="#the-in-and-not-in-expressions" title="Direct link to heading">â€‹</a></h4><p>The in predicate is like many of the other multi-argument operators.  All the
items must be type compatible.  Note that in this case the nullablity of
the items does not matter, only the nullability of the item being tested.
Note that null in (null) is null, not true.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="aggregate-functions">Aggregate Functions<a class="hash-link" href="#aggregate-functions" title="Direct link to heading">â€‹</a></h4><p>Aggregate functions can only be used in certain places.  For instance
they may not appear in a <code>WHERE</code> clause.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="user-defined-functions">User Defined Functions<a class="hash-link" href="#user-defined-functions" title="Direct link to heading">â€‹</a></h4><p>User defined function - this is an external function.
There are a few things to check:</p><ul><li>If this is declared without the select keyword then<ul><li>we can&#x27;t use these in SQL, so this has to be a loose expression</li></ul></li><li>If this is declared with the select keyword then<ul><li>we can ONLY use these in SQL, not in a loose expression</li></ul></li><li>args have to be compatible with formals</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="calling-a-procedure-as-a-function">Calling a procedure as a function<a class="hash-link" href="#calling-a-procedure-as-a-function" title="Direct link to heading">â€‹</a></h4><p>There are a few things to check:</p><ul><li>we can&#x27;t use these in SQL, so this has to be a loose expression</li><li>args have to be compatible with formals, except</li><li>the last formal must be an OUT arg and it must be a scalar type</li><li>that out arg will be treated as the return value of the &quot;function&quot;</li><li>in code-gen we will create a temporary for it; semantic analysis doesn&#x27;t care</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="root-expressions">Root Expressions<a class="hash-link" href="#root-expressions" title="Direct link to heading">â€‹</a></h4><p>A top level expression defines the context for that evaluation.  Different expressions
can have constraints.  e.g. aggregate functions may not appear in the <code>WHERE</code> clause of a statement.  There are cases where expression nesting can happen. This nesting changes the evaluation context accordingly, e.g. you can put a nested select in a where clause and that
nested select could legally have aggregates.  Root expressions keep a stack of nested contexts to facilitate the changes.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="table-factors">Table Factors<a class="hash-link" href="#table-factors" title="Direct link to heading">â€‹</a></h4><p>A table factor is one of three things:</p><ul><li>a table name (a string)  select * from X</li><li>a select subquery (select X,Y from..) as T2</li><li>a list of table references select * from (X, Y, Z)
Here we dispatch to the appropriate helper for each case.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="joining-with-the-using-clause">Joining with the <code>USING</code> Clause<a class="hash-link" href="#joining-with-the-using-clause" title="Direct link to heading">â€‹</a></h4><p>When specifying joins, one of the alternatives is to give the shared
columns in the join e.g. select * from X inner join Y using (a,b).
This method validates that all the columns are present on both sides of the
join, that they are unique, and they are comparable.
The return code tells us if any columns had SENSITIVE data.   See Special Note on JOIN...USING below</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="join-with-the-on-clause">JOIN WITH THE <code>ON</code> Clause<a class="hash-link" href="#join-with-the-on-clause" title="Direct link to heading">â€‹</a></h4><p>The most explicit join condition is a full expression in an ON clause
this is like <code>select a,b from X inner join Y on X.id = Y.id;</code>
The on expression should be something that can be used as a bool,
so any numeric will do.
The return code tells us if the ON condition used SENSITIVE data.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="table-valued-functions">TABLE VALUED FUNCTIONS<a class="hash-link" href="#table-valued-functions" title="Direct link to heading">â€‹</a></h4><p>Table valued functions can appear anywhere a table is allowed.
The validation rules are:</p><ul><li><p>must be a valid function</p></li><li><p>must return a struct type (i.e. a table-valued-function)</p></li><li><p>must have valid arg expressions</p></li><li><p>arg expressions must match formal parameters
The name of the resulting table is the name of the function</p></li><li><p>but it can be aliased later with &quot;AS&quot;</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-note-on-the-select--and-select-t-forms">Special Note on the <code>select *</code> and <code>select T.*</code> forms<a class="hash-link" href="#special-note-on-the-select--and-select-t-forms" title="Direct link to heading">â€‹</a></h3><p>The <code>select *</code> construct is very popular in many codebases but it can be unsafe to use in production code because, if the schema changes, the code might get columns it does not expect.  Note the extra columns could have appeared anywhere in the result set because the <code>*</code> applies to the entire result of the <code>FROM</code> clause, joins and all, so extra columns are not necessarily at the end and column ordinals are not preserved.  CQL mitigates this situation somewhat with some useful constraints/features:</p></li><li><p>in a <code>select *</code>, and indeed in any query, the column names of the select must be unique, this is because:</p><ul><li>they could form the field names of an automatically generated cursor (see the section on cursors)</li><li>they could form the field names in a CQL result set (see section on result sets)</li><li>it&#x27;s weird/confusing to not have unique names generally</li></ul></li><li><p>when issuing a <code>select *</code> or a <code>select T.*</code> CQL will automatically expand the <code>*</code> into the actual logical columns that exist in the schema at the time the code was compiled</p><ul><li>this is important because if a column had been logically deleted from a table it would be unexpected in the result set even though it is still present in the database and would throw everything off</li><li>likewise if the schema were to change without updating the code, the code will still get the columns it was compiled with, not new columns</li></ul></li></ul><p>Expanding the <code>*</code> at compile time means Sqlite cannot see anything that might tempt it to include different columns in the result.</p><p>With this done we just have to look at the places a <code>select *</code> might appear so we can see if it is safe (or at least reasonably safe) to use <code>*</code> and, by extension of the same argument, <code>T.*</code>.</p><p><em>In an <code>EXISTS</code> or <code>NOT EXISTS</code> clause like `where not exists (select </em> from x)`*</p><ul><li>this is perfectly safe; the particular columns do not matter; <code>select *</code> is not even expanded in this case.</li></ul><p><em>In a statement that produces a result set like `select </em> from table_or_view`*</p><ul><li>binding to a CQL result set is done by column name and we know those names are unique</li><li>we won&#x27;t include any columns that are logically deleted, so if you try to use a deleted column you&#x27;ll get a compile time error</li></ul><p>In a cursor statement like <code>declare C cursor for select * from table_or_view</code> there are two cases here:</p><p><em>Automatic Fetch  <code>fetch C;</code></em></p><ul><li>in this case you don&#x27;t specify the column names yourself;2 they are inferred</li><li>you are therefore binding to the columns by name, so new columns in the cursor would be unused (until you choose to start using them)</li><li>if you try to access a deleted column you get a compile-time error</li></ul><p><em>Manual Fetch:  <code>fetch C into a, b, c;</code></em></p><ul><li>In this case the number and type of the columns must match exactly with the specified variables</li><li>If new columns are added, deleted, or changed, the above code will not compile</li></ul><p>So considering the cases above we can conclude that auto expanding the <code>*</code> into the exact columns present in the compile-time schema version ensures that any incompatible changes result in compile time errors. Adding columns to tables does not cause problems even if the code is not recompiled. This makes the <code>*</code> construct much safer, if not perfect, but no semantic would be safe from arbitrary schema changes without recompilation.  At the very least here we can expect a meaningful runtime error rather than silently fetching the wrong columns.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="special-note-on-the-joinusing-form">Special Note on the JOIN...USING form<a class="hash-link" href="#special-note-on-the-joinusing-form" title="Direct link to heading">â€‹</a></h3><p>CQL varies slightly from SQLite in terms of the expected results for joins if the USING syntax is employed.  This is not the most common syntax (typically an ON clause is used) but Sqlite has special rules for this kind of join.</p><p>Let&#x27;s take a quick look.  First some sample data:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">create table A( id integer, a text, b text);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create table B( id integer, c text, d text);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into A values(1, &#x27;a1&#x27;, &#x27;b1&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into B values(1, &#x27;c1&#x27;, &#x27;d1&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into A values(2, &#x27;a2&#x27;, &#x27;b2&#x27;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into B values(2, &#x27;c2&#x27;, &#x27;d2&#x27;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now let&#x27;s look at the normal join; this is our reference:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">select * from A T1 inner join B T2 on T1.id = T2.id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1|a1|b1|1|c1|d1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2|a2|b2|2|c2|d2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>As expected, you get all the columns of A, and all the columns of B.  The &#x27;id&#x27; column appears twice.</p><p>However, with the <code>USING</code> syntax:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">select * T1 inner join B T2 using (id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1|a1|b1|c1|d1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2|a2|b2|c2|d2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>id</code> column is now appearing exactly once.  However, the situation is not so simple as that.  It seems that what hapened was that the <code>*</code> expansion has not included two copies of the <code>id</code>.  The following cases show that both copies of <code>id</code> are still logically in the join.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">select T1.*, &#x27;xxx&#x27;, T2.* from A T1 inner join B T2 using (id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1|a1|b1|xxx|1|c1|d1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2|a2|b2|xxx|2|c2|d2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The <code>T2.id</code> column is part of the join, it just wasn&#x27;t part of the <code>*</code></p><p>In fact, looking further:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">select T1.id, T1.a, T1.b, &#x27;xxx&#x27;, T2.id, T2.c, T2.d from A T1 inner join B T2 using (id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1|a1|b1|xxx|1|c1|d1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2|a2|b2|xxx|2|c2|d2</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>There is no doubt, <code>T2.id</code> is a valid column and can be used in expressions freely. That means the column cannot be removed from the type calculus.</p><p>Now in CQL, the <code>*</code> and <code>T.*</code> forms are automatically expanded; SQLite doesn&#x27;t see the <code>*</code>.  This is done so that if any columns have been logically deleted they can be elided from the result set.  Given that this happens, the <code>*</code> operator will expand to ALL the columns.  Just the same as if you did <code>T1.*</code> and <code>T2.*</code>.</p><p><em>As a result, in CQL, there is no difference between  the <code>USING</code> form of a join and the <code>ON</code> form of a join.</em></p><p>In fact, only the <code>select *</code> form could possibly be different, so in most cases this ends up being moot anyway.  Typically, you don&#x27;t need to use <code>*</code> in the presence of joins because of name duplication and ambiguity of the column names of the result set.  CQL&#x27;s automatic expansion means you have a much better idea exactly what columns you will get - those that were present in the schema you declared.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_vbeJ"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-10-26T12:10:38.000Z">10/26/2022</time></b> by <b>Vaishnavi Mantha</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/cql-guide/ch08"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Chapter 8: Functions</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cql-guide/ch10"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Chapter 10: Schema Management Features</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#the-primary-sql-statements" class="table-of-contents__link toc-highlight">The Primary SQL Statements</a></li><li><a href="#the-primary-procedure-statements" class="table-of-contents__link toc-highlight">The Primary Procedure Statements</a></li><li><a href="#the-meta-statements" class="table-of-contents__link toc-highlight">The &quot;Meta&quot; Statements</a></li><li><a href="#important-program-fragments" class="table-of-contents__link toc-highlight">Important Program Fragments</a></li><li><a href="#special-note-on-the-joinusing-form" class="table-of-contents__link toc-highlight">Special Note on the JOIN...USING form</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.bd4d3655.js"></script>
<script src="/assets/js/main.05e5be36.js"></script>
</body>
</html>