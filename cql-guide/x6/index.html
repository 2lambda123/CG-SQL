<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-cql-guide docs-doc-id-x6">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.20">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="CG/SQL RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="CG/SQL Atom Feed">

<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-44373548-49","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script><title data-rh="true">Appendix 6: CQL In 20 Minutes | CG/SQL</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://cgsql.dev/cql-guide/x6"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-cql-guide-current"><meta data-rh="true" property="og:title" content="Appendix 6: CQL In 20 Minutes | CG/SQL"><meta data-rh="true" name="description" content="&lt;!---"><meta data-rh="true" property="og:description" content="&lt;!---"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://cgsql.dev/cql-guide/x6"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/x6" hreflang="en"><link data-rh="true" rel="alternate" href="https://cgsql.dev/cql-guide/x6" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.7db86f2e.css">
<link rel="preload" href="/assets/js/runtime~main.d6af60a8.js" as="script">
<link rel="preload" href="/assets/js/main.79429da8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_ZgBM">Skip to main content</a></div><div class="announcementBar_IbjG" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_KsVm">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">CG/SQL</b></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_S7eR colorModeToggle_vKtC"><button class="clean-btn toggleButton_rCf9 toggleButtonDisabled_Pu9x" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_v35p"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_nQuB"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_dLyj"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_mKqt"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_RiI4" type="button"></button><div class="docPage_ualW"><aside class="theme-doc-sidebar-container docSidebarContainer_UQUJ"><div class="sidebar_RiAD"><nav class="menu thin-scrollbar menu_izAj menuWithAnnouncementBar_l2a_"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/ch01">CQL Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/cql-guide/x1">Appendix</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x9">Appendix 9: Using the CQL Amalgam</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x10">Appendix 10: CQL Working Example</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x11">Appendix 11: Production Considerations</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/cql-guide/int01">CQL Internals</a></div></li></ul></nav></div></aside><main class="docMainContainer_uL0j"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_DM6M"><div class="docItemContainer_vinB"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Xlws" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_kU5B"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Appendix</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Appendix 6: CQL In 20 Minutes</span><meta itemprop="position" content="2"></li></ul></nav><div class="theme-doc-markdown markdown"><header><h1>Appendix 6: CQL In 20 Minutes</h1></header><p>What follows is a series of examples intended to illustrate the most important features of
the CQL language. This appendix was significantly influenced by a similar article on Python
at <a href="https://learnxinyminutes.com/docs/python/" target="_blank" rel="noopener noreferrer">https://learnxinyminutes.com/docs/python/</a></p><p>Also of interest:</p><ul><li><a href="http://sqlite.org" target="_blank" rel="noopener noreferrer">http://sqlite.org</a></li><li><a href="https://learnxinyminutes.com/docs/sql" target="_blank" rel="noopener noreferrer">https://learnxinyminutes.com/docs/sql</a></li></ul><p>And with no further delay, CQL in 20 minutes...</p><div class="codeBlockContainer_MPoW theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_B9tL"><pre tabindex="0" class="prism-code language-text codeBlock__0OG thin-scrollbar"><code class="codeBlockLines_gEuF"><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Single line comments start with two dashes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/* C style comments also work</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * C pre-processor features like #include and #define are generally available</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * CQL is typically run through the C pre-processor before it is compile.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 1. Primitive Datatypes and Operators</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You have numbers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3     -- an integer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3L    -- a long integer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3.5   -- a real literal</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0x10  -- 16 in hex</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Math is what you would expect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 + 1     --&gt; 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">8 - 1     --&gt; 7</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10 * 2    --&gt; 20</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">35.0 / 5  --&gt; 7.0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Modulo operation, same as C and SQLite</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7 % 3    --&gt; 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-7 % 3   --&gt; -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7 % -3   --&gt; 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-7 % 3   --&gt; -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Bitwise operators bind left to right like in SQLite</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 | 4 &amp; 3  --&gt;  1  (not 0)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Enforce precedence with parentheses</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 + 3 * 2    --&gt; 7</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">(1 + 3) * 2  --&gt; 8</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use true and false for bools, nullable bool is possible</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">true    --&gt; how to true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">false   --&gt; how to false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null    --&gt; null means &quot;unknown&quot; in CQL like SQLite</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Negate with not</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">not true   --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">not false  --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">not null   --&gt; null (not unknown is unknown)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Logical Operators</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 and 0 --&gt; 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0 or 1  --&gt; 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0 and x --&gt; 0 and x not evaluated</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 or x  --&gt; 1 and x not evaluated</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Remember null is &quot;unknown&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null or false  --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null or true   --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null and false --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null and true  --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Non-zero values are truthy</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0        --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4        --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-6       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">0 and 2  --&gt; 0 (false)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-5 or 0  --&gt; 1 (true)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Equality is == or =</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 == 1       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 = 1        --&gt; true  (= and == are the same thing)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 == 1       --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Note that null is not equal to anything (like SQL)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null == 1    --&gt; null (hence not true)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null == null --&gt; null (hence not true)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; == &quot;x&quot;   --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- IS lets you compare against null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 IS 1       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 IS 1       --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null IS 1    --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null IS null --&gt; true  (Unknown is Unknown?  Yes it is!)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; IS &quot;x&quot;   --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- x IS NOT y is the same as NOT (x IS y)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 IS NOT 1       --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 IS NOT 1       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null IS NOT 1    --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null IS NOT null --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; IS NOT &quot;x&quot;   --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Inequality is != or &lt;&gt;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 != 1       --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt;&gt; 1       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null != 1    --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null &lt;&gt; null --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- More comparisons</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 &lt; 10    --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 &gt; 10    --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt;= 2    --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 &gt;= 2    --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">10 &lt; null --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- To test if a value is in a range</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 &lt; 2 and 2 &lt; 3  --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt; 3 and 3 &lt; 2  --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- BETWEEN makes this look nicer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2 between 1 and 3 --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3 between 2 and 2 --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Strings are created with &quot;x&quot; or &#x27;x&#x27;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;This is a string.\n&quot;           -- can have C style escapes (no embedded nulls)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Th\x69s is a string.\n&quot;        -- even hex literals</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;This isn&#x27;&#x27;t a C style string&#x27;  -- use &#x27;&#x27; to escape single quote ONLY</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 2. Simple Variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL can call simple libc methods with a no-check declaration</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- we&#x27;ll need this for later examples so we can do something</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- with our expressions (i.e. print them)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare procedure printf no check;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">call printf(&quot;I&#x27;m CQL. Nice to meet you!\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Variables are declared with DECLARE.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Keywords and identifiers are not case sensitive.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare x integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can call it X, it is the same thing.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set X := 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- All variables begin with a null value if allowed, else a zero value.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare y integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if y == 0 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Yes, this will run.\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A nullable variable (i.e. not marked with not null) is initialized to null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare z real;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if z is null then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Yes, this will run.\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The various types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_blob blob;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_string text;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_real real;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_int integer;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_object object;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- There are some typical SQL synonyms</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_int int;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long integer;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long int;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long_int;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The basic types can be tagged to make them less miscible</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare m real&lt;meters&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare kg real&lt;kilos&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set m := kg;  -- error!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Object variables can also be tagged so that they are not mixed-up easily</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare dict object&lt;dict&gt; not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare list object&lt;list&gt; not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set dict := create_dict();  -- an external function that creates a dict</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set dict := create_list();  -- error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set list := create_list();  -- ok</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set list := dict;           -- error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Implied type initialization</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET i := 1;      -- integer not null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET l := 1L;     -- long not null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET t := &quot;x&quot;;    -- text not null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET b := x IS y; -- bool not null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET b := x = y;  -- bool (maybe not null depending on x/y)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The psuedo function &quot;nullable&quot; converts the type of its arg to the nullable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- version of the same thing.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET n_i := nullable(1);   -- nullable integer variable initialized to 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">LET l_i := nullable(1L);  -- nullable long variable initialized to 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 3. Control Flow</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Just make a variable</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare some_var integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set some_var := 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Here is an IF statement</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if some_var &gt; 10 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is totally bigger than 10.\n&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">else if some_var &lt; 10 then  -- else if is optional</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is smaller than 10.\n&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">else -- else is optional</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is indeed 10.\n&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- WHILE loops iterate as usual</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use LEAVE to end a loop early</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 500</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if i &gt;= 5 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     -- we are not going to get anywhere near 500</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     leave;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use CONTINUE to go back to the loop test</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 500</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if i % 2 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     -- Note: we to do this after &quot;i&quot; is incremented!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     -- to avoid an infinite loop</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     continue;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- odd numbers will not be printed because of continue above</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> /**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 4. Complex Expression Forms</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> -- Case is an expression, so it is more like the C &quot;?:&quot; operator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> -- than a switch statement.  It is like &quot;?:&quot; on steroids.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> case i              -- a switch expression is optional</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   when 1 then &quot;one&quot; -- one or more cases</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   when 2 then &quot;two&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   else &quot;other&quot;      -- else is optional</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Case with no common expression is a series of independent tests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   when i == 1 then &quot;i = one&quot;   -- booleans could be completely unrelated</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   when j == 2 then &quot;j = two&quot;   -- first match wins</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   else &quot;other&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- If nothing matches the cases, the result is null.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following expression yields null because 7 is not 1.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case 7 when 1 then &quot;one&quot; end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Case is just an expression, so it can nest</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case X</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  when 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case y when 1 &quot;x:1 y:1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">           else &quot;x:1 y:other&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    case when z == 1 &quot;x:other z:1&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">         else &quot;x:other z:other&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- IN is used to test for membership</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5 IN (1, 2, 3, 4, 5)  --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7 IN (1, 2)           --&gt; false</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null in (1, 2, 3)     --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null in (1, null, 3)  --&gt; null  (null == null is not true)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">7 NOT IN (1, 2)       --&gt; true</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null not in (null, 3) --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 4. Working with and &quot;getting rid of&quot; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Null can be annoying, you might need a not null value.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- In most operations null is radioactive:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null + x     --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null * x     --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null == null --&gt; null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- IS and IS NOT always return 0 or 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">null is 1     -&gt; 0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1 is not null -&gt; 1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- COALESCE returns the first non null arg, or the last arg if all were null.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- If the last arg is not null, you get a non null result for sure.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following is never null, but it&#x27;s false if either x or y is null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">COALESCE(x==y, false) -&gt; thought excercise: how is this different than x IS y?</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- IFNULL is coalesce with 2 args only (COALESCE is more general)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">IFNULL(x, -1) --&gt; use -1 if x is null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The reverse, NULLIF, converts a sentinel value to unknown, more exotic</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NULLIF(x, -1) --&gt; if x is -1 then use null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- the else part of a case can get rid of nulls</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CASE when x == y then 1 else 0 end;  --&gt; true iff x = y and neither is null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- CASE can be used to give you a default value after various tests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following expression is never null; &quot;other&quot; is returned if x is null.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CASE when x &gt; 0 then &quot;pos&quot; when x &lt; 0 then &quot;neg&quot; else &quot;other&quot; end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can &quot;throw&quot; out of the current procedure (see exceptions below)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare x integer not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set x := ifnull_throw(nullable_int_expr); -- returns non null, throws if null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- If you have already tested the expression then control flow analysis</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- improves its type to &quot;not null&quot;.  Many common check patterns are recognized.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if nullable_int_expr is not null then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- nullable_int_expression is known to be not null in this context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set x := nullable_int_expr;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 5. Tables, Views, Indices, Triggers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Most forms of data definition language DDL are supported.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;Loose&quot; DDL (outside of any procedure) simply declares</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- schema, it does not actually create it; the schema is assumed to</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- exist as you specified.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create table T1(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer primary key,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  t text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  r real</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create table T2(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer primary key references T1(id),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  l long,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  b blob</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL can take a series of schema declarations (DDL) and</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- automatically create a procedure that will materialize</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- that schema and even upgrade previous versions of the schema.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- This system is discussed in Chapter 10 of The Guide.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- To actually create tables and other schema you need</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- procedures that look like the below:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc make_tables()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  create table T1 if not exists (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    id integer primary key,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    t text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    r real</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  );</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Views are supported</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create view V1 as (select * from T1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Triggers are supported</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create trigger if not exists trigger1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  before delete on T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  delete from T2 where id = old.id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Indices are supported</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create index I1 on T1(t);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create index I2 on T1(r);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The various drop forms are supported</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">drop index I1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">drop index I2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">drop view V1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">drop table T2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">drop table T1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A complete discussion of DDL is out of scope, refer to sqlite.org</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 6. Selecting Data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- We will use this scratch variable in the following examples</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare rr real;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- First observe CQL is a two-headed language</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := 1+1;           -- this is evaluated in generated C code</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := (select 1+1);  -- this expresion goes to SQLite; SQLite does the addition</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL tries to do most things the same as SQLite in the C context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- but some things are exceedingly hard to emulate correctly.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Even simple looking things such as:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := (select cast(&quot;1.23&quot; as real));   --&gt;  rr := 1.23</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := cast(&quot;1.23&quot; as real);            --&gt;  error (not safe to emulate SQLite)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- In general, numeric/text conversions have to happen in SQLite context</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- because the specific library that does the conversion could be and usually</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- is different than the one CQL would use.  It would not do to give different answers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- in one context or another so those conversions are simply not supported.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Loose concatenation is not supported because of the implied conversions.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Loose means &quot;not in the context of a SQL statement&quot;.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := 1.23;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select cast(&quot;100&quot;||r as real));  --&gt; 1001.23 (a number)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := cast(&quot;100&quot;||r as real);  --&gt; error, concat not supported in loose expr</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A simple insertion</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into T1 values (1, &quot;foo&quot;, 3.14);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Finally, reading from the database</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1 where id = 1);  --&gt; r = 3.14</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The (select ...) form requires the result to have at least one row.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can use IF NOTHING forms to handle other cases such as:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          where id = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          if nothing -1);  --&gt; r = -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- If the SELECT statement might return a null result you can handle that as well</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          where id = 2</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">          if nothing or null -1);  --&gt; r = -1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- With no IF NOTHING clause, lack of a row will cause the SELECT expression to throw</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- an exception.  IF NOTHING THROW merely makes this explicit.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1 where id = 2 if nothing throw);  --&gt; will throw</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 6. Procedures, Results, Exceptions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures are a list of statements that can be executed, with arguments.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc hello()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Hello, world\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- IN, OUT, and INOUT parameters are possible</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc swizzle(x integer, inout y integer, out z real not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set y := x + y;  -- any computation you like</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- bizarre way to compute an id but this is just an illustration</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set z := (select r from T1 where id = x if nothing or null -1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures like &quot;hello&quot; (above) have a void signature -- they return nothing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- as nothing can go wrong. Procedures that use the database like &quot;swizzle&quot; (above)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- can return an error code if there is a problem.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;will_fail&quot; (below)  will always return SQLITE_CONSTRAINT, the second insert</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- is said to &quot;throw&quot;.  In CQL exceptions are just result codes.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc will_fail()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   insert into T1 values (1, &quot;x&quot;, 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   insert into T1 values (1, &quot;x&quot;, 1);  --&gt; duplicate key</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- DML that fails generates an exception and</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- exceptions can be caught. Here is a example:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  id_ integer primary key,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  t_ text,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  r_ real</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- try to insert</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1(id, t, r) values (id_, t_, r_);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- if the insert fails, try to update</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    update T1 set t = t_, r = r_ where id = id_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes can be very useful in avoiding boilerplate code</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- the following is equivalent to the above.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- More on shapes later.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1 from arguments</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    update T1 set t = t_, r = r_ where id = id_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can (re)throw an error explicitly.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- If there is no current error you get SQLITE_ERROR</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_wrapper(LIKE t1) -- my args are the same as the columns of T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if r_ &gt; 10 then throw end if; -- throw if r_ is too big</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call upsert_t1(from arguments);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures can also produce a result set.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The compiler generates the code to create this result set</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- and helper functions to read rows out of it.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc get_low_r(r_ real)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   -- optionally insert some rows or do other things</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   select * from T1 where T1.r &lt;= r_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A procedure can choose between various results, the choices must be compatible.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The last &quot;select&quot; to run controls the ultimate result.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc get_hi_or_low(r_ real, hi_not_low bool not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- trying to do this with one query would result in a poor plan, so</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- instead we use two economical queries.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if hi_not_low then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    select * from T1 where T1.r &gt;= r_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    select * from T1 where T1.r &lt;= r_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Using IF to create to nice selects above is a powerful thing.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- SQLite has no IF, if we tried to create a shared query we get</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- something that does not use indices at all.  As in the below.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The two-headed CQL beast has its advantages!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">select * from T1 where case hi_not_low then T1.r &gt;= r_ else T1.r &lt;= r_ end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can get the current return code and use it in your CATCH logic.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- This upsert is a bit better than the first:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1 from arguments</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if @rc == 19 /* SQLITE_CONSTRAINT */ then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      update T1 set t = t_, r = r_ where id = id_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      throw;  -- rethrow, something bad happened.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- By convention, you can call a procedure that has an OUT argument</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- as its last argument using function notation.  The out argument</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- is used as the return value.   If the called procedure uses the</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- database then it could throw which causes the caller to throw</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- as usual.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc fib(n integer not null, out result integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   set result := case n &lt;= 2 then 1 else fib(n-1) + fib(n-2) end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 7. Statement Cursors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Statement cursors let you iterate over a select result.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Here we introduce cursors, LOOP and FETCH.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc count_t1(r_ real, out rows_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare rows integer not null;  -- starts at zero guaranteed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor for select * from T1 where r &lt; r_;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  loop fetch C -- iterate until fetch returns no row</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- goofy code to illustrate you can process the cursor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- in whatever way you deem appropriate</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    if C.r &lt; 5 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">      rows := rows + 1; -- count rows with C.r &lt; 5</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set rows_ := rows;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Cursors can be tested for presence of a row</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- and they can be closed before the enumeration is finished.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- As before the below is somewhat goofy example code.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc peek_t1(r_ real, out rows_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   /* rows_ is set to zero for sure! */</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   declare C cursor for select * from T1 where r &lt; r_ limit 2;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   open C;  -- this is no-op, present because other systems have it</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   fetch C;  -- fetch might find a row or not</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   if C then  -- cursor name as bool indicates presence of a row</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     set rows_ = rows_ + (C.r &lt; 5);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     fetch C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     set rows_ = rows_ + (C and C.r &lt; 5);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   close C;  -- cursors auto-closed at end of method but early close possible</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The FETCH...INTO form can be used to fetch directly into variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C into id_, t_, r_;  --&gt; loads named locals instead of C.id, C.t, C.r</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A procedure can be the source of a cursor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor for call get_low_r(3.2);  -- valid cursor source</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- OUT can be used to create a result set that is just one row</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc one_t1(r_ real)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   declare C cursor for select * from T1 where r &lt; r_ limit 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   fetch C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   out C;  -- emits a row if we have one, no row is ok too, empty result set.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 8. Value Cursors, Out, and Out Union</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- To consume a procedure that uses &quot;out&quot; you can declare a value cursor.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- By itself such as cursor does not imply use of the database, but often</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- the source of the cursor uses the database.  In this example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- consume_one_t1 uses the database because of the call to one_t1.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc consume_one_t1()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- a cursor whose shape matches the one_t1 &quot;out&quot; statement</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like one_t1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it from the call</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if C.r &gt; 10 then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- use values as you see fit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;woohoo&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can do the above in one step with the compound form:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor fetch from call one_t1(7); -- declare and fetch</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Value cursors can come from anywhere and can be a procedure result</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc use_t1_a_lot()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- T1 is the same shape as one_t1, this will work, too</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like T1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);  -- load it from the call</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- some arbitrary logic might be here</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load C again with different args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(12);   -- load it again</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- some arbitrary logic might be here</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- now load C yet again with explicit args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C using</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     1 id,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;foo&quot; t,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     8.2 r;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- now return it</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  out C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Make a complex result set one row at a time</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc out_union_example()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- T1 is the same shape as one_t1, this will work, too</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like T1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it from the call</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- note out UNION rather than just out, indicating potentially many rows</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it again with different args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(12);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- do something, then maybe load it again with explicit args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C using</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     1 id,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;foo&quot; t,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">     8.2 r;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- we have generated a 3 row result set</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Consume the above</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc consume_result()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor for call out_union_example();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  loop fetch C</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- use builtin cql_cursor_format to make the cursor into a string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 9. Named Types and Enumerations</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Create a simple named types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare my_type type integer not null;   -- make an alias for integer not null</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare i my_type;  -- use it, &quot;i&quot; is an integer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Mixing in type kinds is helpful</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare distance type real&lt;meters&gt;;  -- e.g., distances to be measured in meters</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare time type real&lt;seconds&gt;;     -- e.g., time to be measured in seconds</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare job_id type long&lt;job_id&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare person_id type long&lt;person_id&gt;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- With the above done</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--  * vars/cols of type &quot;distance&quot; are incompatible with those of type &quot;time&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--  * vars/cols of types job_id are incompatible with person_id</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- This is true even though the underlying type is the same for both!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- ENUM declarations can have any numeric type as their base type</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum implement integer (</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   pencil,       -- values start at 1 unless you use = to choose something</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   pen,          -- the next enum gets previous + 1 as its value (2)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">   brush = 7     -- with = expression you get the indicated value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The above also implicitly does this</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare implement type integer&lt;implement&gt; not null;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Using the enum -- simply use dot notation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare impl implement;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set impl := implement.pen;  -- value &quot;2&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can emit an emum into the current .h file we are going to generate.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Do not put this directive in an include file, you want it to go to one place.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Instead, pick one compiland that will &quot;own&quot; the emission of the enum.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- C code can then #include that one .h file.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">@emit_enums implement;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 10. Shapes and Their Uses</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes first appeared to help define value cursors like so:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A table or view name defines a shape</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor like T1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The result of a proc defines a shape</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare D cursor like one_t1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A dummy select statement defines a shape (the select does not run)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- this one is the same as (x integer not null, y text not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare E cursor like select 1 x, &quot;2&quot; y;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Another cursor defines a shape</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare F cursor like C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The arguments of a procedure define a shape. If you have</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- create proc count_t1(r_ real, out rows_ integer not null) ...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- the shape will be:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">--  (r_ real, rows_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare G cursor like count_t1 arguments;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A loaded cursor can be used to make a call</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">call count_t1(from G);  -- the args become G.r_, G.rows_</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- A shape can be used to define a procedures args, or some of the args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- In the following &quot;p&quot; will have arguments:s id_, t_, and r_ with types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- matching table T1.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Note: To avoid ambiguity, an _ was added to each name!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc p(like T1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- do whatever you like</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The arguments of the current procedure are a synthetic shape</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- called &quot;arguments&quot; and can used where other shapes can appear.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- For instance, you can have &quot;q&quot; shim to &quot;p&quot; using this form:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc q(like T1, print bool not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- maybe pre-process, silly example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set id_ := id_ + 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- shim to p</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from arguments); -- pass my args through, whatever they are</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- maybe post-process, silly example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  set r_ := r_ - 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  if print then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    -- convert args to cursor</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    declare C like q arguments;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    fetch C from arguments;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- insert a row based on the args</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T1 from arguments;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You an use a given shape more than once if you name each use.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- This would be more exciting if T1 was like a &quot;person&quot; or something.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create proc r(a like T1, b like T1)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from a);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from b);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- you can refer to a.id, b.id etc.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C like a;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from a;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;%s\n&quot;, cql_cursor_format(C));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from b;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;%s\n&quot;, cql_cursor_format(C));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes can be subsetted, for instance in the following example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- only the arguments that match C are used in the FETCH.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C from arguments(like C);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Fetch the columns of D into C using the cursor D for the data source.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Other columns get default values.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like D) from D;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the D shape to load C, dummy values for the others.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- In this example, dummy_seed means use the provided value, 11, for</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- any numerics that are not specified (not in D) and and use</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;col_name_11&quot; for any strings/blobs.  This pattern is useful in test code</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- to create dummy data, hence the name.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like D) from D @dummy_seed(11);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the Z shape to control which fields are copied.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the dummy value even if the field is nullable and null would have be ok.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The above patterns also work for insert statements</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The shape constraints are generally useful.  The dummy data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- sources are useful for inserting test data.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into T1(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- We&#x27;ll need this dummy procedure some_shape so we can use its return</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- value in the examples that follow.  We will never actual create this</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- proc, we only declare it to define the shape, so this is kind of like</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- a typedef.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare proc some_shape() (x integer not null, y integer not null, z integer not null);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can make a helper procedure to create test args that are mostly constant</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- or computable.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">create get_foo_args(X like some_shape, seed_ integer not null)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like foo arguments;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  -- any way of loading C could work this is one</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C(like X) from X @dummy_seed(seed_);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">  out C;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Now we can use the &quot;get_foo_args&quot; to get full set of arguments for &quot;foo&quot; and then</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- call &quot;foo&quot; with those arguments.  In this example we&#x27;re providing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- some of the arguments explicitly, &quot;some_shape&quot; is the part of the args that</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- needs to manually vary in each test iteration, the rest of the arguments will</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- be dummy values.  There could be zillions of args in either category.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- In the below &quot;some_shape&quot; is going to get the manual values 1, 2, 3 while 100</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- will be the seed for the dummy args.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare foo_args cursor fetch from call get_foo_args(1,2,3, 100);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">call foo(from foo_args);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> * 11. INSERT USING and FETCH USING</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> -- This kind of thing is a pain</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain"> insert into foo(a, b, c, d, e, f, g)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    values(1, 2, 3, null, null, 5, null);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- Instead, write this form:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">insert into foo USING</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    1 a, 2 b, 3 c, null d, null e, 5 f, null g;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">-- The FETCH statement can also be &quot;fetch using&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor like foo;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C USING</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">    1 a, 2 b, 3 c, null d, null e, 5 f, null g;</span><br></span></code></pre><div class="buttonGroup_hRr1"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_W9eQ" aria-hidden="true"><svg class="copyButtonIcon_XEyF" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_i9w9" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>If you&#x27;ve read this far you know more than most now.  :)</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"></div><div class="col lastUpdated_foO9"><span class="theme-last-updated">Last updated<!-- --> on <b><time datetime="2022-06-16T00:30:20.000Z">6/16/2022</time></b> by <b>Diego AstiazarÃ¡n</b></span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/cql-guide/x5"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Appendix 5: JSON Schema Grammar</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/cql-guide/x7"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Appendix 7: CQL Anti-patterns</div></a></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_I5OW"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_gHmE"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_W2Cr themedImage--light_TfLj footer__logo"><img src="/img/oss_logo.png" alt="Meta Platforms Open Source Logo" class="themedImage_W2Cr themedImage--dark_oUvU footer__logo"></a></div><div class="footer__copyright">Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d6af60a8.js"></script>
<script src="/assets/js/main.79429da8.js"></script>
</body>
</html>