<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Appendix 6: CQL In 20 Minutes | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Appendix 6: CQL In 20 Minutes | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/x6"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/x6"><link rel="stylesheet" href="/styles.9ec987f3.css">
<link rel="preload" href="/styles.58a786a3.js" as="script">
<link rel="preload" href="/runtime~main.ad59d5b8.js" as="script">
<link rel="preload" href="/main.8da86549.js" as="script">
<link rel="preload" href="/1.fae5e295.js" as="script">
<link rel="preload" href="/2.0eb37f9a.js" as="script">
<link rel="preload" href="/3.5c2742cc.js" as="script">
<link rel="preload" href="/1be78505.bc52d199.js" as="script">
<link rel="preload" href="/106.5c1aa3b0.js" as="script">
<link rel="preload" href="/5456faf3.c3a29041.js" as="script">
<link rel="preload" href="/17896441.5a19be7f.js" as="script">
<link rel="preload" href="/000c2429.6896fa8e.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div class="announcementBar_1l0Z" style="background-color:#20232a;color:#fff" role="banner"><div class="announcementBarContent_1xni">Support Ukraine ðŸ‡ºðŸ‡¦ <a target="_blank" rel="noopener noreferrer" href="https://opensource.fb.com/support-ukraine"> Help Provide Humanitarian Aid to Ukraine</a>.</div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch05">Chapter 5: Types of Cursors, Shapes, OUT and OUT UNION, and FETCH</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x9">Appendix 9: Using the CQL Amalgam</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x10">Appendix 10: CQL Working Example</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/x11">Appendix 11: Production Considerations</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int01">Part 1: Lexing, Parsing, and the AST</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int02">Part 2: Semantic Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int03">Part 3: C Code Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int04">Part 4: Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int05">Part 5: CQL Runtime</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int06">Part 6: Schema Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int07">Part 7: JSON Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/int08">Part 8: Test Helpers</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Appendix 6: CQL In 20 Minutes</h1></header><div class="markdown"><p>What follows is a series of examples intended to illustrate the most important features of
the CQL language. This appendix was significantly influenced by a similar article on Python
at <a href="https://learnxinyminutes.com/docs/python/" target="_blank" rel="noopener noreferrer">https://learnxinyminutes.com/docs/python/</a></p><p>Also of interest:</p><ul><li><a href="http://sqlite.org" target="_blank" rel="noopener noreferrer">http://sqlite.org</a></li><li><a href="https://learnxinyminutes.com/docs/sql" target="_blank" rel="noopener noreferrer">https://learnxinyminutes.com/docs/sql</a></li></ul><p>And with no further delay, CQL in 20 minutes...</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Single line comments start with two dashes</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/* C style comments also work</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * C pre-processor features like #include and #define are generally available</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * CQL is typically run through the C pre-processor before it is compile.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 1. Primitive Datatypes and Operators</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You have numbers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3     -- an integer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3L    -- a long integer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3.5   -- a real literal</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0x10  -- 16 in hex</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Math is what you would expect</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 + 1     --&gt; 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">8 - 1     --&gt; 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">10 * 2    --&gt; 20</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">35.0 / 5  --&gt; 7.0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Modulo operation, same as C and SQLite</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7 % 3    --&gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-7 % 3   --&gt; -1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7 % -3   --&gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-7 % 3   --&gt; -1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Bitwise operators bind left to right like in SQLite</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 | 4 &amp; 3  --&gt;  1  (not 0)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Enforce precedence with parentheses</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 + 3 * 2    --&gt; 7</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">(1 + 3) * 2  --&gt; 8</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use true and false for bools, nullable bool is possible</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">true    --&gt; how to true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">false   --&gt; how to false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null    --&gt; null means &quot;unknown&quot; in CQL like SQLite</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Negate with not</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">not true   --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">not false  --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">not null   --&gt; null (not unknown is unknown)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Logical Operators</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 and 0 --&gt; 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0 or 1  --&gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0 and x --&gt; 0 and x not evaluated</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 or x  --&gt; 1 and x not evaluated</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Remember null is &quot;unknown&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null or false  --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null or true   --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null and false --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null and true  --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Non-zero values are truthy</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0        --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">4        --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-6       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">0 and 2  --&gt; 0 (false)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-5 or 0  --&gt; 1 (true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Equality is == or =</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 == 1       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 = 1        --&gt; true  (= and == are the same thing)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 == 1       --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Note that null is not equal to anything (like SQL)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null == 1    --&gt; null (hence not true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null == null --&gt; null (hence not true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; == &quot;x&quot;   --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- IS lets you compare against null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 IS 1       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 IS 1       --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null IS 1    --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null IS null --&gt; true  (Unknown is Unknown?  Yes it is!)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; IS &quot;x&quot;   --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- x IS NOT y is the same as NOT (x IS y)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 IS NOT 1       --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 IS NOT 1       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null IS NOT 1    --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null IS NOT null --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;x&quot; IS NOT &quot;x&quot;   --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Inequality is != or &lt;&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 != 1       --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt;&gt; 1       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null != 1    --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null &lt;&gt; null --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- More comparisons</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 &lt; 10    --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 &gt; 10    --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt;= 2    --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 &gt;= 2    --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">10 &lt; null --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- To test if a value is in a range</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 &lt; 2 and 2 &lt; 3  --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 &lt; 3 and 3 &lt; 2  --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- BETWEEN makes this look nicer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">2 between 1 and 3 --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">3 between 2 and 2 --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Strings are created with &quot;x&quot; or &#x27;x&#x27;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;This is a string.\n&quot;           -- can have C style escapes (no embedded nulls)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Th\x69s is a string.\n&quot;        -- even hex literals</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">&#x27;This isn&#x27;&#x27;t a C style string&#x27;  -- use &#x27;&#x27; to escape single quote ONLY</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 2. Simple Variables</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL can call simple libc methods with a no-check declaration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- we&#x27;ll need this for later examples so we can do something</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- with our expressions (i.e. print them)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare procedure printf no check;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">call printf(&quot;I&#x27;m CQL. Nice to meet you!\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Variables are declared with DECLARE.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Keywords and identifiers are not case sensitive.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare x integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can call it X, it is the same thing.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set X := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- All variables begin with a null value if allowed, else a zero value.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare y integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if y == 0 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Yes, this will run.\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A nullable variable (i.e. not marked with not null) is initialized to null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare z real;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if z is null then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Yes, this will run.\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The various types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_blob blob;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_string text;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_real real;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_int integer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_object object;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- There are some typical SQL synonyms</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare an_int int;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long integer;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long int;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare a_long long_int;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The basic types can be tagged to make them less miscible</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare m real&lt;meters&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare kg real&lt;kilos&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set m := kg;  -- error!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Object variables can also be tagged so that they are not mixed-up easily</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare dict object&lt;dict&gt; not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare list object&lt;list&gt; not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set dict := create_dict();  -- an external function that creates a dict</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set dict := create_list();  -- error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set list := create_list();  -- ok</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set list := dict;           -- error</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Implied type initialization</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET i := 1;      -- integer not null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET l := 1L;     -- long not null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET t := &quot;x&quot;;    -- text not null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET b := x IS y; -- bool not null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET b := x = y;  -- bool (maybe not null depending on x/y)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The psuedo function &quot;nullable&quot; converts the type of its arg to the nullable</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- version of the same thing.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET n_i := nullable(1);   -- nullable integer variable initialized to 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">LET l_i := nullable(1L);  -- nullable long variable initialized to 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 3. Control Flow</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Just make a variable</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare some_var integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set some_var := 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Here is an IF statement</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if some_var &gt; 10 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is totally bigger than 10.\n&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else if some_var &lt; 10 then  -- else if is optional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is smaller than 10.\n&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">else -- else is optional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;some_var is indeed 10.\n&quot;)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- WHILE loops iterate as usual</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use LEAVE to end a loop early</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 500</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if i &gt;= 5 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     -- we are not going to get anywhere near 500</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     leave;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use CONTINUE to go back to the loop test</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare i integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set i := 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">while i &lt; 500</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   set i := i + 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if i % 2 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     -- Note: we to do this after &quot;i&quot; is incremented!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     -- to avoid an infinite loop</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     continue;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   -- odd numbers will not be printed because of continue above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   call printf(&quot;%d\n&quot;, i);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> /**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 4. Complex Expression Forms</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> -- Case is an expression, so it is more like the C &quot;?:&quot; operator</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> -- than a switch statement.  It is like &quot;?:&quot; on steroids.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> case i              -- a switch expression is optional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   when 1 then &quot;one&quot; -- one or more cases</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   when 2 then &quot;two&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   else &quot;other&quot;      -- else is optional</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Case with no common expression is a series of independent tests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">case</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   when i == 1 then &quot;i = one&quot;   -- booleans could be completely unrelated</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   when j == 2 then &quot;j = two&quot;   -- first match wins</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   else &quot;other&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- If nothing matches the cases, the result is null.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following expression yields null because 7 is not 1.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">case 7 when 1 then &quot;one&quot; end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Case is just an expression, so it can nest</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">case X</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  when 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case y when 1 &quot;x:1 y:1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">           else &quot;x:1 y:other&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    case when z == 1 &quot;x:other z:1&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">         else &quot;x:other z:other&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- IN is used to test for membership</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">5 IN (1, 2, 3, 4, 5)  --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7 IN (1, 2)           --&gt; false</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null in (1, 2, 3)     --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null in (1, null, 3)  --&gt; null  (null == null is not true)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">7 NOT IN (1, 2)       --&gt; true</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null not in (null, 3) --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 4. Working with and &quot;getting rid of&quot; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Null can be annoying, you might need a not null value.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- In most operations null is radioactive:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null + x     --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null * x     --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null == null --&gt; null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- IS and IS NOT always return 0 or 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">null is 1     -&gt; 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">1 is not null -&gt; 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- COALESCE returns the first non null arg, or the last arg if all were null.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- If the last arg is not null, you get a non null result for sure.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following is never null, but it&#x27;s false if either x or y is null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">COALESCE(x==y, false) -&gt; thought excercise: how is this different than x IS y?</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- IFNULL is coalesce with 2 args only (COALESCE is more general)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">IFNULL(x, -1) --&gt; use -1 if x is null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The reverse, NULLIF, converts a sentinel value to unknown, more exotic</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">NULLIF(x, -1) --&gt; if x is -1 then use null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- the else part of a case can get rid of nulls</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CASE when x == y then 1 else 0 end;  --&gt; true iff x = y and neither is null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- CASE can be used to give you a default value after various tests</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The following expression is never null; &quot;other&quot; is returned if x is null.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">CASE when x &gt; 0 then &quot;pos&quot; when x &lt; 0 then &quot;neg&quot; else &quot;other&quot; end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can &quot;throw&quot; out of the current procedure (see exceptions below)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare x integer not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set x := ifnull_throw(nullable_int_expr); -- returns non null, throws if null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- If you have already tested the expression then control flow analysis</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- improves its type to &quot;not null&quot;.  Many common check patterns are recognized.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if nullable_int_expr is not null then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- nullable_int_expression is known to be not null in this context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set x := nullable_int_expr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 5. Tables, Views, Indices, Triggers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Most forms of data definition language DDL are supported.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;Loose&quot; DDL (outside of any procedure) simply declares</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- schema, it does not actually create it; the schema is assumed to</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- exist as you specified.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table T1(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  t text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  r real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create table T2(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id integer primary key references T1(id),</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  l long,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  b blob</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL can take a series of schema declarations (DDL) and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- automatically create a procedure that will materialize</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- that schema and even upgrade previous versions of the schema.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- This system is discussed in Chapter 10 of The Guide.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- To actually create tables and other schema you need</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- procedures that look like the below:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc make_tables()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  create table T1 if not exists (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    id integer primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    t text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    r real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  );</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Views are supported</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create view V1 as (select * from T1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Triggers are supported</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create trigger if not exists trigger1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  before delete on T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  delete from T2 where id = old.id;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Indices are supported</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create index I1 on T1(t);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create index I2 on T1(r);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The various drop forms are supported</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drop index I1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drop index I2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drop view V1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drop table T2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">drop table T1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A complete discussion of DDL is out of scope, refer to sqlite.org</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 6. Selecting Data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- We will use this scratch variable in the following examples</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare rr real;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- First observe CQL is a two-headed language</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := 1+1;           -- this is evaluated in generated C code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := (select 1+1);  -- this expresion goes to SQLite; SQLite does the addition</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- CQL tries to do most things the same as SQLite in the C context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- but some things are exceedingly hard to emulate correctly.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Even simple looking things such as:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := (select cast(&quot;1.23&quot; as real));   --&gt;  rr := 1.23</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set rr := cast(&quot;1.23&quot; as real);            --&gt;  error (not safe to emulate SQLite)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- In general, numeric/text conversions have to happen in SQLite context</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- because the specific library that does the conversion could be and usually</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- is different than the one CQL would use.  It would not do to give different answers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- in one context or another so those conversions are simply not supported.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Loose concatenation is not supported because of the implied conversions.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Loose means &quot;not in the context of a SQL statement&quot;.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := 1.23;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select cast(&quot;100&quot;||r as real));  --&gt; 1001.23 (a number)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := cast(&quot;100&quot;||r as real);  --&gt; error, concat not supported in loose expr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A simple insertion</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into T1 values (1, &quot;foo&quot;, 3.14);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Finally, reading from the database</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1 where id = 1);  --&gt; r = 3.14</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The (select ...) form requires the result to have at least one row.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can use IF NOTHING forms to handle other cases such as:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          where id = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if nothing -1);  --&gt; r = -1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- If the SELECT statement might return a null result you can handle that as well</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          where id = 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">          if nothing or null -1);  --&gt; r = -1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- With no IF NOTHING clause, lack of a row will cause the SELECT expression to throw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- an exception.  IF NOTHING THROW merely makes this explicit.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set r := (select r from T1 where id = 2 if nothing throw);  --&gt; will throw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 6. Procedures, Results, Exceptions</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures are a list of statements that can be executed, with arguments.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc hello()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;Hello, world\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- IN, OUT, and INOUT parameters are possible</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc swizzle(x integer, inout y integer, out z real not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set y := x + y;  -- any computation you like</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- bizarre way to compute an id but this is just an illustration</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set z := (select r from T1 where id = x if nothing or null -1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures like &quot;hello&quot; (above) have a void signature -- they return nothing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- as nothing can go wrong. Procedures that use the database like &quot;swizzle&quot; (above)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- can return an error code if there is a problem.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;will_fail&quot; (below)  will always return SQLITE_CONSTRAINT, the second insert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- is said to &quot;throw&quot;.  In CQL exceptions are just result codes.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc will_fail()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   insert into T1 values (1, &quot;x&quot;, 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   insert into T1 values (1, &quot;x&quot;, 1);  --&gt; duplicate key</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- DML that fails generates an exception and</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- exceptions can be caught. Here is a example:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  id_ integer primary key,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  t_ text,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  r_ real</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- try to insert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1(id, t, r) values (id_, t_, r_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- if the insert fails, try to update</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    update T1 set t = t_, r = r_ where id = id_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes can be very useful in avoiding boilerplate code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- the following is equivalent to the above.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- More on shapes later.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1 from arguments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    update T1 set t = t_, r = r_ where id = id_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can (re)throw an error explicitly.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- If there is no current error you get SQLITE_ERROR</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_wrapper(LIKE t1) -- my args are the same as the columns of T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if r_ &gt; 10 then throw end if; -- throw if r_ is too big</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call upsert_t1(from arguments);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Procedures can also produce a result set.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The compiler generates the code to create this result set</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- and helper functions to read rows out of it.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc get_low_r(r_ real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   -- optionally insert some rows or do other things</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   select * from T1 where T1.r &lt;= r_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A procedure can choose between various results, the choices must be compatible.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The last &quot;select&quot; to run controls the ultimate result.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc get_hi_or_low(r_ real, hi_not_low bool not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- trying to do this with one query would result in a poor plan, so</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- instead we use two economical queries.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if hi_not_low then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    select * from T1 where T1.r &gt;= r_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    select * from T1 where T1.r &lt;= r_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Using IF to create to nice selects above is a powerful thing.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- SQLite has no IF, if we tried to create a shared query we get</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- something that does not use indices at all.  As in the below.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The two-headed CQL beast has its advantages!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">select * from T1 where case hi_not_low then T1.r &gt;= r_ else T1.r &lt;= r_ end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can get the current return code and use it in your CATCH logic.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- This upsert is a bit better than the first:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc upsert_t1(LIKE t1) -- my args are the same as the columns of T1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin try</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    insert into T1 from arguments</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end try;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin catch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if @rc == 19 /* SQLITE_CONSTRAINT */ then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      update T1 set t = t_, r = r_ where id = id_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    else</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      throw;  -- rethrow, something bad happened.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end catch;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- By convention, you can call a procedure that has an OUT argument</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- as its last argument using function notation.  The out argument</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- is used as the return value.   If the called procedure uses the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- database then it could throw which causes the caller to throw</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- as usual.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc fib(n integer not null, out result integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   set result := case n &lt;= 2 then 1 else fib(n-1) + fib(n-2) end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 7. Statement Cursors</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Statement cursors let you iterate over a select result.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Here we introduce cursors, LOOP and FETCH.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc count_t1(r_ real, out rows_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare rows integer not null;  -- starts at zero guaranteed</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor for select * from T1 where r &lt; r_;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  loop fetch C -- iterate until fetch returns no row</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- goofy code to illustrate you can process the cursor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- in whatever way you deem appropriate</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if C.r &lt; 5 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      rows := rows + 1; -- count rows with C.r &lt; 5</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set rows_ := rows;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Cursors can be tested for presence of a row</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- and they can be closed before the enumeration is finished.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- As before the below is somewhat goofy example code.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc peek_t1(r_ real, out rows_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   /* rows_ is set to zero for sure! */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   declare C cursor for select * from T1 where r &lt; r_ limit 2;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   open C;  -- this is no-op, present because other systems have it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   fetch C;  -- fetch might find a row or not</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   if C then  -- cursor name as bool indicates presence of a row</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     set rows_ = rows_ + (C.r &lt; 5);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     fetch C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     set rows_ = rows_ + (C and C.r &lt; 5);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   close C;  -- cursors auto-closed at end of method but early close possible</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The FETCH...INTO form can be used to fetch directly into variables</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C into id_, t_, r_;  --&gt; loads named locals instead of C.id, C.t, C.r</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A procedure can be the source of a cursor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor for call get_low_r(3.2);  -- valid cursor source</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- OUT can be used to create a result set that is just one row</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc one_t1(r_ real)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   declare C cursor for select * from T1 where r &lt; r_ limit 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   fetch C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   out C;  -- emits a row if we have one, no row is ok too, empty result set.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 8. Value Cursors, Out, and Out Union</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- To consume a procedure that uses &quot;out&quot; you can declare a value cursor.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- By itself such as cursor does not imply use of the database, but often</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- the source of the cursor uses the database.  In this example</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- consume_one_t1 uses the database because of the call to one_t1.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc consume_one_t1()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- a cursor whose shape matches the one_t1 &quot;out&quot; statement</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like one_t1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it from the call</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if C.r &gt; 10 then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- use values as you see fit</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;woohoo&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can do the above in one step with the compound form:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor fetch from call one_t1(7); -- declare and fetch</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Value cursors can come from anywhere and can be a procedure result</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc use_t1_a_lot()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- T1 is the same shape as one_t1, this will work, too</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like T1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);  -- load it from the call</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- some arbitrary logic might be here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load C again with different args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(12);   -- load it again</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- some arbitrary logic might be here</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- now load C yet again with explicit args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     1 id,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;foo&quot; t,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     8.2 r;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- now return it</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  out C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Make a complex result set one row at a time</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc out_union_example()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- T1 is the same shape as one_t1, this will work, too</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like T1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it from the call</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(7);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- note out UNION rather than just out, indicating potentially many rows</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- load it again with different args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from call one_t1(12);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- do something, then maybe load it again with explicit args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C using</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     1 id,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     &quot;foo&quot; t,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">     8.2 r;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  out union C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- we have generated a 3 row result set</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Consume the above</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc consume_result()</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor for call out_union_example();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  loop fetch C</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- use builtin cql_cursor_format to make the cursor into a string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 9. Named Types and Enumerations</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Create a simple named types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare my_type type integer not null;   -- make an alias for integer not null</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare i my_type;  -- use it, &quot;i&quot; is an integer</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Mixing in type kinds is helpful</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare distance type real&lt;meters&gt;;  -- e.g., distances to be measured in meters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare time type real&lt;seconds&gt;;     -- e.g., time to be measured in seconds</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare job_id type long&lt;job_id&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare person_id type long&lt;person_id&gt;;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- With the above done</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  * vars/cols of type &quot;distance&quot; are incompatible with those of type &quot;time&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  * vars/cols of types job_id are incompatible with person_id</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- This is true even though the underlying type is the same for both!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- ENUM declarations can have any numeric type as their base type</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare enum implement integer (</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   pencil,       -- values start at 1 unless you use = to choose something</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   pen,          -- the next enum gets previous + 1 as its value (2)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">   brush = 7     -- with = expression you get the indicated value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The above also implicitly does this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare implement type integer&lt;implement&gt; not null;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Using the enum -- simply use dot notation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare impl implement;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">set impl := implement.pen;  -- value &quot;2&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can emit an emum into the current .h file we are going to generate.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Do not put this directive in an include file, you want it to go to one place.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Instead, pick one compiland that will &quot;own&quot; the emission of the enum.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- C code can then #include that one .h file.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">@emit_enums implement;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 10. Shapes and Their Uses</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes first appeared to help define value cursors like so:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A table or view name defines a shape</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor like T1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The result of a proc defines a shape</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare D cursor like one_t1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A dummy select statement defines a shape (the select does not run)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- this one is the same as (x integer not null, y text not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare E cursor like select 1 x, &quot;2&quot; y;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Another cursor defines a shape</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare F cursor like C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The arguments of a procedure define a shape. If you have</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- create proc count_t1(r_ real, out rows_ integer not null) ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- the shape will be:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">--  (r_ real, rows_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare G cursor like count_t1 arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A loaded cursor can be used to make a call</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">call count_t1(from G);  -- the args become G.r_, G.rows_</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- A shape can be used to define a procedures args, or some of the args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- In the following &quot;p&quot; will have arguments:s id_, t_, and r_ with types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- matching table T1.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Note: To avoid ambiguity, an _ was added to each name!</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc p(like T1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- do whatever you like</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The arguments of the current procedure are a synthetic shape</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- called &quot;arguments&quot; and can used where other shapes can appear.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- For instance, you can have &quot;q&quot; shim to &quot;p&quot; using this form:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc q(like T1, print bool not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- maybe pre-process, silly example</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set id_ := id_ + 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- shim to p</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from arguments); -- pass my args through, whatever they are</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- maybe post-process, silly example</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  set r_ := r_ - 1;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if print then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    -- convert args to cursor</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    declare C like q arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    fetch C from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    call printf(&quot;%s\n&quot;, cql_cursor_format(C)); --&gt; prints every column and value</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  end if;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- insert a row based on the args</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  insert into T1 from arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You an use a given shape more than once if you name each use.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- This would be more exciting if T1 was like a &quot;person&quot; or something.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create proc r(a like T1, b like T1)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from a);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call p(from b);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- you can refer to a.id, b.id etc.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C like a;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from a;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;%s\n&quot;, cql_cursor_format(C));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C from b;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  call printf(&quot;%s\n&quot;, cql_cursor_format(C));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Shapes can be subsetted, for instance in the following example</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- only the arguments that match C are used in the FETCH.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C from arguments(like C);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Fetch the columns of D into C using the cursor D for the data source.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Other columns get default values.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like D) from D;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the D shape to load C, dummy values for the others.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- In this example, dummy_seed means use the provided value, 11, for</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- any numerics that are not specified (not in D) and and use</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- &quot;col_name_11&quot; for any strings/blobs.  This pattern is useful in test code</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- to create dummy data, hence the name.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like D) from D @dummy_seed(11);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the Z shape to control which fields are copied.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Use the dummy value even if the field is nullable and null would have be ok.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The above patterns also work for insert statements</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The shape constraints are generally useful.  The dummy data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- sources are useful for inserting test data.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into T1(like Z) from D(like Z) @dummy_seed(11) @dummy_nullables;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- We&#x27;ll need this dummy procedure some_shape so we can use its return</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- value in the examples that follow.  We will never actual create this</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- proc, we only declare it to define the shape, so this is kind of like</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- a typedef.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare proc some_shape() (x integer not null, y integer not null, z integer not null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- You can make a helper procedure to create test args that are mostly constant</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- or computable.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">create get_foo_args(X like some_shape, seed_ integer not null)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">begin</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  declare C cursor like foo arguments;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  -- any way of loading C could work this is one</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  fetch C(like X) from X @dummy_seed(seed_);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  out C;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">end;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Now we can use the &quot;get_foo_args&quot; to get full set of arguments for &quot;foo&quot; and then</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- call &quot;foo&quot; with those arguments.  In this example we&#x27;re providing</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- some of the arguments explicitly, &quot;some_shape&quot; is the part of the args that</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- needs to manually vary in each test iteration, the rest of the arguments will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- be dummy values.  There could be zillions of args in either category.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- In the below &quot;some_shape&quot; is going to get the manual values 1, 2, 3 while 100</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- will be the seed for the dummy args.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare foo_args cursor fetch from call get_foo_args(1,2,3, 100);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">call foo(from foo_args);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">/**********************************************************</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> * 11. INSERT USING and FETCH USING</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> *********************************************************/</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> -- This kind of thing is a pain</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> insert into foo(a, b, c, d, e, f, g)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    values(1, 2, 3, null, null, 5, null);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- Instead, write this form:</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">insert into foo USING</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    1 a, 2 b, 3 c, null d, null e, 5 f, null g;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">-- The FETCH statement can also be &quot;fetch using&quot;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">declare C cursor like foo;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">fetch C USING</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    1 a, 2 b, 3 c, null d, null e, 5 f, null g;</span></div></div></div></div></div><p>If you&#x27;ve read this far you know more than most now.  :)</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2022-05-17T02:45:13.000Z" class="docLastUpdatedAt_217_">5/17/2022</time> by <strong>Artur Kotyrba</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/x5"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Appendix 5: JSON Schema Grammar</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cql-guide/x7"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Appendix 7: CQL Anti-patterns Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.58a786a3.js"></script>
<script src="/runtime~main.ad59d5b8.js"></script>
<script src="/main.8da86549.js"></script>
<script src="/1.fae5e295.js"></script>
<script src="/2.0eb37f9a.js"></script>
<script src="/3.5c2742cc.js"></script>
<script src="/1be78505.bc52d199.js"></script>
<script src="/106.5c1aa3b0.js"></script>
<script src="/5456faf3.c3a29041.js"></script>
<script src="/17896441.5a19be7f.js"></script>
<script src="/000c2429.6896fa8e.js"></script>
</body>
</html>