<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Part 5: CQL Runtime | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Part 5: CQL Runtime | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/int05"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/int05"><link rel="stylesheet" href="/styles.4959ceee.css">
<link rel="preload" href="/styles.e54db292.js" as="script">
<link rel="preload" href="/runtime~main.1a63f7ab.js" as="script">
<link rel="preload" href="/main.21e711ec.js" as="script">
<link rel="preload" href="/1.758a42c5.js" as="script">
<link rel="preload" href="/2.990c43e6.js" as="script">
<link rel="preload" href="/3.8628cb86.js" as="script">
<link rel="preload" href="/1be78505.88e5f619.js" as="script">
<link rel="preload" href="/104.d7416c6e.js" as="script">
<link rel="preload" href="/5456faf3.9db1209e.js" as="script">
<link rel="preload" href="/17896441.203c8fa2.js" as="script">
<link rel="preload" href="/98823275.f50cbbe3.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch05">Chapter 5: Types of Cursors, Shapes, OUT and OUT UNION, and FETCH</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x9">Appendix 9: Using the CQL Amalgam</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x10">Appendix 10: CQL Working Example</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x11">Appendix 11: Production Considerations</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">CQL Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int01">Part 1: Lexing, Parsing, and the AST</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int02">Part 2: Semantic Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int03">Part 3: C Code Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int04">Part 4: Testing</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/int05">Part 5: CQL Runtime</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int06">Part 6: Schema Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int07">Part 7: JSON Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int08">Part 8: Test Helpers</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Part 5: CQL Runtime</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="preface"></a>Preface<a aria-hidden="true" tabindex="-1" class="hash-link" href="#preface" title="Direct link to heading">#</a></h3><p>Part 5 continues with a discussion of the essentials of the CQL Runtime.
As in the previous sections, the goal here is not to go over every detail but rather to give
a sense of how the runtime works in general -- the core strategies and implementation choices --
so that when reading the source you will have an idea how it all hangs together. To accomplish
this, we&#x27;ll illustrate the key pieces that can be customized and we&#x27;ll discuss some
interesting cases.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="cql-runtime"></a>CQL Runtime<a aria-hidden="true" tabindex="-1" class="hash-link" href="#cql-runtime" title="Direct link to heading">#</a></h2><p>The parts of the runtime that you can change are in <code>cqlrt.h</code>, that file invariably ends by including
<code>cqlrt_common.h</code> which are the runtime parts that you shouldn&#x27;t change.  Of course this is open source
so you can change anything, but the common things usually don&#x27;t need to change -- <code>cqlrt.h</code> should
provide you with everything you need to target new environments.</p><p>The compiler itself can be customized see <code>rt.c</code> to emit different strings to work with your runtime.
This is pretty easy to do without creating a merge hell for yourself. Meta Platforms, for instance,  has its
own CQL runtime customized for use on phones that is not open source (and really I don&#x27;t think anyone
would want it anyway).  But the point is that you can make your own. In fact I know of two just within
Meta Platforms.</p><p>We&#x27;ll go over <code>cqlrt.h</code> bit by bit.  Keeping in mind it might change but this is
essentially what&#x27;s going on.  And the essentials don&#x27;t change very often.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="standard-headers"></a>Standard headers<a aria-hidden="true" tabindex="-1" class="hash-link" href="#standard-headers" title="Direct link to heading">#</a></h3><p>The rest of the system will use these, <code>cqlrt.h</code> is responsible for bringing in what you need
later, or what <code>cqlrt_common.h</code> needs on your system.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma once</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;assert.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stddef.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;stdint.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;math.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &lt;sqlite3.h&gt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef __clang__</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifndef _Nonnull</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    /* Hide Clang-only nullability specifiers if not Clang */</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define _Nonnull</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    #define _Nullable</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="contract-and-error-macros"></a>Contract and Error Macros<a aria-hidden="true" tabindex="-1" class="hash-link" href="#contract-and-error-macros" title="Direct link to heading">#</a></h3><p>CQL has a few different macros it uses for errors.  <code>contract</code>, <code>invariant</code>, and <code>tripwire</code>
usually all map to <code>assert</code>.  Note that <code>tripwire</code> doesn&#x27;t have to be fatal, it can log
in production and continue.  This is a &quot;softer&quot; assertion.  Something that you&#x27;re trying out
that you&#x27;d like to be a <code>contract</code> but maybe there are lingering cases that have to be fixed
first.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_contract assert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_invariant assert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_tripwire assert</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_log_database_error(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_error_trace()</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-value-types"></a>The Value Types<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-value-types" title="Direct link to heading">#</a></h3><p>You can define these types to be whatever is appropriate on your system.
Usually the mapping is pretty obvious.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// value types</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef unsigned char cql_bool;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_true (cql_bool)1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_false (cql_bool)0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef unsigned long cql_hash_code;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef int32_t cql_int32;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef uint32_t cql_uint32;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef uint16_t cql_uint16;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef sqlite3_int64 cql_int64;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef double cql_double;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef int cql_code;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-reference-types"></a>The Reference Types<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-reference-types" title="Direct link to heading">#</a></h3><p>The default runtime first defines 4 types of reference objects.
These are the only reference types that CQL creates itself. In
fact CQL doesn&#x27;t actually create <code>CQL_C_TYPE_OBJECT</code> but the tests
do.  CQL never creates raw object things, only external functions
can do that.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// metatypes for the straight C implementation</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_C_TYPE_STRING 0</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_C_TYPE_BLOB 1</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_C_TYPE_RESULTS 2</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_C_TYPE_BOXED_STMT 3</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_C_TYPE_OBJECT 4</span></div></div></div></div></div><p>All the reference types are reference counted. So they
need a simple shape that allows them to know their own
type and have a count.  They also have a finalize method
to clean up their memory when the count goes to zero.</p><p>You get to define <code>cql_type_ref</code> to be whatever you want.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// base ref counting struct</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_type *cql_type_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_type {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int type;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  int ref_count;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void (*_Nullable finalize)(cql_type_ref _Nonnull ref);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_type;</span></div></div></div></div></div><p>Whatever you do with the types you&#x27;ll need to define
a retain and release method that uses them as the signature.
Normal references should have a generic value comparison and a hash.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">void cql_retain(cql_type_ref _Nullable ref);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">void cql_release(cql_type_ref _Nullable ref);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_hash_code cql_ref_hash(cql_type_ref _Nonnull typeref);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bool cql_ref_equal(cql_type_ref _Nullable typeref1, cql_type_ref _Nullable typeref2);</span></div></div></div></div></div><p>Now each of the various kinds of reference types needs an
object which probably includes the base type above.  It doesn&#x27;t
have to.  You can arrange for some other universal way to do
these.  On iOS these can be easily mapped to <code>CF</code> types.</p><p>The <code>retain</code> and <code>release</code> macros should all map to the same thing.
The compiler emits different variations for readability only. It
doesn&#x27;t really work if they don&#x27;t have common retain/release
semantics.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// builtin object</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_object *cql_object_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_object {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_type base;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const void *_Nonnull ptr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_object;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_object_retain(object) cql_retain((cql_type_ref)object);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_object_release(object) cql_release((cql_type_ref)object);</span></div></div></div></div></div><p>Boxed statement gets its own implementation, same as object.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-undefined codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// builtin statement box</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_boxed_stmt *cql_boxed_stmt_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_boxed_stmt {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_type base;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  sqlite3_stmt *_Nullable stmt;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_boxed_stmt;</span></div></div></div></div></div><p>Same for blob, and blob has a couple of additional helper macros
that are used to get information. Blobs also have hash and equality
functions.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// builtin blob</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_blob *cql_blob_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_blob {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_type base;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const void *_Nonnull ptr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_uint32 size;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_blob;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_blob_retain(object) cql_retain((cql_type_ref)object);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_blob_release(object) cql_release((cql_type_ref)object);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_blob_ref _Nonnull cql_blob_ref_new(const void *_Nonnull data, cql_uint32 size);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_get_blob_bytes(data) (data-&gt;ptr)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_get_blob_size(data) (data-&gt;size)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_hash_code cql_blob_hash(cql_blob_ref _Nullable str);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bool cql_blob_equal(cql_blob_ref _Nullable blob1, cql_blob_ref _Nullable blob2);</span></div></div></div></div></div><p>Strings are the same as the others but they have many more functions
associated with them.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// builtin string</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_string *cql_string_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_string {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_type base;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  const char *_Nullable ptr;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_string;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_string_ref _Nonnull cql_string_ref_new(const char *_Nonnull cstr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_string_retain(string) cql_retain((cql_type_ref)string);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_string_release(string) cql_release((cql_type_ref)string);</span></div></div></div></div></div><p>The compiler uses this macro to create a named string literal. You decide
how those will be implemented right here.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_string_literal(name, text) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_string name##_ = { \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .base = { \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .type = CQL_C_TYPE_STRING, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .ref_count = 1, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      .finalize = NULL, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    .ptr = text, \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }; \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_string_ref name = &amp;name##_</span></div></div></div></div></div><p>Strings get assorted comparison and hashing functions. Note blob also had a hash.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">int cql_string_compare(cql_string_ref _Nonnull s1, cql_string_ref _Nonnull s2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_hash_code cql_string_hash(cql_string_ref _Nullable str);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bool cql_string_equal(cql_string_ref _Nullable s1, cql_string_ref _Nullable s2);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">int cql_string_like(cql_string_ref _Nonnull s1, cql_string_ref _Nonnull s2);</span></div></div></div></div></div><p>Strings can be converted from their reference form to standard C form. These
macros define how this is done.  Note that temporary allocations are possible
here but the standard implementation does not actually need to do an alloc.  It
stores UTF8 in the string pointer so it&#x27;s ready to go.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_alloc_cstr(cstr, str) const char *_Nonnull cstr = (str)-&gt;ptr</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_free_cstr(cstr, str) 0</span></div></div></div></div></div><p>The macros for result sets have somewhat less flexibility.  The main thing
that you can do here is add additional fields to the &quot;meta&quot; structure.  It
needs those key fields because it is created by the compiler.  However the
API is used to create a result set so that can be any object you like.  It
only has to respond to the <code>get_meta</code>, <code>get_data</code>, and <code>get_count</code> apis.
Those can be mapped as you desire.  In principle there could have been
a macro to create the &quot;meta&quot; as well (a PR for this is welcome) but it&#x27;s
really a pain for not much benefit.  The advantage of defining your own &quot;meta&quot;
is that you can use it to add additional custom APIs to your result set that
might need some storage.</p><p>The additional API <code>cql_result_set_note_ownership_transferred(result_set)</code>
is used in the event that you are moving ownership of the buffers from
out of CQL&#x27;s universe.  So like maybe JNI is absorbing the result, or
Objective C is absorbing the result.  The default implementation is a no-op.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// builtin result set</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_result_set *cql_result_set_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_result_set_meta {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain"> ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">typedef struct cql_result_set {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_type base;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_result_set_meta meta;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_int32 count;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void *_Nonnull data;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">} cql_result_set;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_type_decl(result_set_type, result_set_ref) \</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  typedef struct _##result_set_type *result_set_ref;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_result_set_ref _Nonnull cql_result_set_create(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void *_Nonnull data,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_int32 count,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_result_set_meta meta);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_retain(result_set) cql_retain((cql_type_ref)result_set);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_release(result_set) cql_release((cql_type_ref)result_set);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_note_ownership_transferred(result_set)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_get_meta(result_set) (&amp;((cql_result_set_ref)result_set)-&gt;meta)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_get_data(result_set) ((cql_result_set_ref)result_set)-&gt;data</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_result_set_get_count(result_set) ((cql_result_set_ref)result_set)-&gt;count</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="mocking"></a>Mocking<a aria-hidden="true" tabindex="-1" class="hash-link" href="#mocking" title="Direct link to heading">#</a></h3><p>The CQL run test needs to do some mocking.  This bit is here for that test.  If you
want to use the run test with your version of <code>cqlrt</code> you&#x27;ll need to define a
shim for <code>sqlite3_step</code> that can be intercepted.  This probably isn&#x27;t going to come up.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#ifdef CQL_RUN_TEST</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define sqlite3_step mockable_sqlite3_step</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">SQLITE_API cql_code mockable_sqlite3_step(sqlite3_stmt *_Nonnull);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#endif</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="profiling"></a>Profiling<a aria-hidden="true" tabindex="-1" class="hash-link" href="#profiling" title="Direct link to heading">#</a></h3><p>If you want to support profiling you can implement <code>cql_profile_start</code> and <code>cql_profile_stop</code>
to do whatever you want.  The CRC uniquely identifies a procedure (you can log that).  The
<code>index</code> provides you with a place to store something that you can use as a handle in
your logging system.  Typically an integer.  This lets you assign indices to the procedures
you actually saw in any given run and then log them or something like that.  No data
about parameters is provided, this is deliberate.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// No-op implementation of profiling</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// * Note: we emit the crc as an expression just to be sure that there are no compiler</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   errors caused by names being incorrect.  This improves the quality of the CQL</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   code gen tests significantly.  If these were empty macros (as they once were)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">//   you could emit any junk in the call and it would still compile.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_profile_start(crc, index) (void)crc; (void)index;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define cql_profile_stop(crc, index)  (void)crc; (void)index;</span></div></div></div></div></div><p>The definitions in <code>cqlrt_common.c</code> can provide codegen than either has generic
&quot;getters&quot; for each column type (useful for JNI) or produces a unique getter that isn&#x27;t
shared.  The rowset metadata will include the values for <code>getBoolean</code>, <code>getDouble</code> etc.
if <code>CQL_NO_GETTERS</code> is 0.  Getters are a little slower for C but give you a small number
of functions that need to have JNI if you are targeting Java.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// the basic version doesn&#x27;t use column getters</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define CQL_NO_GETTERS 1</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="encoding-of-sensitive-columns"></a>Encoding of Sensitive Columns<a aria-hidden="true" tabindex="-1" class="hash-link" href="#encoding-of-sensitive-columns" title="Direct link to heading">#</a></h3><p>By setting an attribute on any procedure that produces a result set you can
have the selected sensitive values encoded.  If this happens CQL first asks
for the encoder and then calls the encode methods passing in the encoder.
These aren&#x27;t meant to be cryptograhically secure but rather to provide some
ability to prevent mistakes.  If you opt in, sensitive values have to be deliberately
decoded and that provides an audit trail.</p><p>The default implementation of all this is a no-op.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// implementation of encoding values. All sensitive values read from sqlite db will</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// be encoded at the source. CQL never decode encoded sensitive string unless the</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// user call explicitly decode function from code.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_object_ref _Nullable cql_copy_encoder(sqlite3 *_Nonnull db);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bool cql_encode_bool(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_int32 cql_encode_int32(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_int64 cql_encode_int64(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_double cql_encode_double(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_string_ref _Nonnull cql_encode_string_ref_new(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_blob_ref _Nonnull cql_encode_blob_ref_new(..);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_bool cql_decode_bool(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_int32 cql_decode_int32(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_int64 cql_decode_int64(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_double cql_decode_double(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_string_ref _Nonnull cql_decode_string_ref_new(...);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_blob_ref _Nonnull cql_decode_blob_ref_new(...);</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="boxing-statements"></a>Boxing Statements<a aria-hidden="true" tabindex="-1" class="hash-link" href="#boxing-statements" title="Direct link to heading">#</a></h3><p>You must provide helpers to &quot;box&quot; and &quot;unbox&quot; a SQLite statement
into a <code>cql_ref_type</code> of the appropriate type.  These are used
to create boxed cursors.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_object_ref _Nonnull cql_box_stmt(sqlite3_stmt *_Nullable stmt);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">sqlite3_stmt *_Nullable cql_unbox_stmt(cql_object_ref _Nonnull ref);</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-common-headers"></a>The Common Headers<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-common-headers" title="Direct link to heading">#</a></h3><p>The standard APIs all build on the above, so they should be included last.</p><p>Now in some cases the signature of the things you provide in <code>cqlrt.h</code> is basically fixed,
so it seems like it would be easier to move the prototpyes into <code>cqlrt_common.h</code>.
However, in many cases additional things are needed like <code>declspec</code> or <code>export</code> or
other system specific things.  The result is that <code>cqlrt.h</code> is maybe a bit more
verbose that it strictly needs to be.  Also some versions of cqlrt.h choose to
implement some of the APIs as macros...</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// NOTE: This must be included *after* all of the above symbols/macros.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#include &quot;cqlrt_common.h&quot;</span></div></div></div></div></div><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="the-cqlrt_cf-runtime"></a>The <code>cqlrt_cf</code> Runtime<a aria-hidden="true" tabindex="-1" class="hash-link" href="#the-cqlrt_cf-runtime" title="Direct link to heading">#</a></h3><p>In order to use the Objective-C code-gen (<code>--rt objc</code>) you need a runtime that has reference
types that are friendly to Objective-C.  For this purpose we created an open-source
version of such a runtime: it can be found in the <code>sources/cqlrt_cf</code> directory.
This runtime is also a decent example of how much customization you can do with just
a little code. Some brief notes:</p><ul><li>This runtime really only makes sense on macOS, iOS, or maybe some other place that Core Foundation (<code>CF</code>) exists<ul><li>As such its build process is considerably less portable than other parts of the system</li></ul></li><li>The CQL reference types have been redefined so that they map to:<ul><li><code>CFStringRef</code> (strings)</li><li><code>CFTypeRef</code> (objects)</li><li><code>CFDataRef</code> (blobs)</li></ul></li><li>The key worker functions use <code>CF</code>, e.g.<ul><li><code>cql_ref_hash</code> maps to <code>CFHash</code></li><li><code>cql_ref_equal</code> maps to <code>CFEqual</code></li><li><code>cql_retain</code> uses <code>CFRetain</code> (with a null guard)</li><li><code>cql_release</code> uses <code>CFRelease</code> (with a null guard)</li></ul></li><li>Strings use <code>CF</code> idioms, e.g.<ul><li>string literals are created with <code>CFSTR</code></li><li>C strings are created by using <code>CFStringGetCStringPtr</code> or <code>CFStringGetCString</code> when needed</li></ul></li></ul><p>Of course, since the meaning of some primitive types has changed, the contract to the CQL generated
code has changed accordingly.  For instance:</p><ul><li>procedures compiled against this runtime expect string arguments to be <code>CFStringRef</code></li><li>result sets provide <code>CFStringRef</code> values for string columns</li></ul><p>The consequence of this is that the Objective-C code generation <code>--rt objc</code> finds friendly
contracts that it can freely convert to types like <code>NSString *</code> which results in
seamless integration with the rest of an Objective-C application.</p><p>Of course the downside of all this is that the <code>cqlrt_cf</code> runtime is less portable.  It can only go
where <code>CF</code> exists.  Still, it is an interesting demonstration of the flexablity of the system.</p><p>The system could be further improved by creating a custom result type (e.g. <code>--rt c_cf</code>) and using
some of the result type options for the C code generation. For instance, the compiler could do these things:</p><ul><li>generate <code>CFStringRef foo;</code> instead of <code>cql_string_ref foo;</code> for declarations</li><li>generate <code>SInt32 an_integer</code> instead of <code>cql_int32 an_integer</code></li></ul><p>Even though <code>cqlrt_cf</code> is already mapping <code>cql_int32</code> to something compatible with <code>CF</code>,
making such changes would make the C output a little bit more <code>CF</code> idiomatic. This educational
exercise could probably be completed in just a few minutes by interested readers.</p><p>The <code>make.sh</code> file in the <code>sources/cqlrt_cf</code> directory illustrates how to get CQL to use
this new runtime.  The demo itself is a simple port of the code in <a href="https://cgsql.dev/cql-guide/x10" target="_blank" rel="noopener noreferrer">Appendix 10</a>.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="recap"></a>Recap<a aria-hidden="true" tabindex="-1" class="hash-link" href="#recap" title="Direct link to heading">#</a></h3><p>The CQL runtime, <code>cqlrt.c</code>, is intended to be replaced.  The version that ships with the distribution
is a simple, portable implementation that is single threaded. Serious users of CQL will likely
want to replace the default version of the runtime with something more tuned to their use case.</p><p>Topics covered included:</p><ul><li>contract, error, and tracing macros</li><li>how value types are defined</li><li>how reference types are defined</li><li>mocking (for use in a test suite)</li><li>profiling</li><li>encoding of sensitive columns</li><li>boxing statements</li><li>the <code>cqlrt_cf</code> runtime</li></ul><p>As with the other parts, no attempt was made to cover every detail.  That is
best done by reading the source code.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2022-02-25T22:02:33.000Z" class="docLastUpdatedAt_217_">2/25/2022</time> by <strong>Winnie Quinn</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/int04"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Part 4: Testing</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/cql-guide/int06"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Part 6: Schema Management Â»</div></a></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preface" class="table-of-contents__link">Preface</a></li><li><a href="#cql-runtime" class="table-of-contents__link">CQL Runtime</a><ul><li><a href="#standard-headers" class="table-of-contents__link">Standard headers</a></li><li><a href="#contract-and-error-macros" class="table-of-contents__link">Contract and Error Macros</a></li><li><a href="#the-value-types" class="table-of-contents__link">The Value Types</a></li><li><a href="#the-reference-types" class="table-of-contents__link">The Reference Types</a></li><li><a href="#mocking" class="table-of-contents__link">Mocking</a></li><li><a href="#profiling" class="table-of-contents__link">Profiling</a></li><li><a href="#encoding-of-sensitive-columns" class="table-of-contents__link">Encoding of Sensitive Columns</a></li><li><a href="#boxing-statements" class="table-of-contents__link">Boxing Statements</a></li><li><a href="#the-common-headers" class="table-of-contents__link">The Common Headers</a></li><li><a href="#the-cqlrt_cf-runtime" class="table-of-contents__link">The <code>cqlrt_cf</code> Runtime</a></li><li><a href="#recap" class="table-of-contents__link">Recap</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/metaOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Meta Platforms Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.e54db292.js"></script>
<script src="/runtime~main.1a63f7ab.js"></script>
<script src="/main.21e711ec.js"></script>
<script src="/1.758a42c5.js"></script>
<script src="/2.990c43e6.js"></script>
<script src="/3.8628cb86.js"></script>
<script src="/1be78505.88e5f619.js"></script>
<script src="/104.d7416c6e.js"></script>
<script src="/5456faf3.9db1209e.js"></script>
<script src="/17896441.203c8fa2.js"></script>
<script src="/98823275.f50cbbe3.js"></script>
</body>
</html>