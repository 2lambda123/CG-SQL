<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.65">
<title data-react-helmet="true">Part 8: Test Helpers | CG/SQL</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Part 8: Test Helpers | CG/SQL"><meta data-react-helmet="true" name="description" content="&lt;!---"><meta data-react-helmet="true" property="og:description" content="&lt;!---"><meta data-react-helmet="true" property="og:url" content="https://cgsql.dev/cql-guide/int08"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://cgsql.dev/cql-guide/int08"><link rel="stylesheet" href="/styles.b4d35cce.css">
<link rel="preload" href="/styles.4cc7e11a.js" as="script">
<link rel="preload" href="/runtime~main.6f564f35.js" as="script">
<link rel="preload" href="/main.130a695d.js" as="script">
<link rel="preload" href="/1.3a9ec2a8.js" as="script">
<link rel="preload" href="/2.b42165a9.js" as="script">
<link rel="preload" href="/3.9c3bdf8e.js" as="script">
<link rel="preload" href="/1be78505.655346c0.js" as="script">
<link rel="preload" href="/92.b9f2f94f.js" as="script">
<link rel="preload" href="/5456faf3.d505401c.js" as="script">
<link rel="preload" href="/17896441.25d1d0d8.js" as="script">
<link rel="preload" href="/21c29d6a.c6fee2d7.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/cql-guide/ch01">CQL Guide</a><a class="navbar__item navbar__link" href="/cql-guide/int01">CQL Internals</a><a class="navbar__item navbar__link" href="/program-diagram">Railroad Diagram</a><a class="navbar__item navbar__link" href="/json-diagram">Railroad Diagram: JSON</a><a class="navbar__item navbar__link" href="/blog">Blog</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><strong class="navbar__title">CG/SQL</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/ch01">CQL Guide</a></li><li class="menu__list-item"><a class="menu__link" href="/cql-guide/int01">CQL Internals</a></li><li class="menu__list-item"><a class="menu__link" href="/program-diagram">Railroad Diagram</a></li><li class="menu__list-item"><a class="menu__link" href="/json-diagram">Railroad Diagram: JSON</a></li><li class="menu__list-item"><a class="menu__link" href="/blog">Blog</a></li><li class="menu__list-item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">CQL Guide</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch01">Chapter 1: Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch02">Chapter 2: Using Data</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch03">Chapter 3: Expressions, Literals, Nullability, Sensitivity</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch04">Chapter 4: Procedures, Functions, and Control Flow</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch05">Chapter 5: Types of Cursors, OUT and OUT UNION, and FETCH flavors</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch06">Chapter 6: Calling Procedures Defined Elsewhere</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch07">Chapter 7: CQL Result Sets</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch08">Chapter 8: Functions</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch09">Chapter 9: Statements Summary and Error Checking</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch10">Chapter 10: Schema Management Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch11">Chapter 11: Previous Schema Validation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch12">Chapter 12: Testability Features</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch13">Chapter 13: JSON Output</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/ch14">Chapter 14: CQL Query Fragments</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Appendix</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x1">Appendix 1: Command Line Options</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x2">Appendix 2: CQL Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x3">Appendix 3: Control Directives</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x4">Appendix 4: CQL Error Codes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x5">Appendix 5: JSON Schema Grammar</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x6">Appendix 6: CQL In 20 Minutes</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x7">Appendix 7: CQL Anti-patterns</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x8">Appendix 8: CQL Best Practices</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/cql-guide/x9">Appendix 9: Using the CQL Amalgam</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">CQL Internals</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int01">Part 1: Lexing, Parsing, and the AST</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int02">Part 2: Semantic Analysis</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int03">Part 3: C Code Generation</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int04">Part 4: Testing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int05">Part 5: CQL Runtime</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int06">Part 6: Schema Management</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/cql-guide/int07">Part 7: JSON Generation</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/cql-guide/int08">Part 8: Test Helpers</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Part 8: Test Helpers</h1></header><div class="markdown"><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="preface"></a>Preface<a aria-hidden="true" tabindex="-1" class="hash-link" href="#preface" title="Direct link to heading">#</a></h3><p>Part 8 continues with a discussion of the Test Helper  generation code.
As in the previous sections, the goal here is not to go over every detail but rather to give
a sense of how helpers are created in general -- the core strategies and implementation choices --
so that when reading the source you will have an idea how it all hangs together.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="test-helpers"></a>Test Helpers<a aria-hidden="true" tabindex="-1" class="hash-link" href="#test-helpers" title="Direct link to heading">#</a></h2><p>The testability features are described in <a href="https://cgsql.dev/cql-guide/ch12" target="_blank" rel="noopener noreferrer">Chapter 12</a> of the Guide
So, we won&#x27;t be discussing all the details of what can be created.  Instead we&#x27;re going to go over
the theory of how the generator works. This generator is somewhat different than others in that
it only concerns itself with procedures and only those that have been suitably annotated --
there are large parts of the tree that are of no interest to the test helper logic, including,
importantly the body of procedures.  Only the signature matters.  As we&#x27;ll see there is a fairly
large family of generators that are like this.</p><p>We&#x27;ll have one section for every kind of output, but really only the <code>dummy_test</code> helper is
worthy of detailed discussion the others, as we&#x27;ll see, are very simple.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="initialization"></a>Initialization<a aria-hidden="true" tabindex="-1" class="hash-link" href="#initialization" title="Direct link to heading">#</a></h3><p>The generator is wired like the others with a suitable main, this one is pretty simple:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Main entry point for test_helpers</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">cql_noexport void cg_test_helpers_main(ast_node *head) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Contract(options.file_names_count == 1);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_exit_on_semantic_errors(head);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  exit_on_validating_schema();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_test_helpers_reset_globals();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_OPEN(output_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_th_output = &amp;output_buf;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_output, &quot;%s&quot;, rt-&gt;source_prefix);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_test_helpers_stmt_list(head);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cql_write_file(options.file_names[0], cg_th_output-&gt;ptr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_CLOSE(output_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_test_helpers_reset_globals();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>The text output will be ultimately put into <code>output_buf</code> defined here and <code>helper_flags</code> will track which kinds of helpers
we saw.  This helps us to emit the right sections of output as we&#x27;ll see.</p><p>The code iterates the AST looking at the top level statement list only and in particular looking for <code>CREATE PROC</code>
statements.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Iterate through statement list</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void cg_test_helpers_stmt_list(ast_node *head) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Contract(is_ast_stmt_list(head));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  init_all_trigger_per_table();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  init_all_indexes_per_table();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_OPEN(procs_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_OPEN(decls_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_th_procs = &amp;procs_buf;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_th_decls = &amp;decls_buf;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  for (ast_node *ast = head; ast; ast = ast-&gt;right) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    EXTRACT_STMT_AND_MISC_ATTRS(stmt, misc_attrs, ast);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    if (is_ast_create_proc_stmt(stmt)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      EXTRACT_STRING(proc_name, stmt-&gt;left);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      cg_test_helpers_create_proc_stmt(stmt, misc_attrs);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_output, &quot;%s&quot;, decls_buf.ptr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_output, &quot;\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_output, &quot;%s&quot;, procs_buf.ptr);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_CLOSE(decls_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CHARBUF_CLOSE(procs_buf);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  symtab_delete(all_tables_with_triggers);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  all_tables_with_triggers = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  symtab_delete(all_tables_with_indexes);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  all_tables_with_indexes = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>There are some preliminaries:</p><ul><li>we make a symbol table that maps from tables names to the list of triggers on that table by walking all the triggers</li><li>we make a symbol table that maps from tables names to the list of indices on that table by walking all the indices</li><li>we&#x27;ll need two buffers one for declarations (that must go first) and one for procedure bodies</li><li>each <code>CREATE PROC</code> statement potentially contributes to both sections</li><li><code>cg_test_helpers_create_proc_stmt</code> checks for the helper attributes and sets up the dispatch to emit the test helpers</li></ul><p>To do this we have to walk any misc attributes on the procedure we&#x27;re looking for things of the form <code>@attribute(cql:autotest=xxx)</code></p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void cg_test_helpers_create_proc_stmt(ast_node *stmt, ast_node *misc_attrs) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Contract(is_ast_create_proc_stmt(stmt));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (misc_attrs) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    helper_flags = 0;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dummy_test_infos = symtab_new();</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    find_misc_attrs(misc_attrs, test_helpers_find_ast_misc_attr_callback, stmt);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    symtab_delete(dummy_test_infos);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    dummy_test_infos = NULL;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p><code>find_misc_attrs</code> calls <code>test_helpers_find_ast_misc_attr_callback</code>.  We&#x27;re going to keep track of
which kinds of helpers we have found to help us with the output.  This is where <code>helper_flags</code>
comes in. The flags are:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DUMMY_TABLE           1 // dummy_table attribute flag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DUMMY_INSERT          2 // dummy_insert attribute flag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DUMMY_SELECT          4 // dummy_select attribute flag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DUMMY_RESULT_SET      8 // dummy_result_set attribute flag</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">#define DUMMY_TEST         0x10 // dummy_test attribute flag</span></div></div></div></div></div><p>And now we&#x27;re ready for actual dispatch:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// This is invoked for every misc attribute on every create proc statement</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// in this translation unit.  We&#x27;re looking for attributes of the form cql:autotest=(...)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// and we ignore anything else.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void test_helpers_find_ast_misc_attr_callback(</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CSTR _Nullable misc_attr_prefix,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  CSTR _Nonnull misc_attr_name,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ast_node *_Nullable ast_misc_attr_value_list,</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  void *_Nullable context)</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">{</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  ast_node *stmt = (ast_node *)context;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  Contract(is_ast_create_proc_stmt(stmt));</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (misc_attr_prefix &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      misc_attr_name &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      !Strcasecmp(misc_attr_prefix, &quot;cql&quot;) &amp;&amp;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">      !Strcasecmp(misc_attr_name, &quot;autotest&quot;)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    ...</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>The main dispatch looks like this:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// In principle, any option can be combined with any other but some only make sense for procs with</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// a result.</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">EXTRACT_STRING(autotest_attr_name, misc_attr_value);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (is_autotest_dummy_test(autotest_attr_name)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  cg_test_helpers_dummy_test(stmt);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// these options are only for procs that return a result set</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_result_set(stmt) || has_out_stmt_result(stmt) || has_out_union_stmt_result(stmt)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  if (is_autotest_dummy_table(autotest_attr_name)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    helper_flags |= DUMMY_TABLE;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cg_test_helpers_dummy_table(proc_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  else if (is_autotest_dummy_insert(autotest_attr_name)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    helper_flags |= DUMMY_INSERT;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cg_test_helpers_dummy_insert(proc_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  else if (is_autotest_dummy_select(autotest_attr_name)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    helper_flags |= DUMMY_SELECT;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cg_test_helpers_dummy_select(proc_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  else if (is_autotest_dummy_result_set(autotest_attr_name)) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    helper_flags |= DUMMY_RESULT_SET;</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">    cg_test_helpers_dummy_result_set(proc_name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  }</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>Most of these options are very simple indeed.   <code>cg_test_helpers_dummy_test</code> is the trickiest
by far and we&#x27;ll save it for last, let&#x27;s dispense with the easy stuff.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dummy-table-dummy-insert-dummy-select-dummy-result-set"></a>Dummy Table, Dummy Insert, Dummy Select, Dummy Result Set<a aria-hidden="true" tabindex="-1" class="hash-link" href="#dummy-table-dummy-insert-dummy-select-dummy-result-set" title="Direct link to heading">#</a></h3><p>All of these are a very simple template.  The language includes just the right features
to emit these procedures as nearly constant strings. The <code>LIKE</code> construct was literally
designed to make these patterns super simple.  You can see all the patterns
in <a href="https://cgsql.dev/cql-guide/ch12" target="_blank" rel="noopener noreferrer">Chapter 12</a> but let&#x27;s look at the code for
the first one.  This is &quot;dummy table&quot;.</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-C codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Emit an open proc which creates a temp table in the form of the original proc</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">// Emit a close proc which drops the temp table</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">static void cg_test_helpers_dummy_table(CSTR name) {</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;CREATE PROC open_%s()\n&quot;, name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;BEGIN\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;  CREATE TEMP TABLE test_%s(LIKE %s);\n&quot;, name, name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;END;\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;CREATE PROC close_%s()\n&quot;, name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;BEGIN\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;  DROP TABLE test_%s;\n&quot;, name);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">  bprintf(cg_th_procs, &quot;END;\n&quot;);</span></div><div class="token-line" style="color:#bfc7d5"><span class="token plain">}</span></div></div></div></div></div><p>The purpose of this is to create helper functions that can create a temporary
table with the same columns in it as the procedure you are trying to mock.
You can then select rows out of that table (with <code>dummy_select</code>) or insert
rows into the table (with <code>dummy_insert</code>).  Or you can make a single
row result set (often enough) with <code>dummy_result_set</code>.</p><p>As we can see we simply prepend <code>open_</code> to the procedure name and use
that to create a test helper that make the temporary table.  The table&#x27;s
columns are defined to be <code>LIKE</code> the result shape of the procedure under
test.  Recall this helper is only available to procedures that return a result set.
The temporary table gets a <code>test_</code> prefix.  Assuming the procedure with the
annotation is <code>foo</code> then this code is universal:</p><div class="mdxCodeBlock_1XEh"><div class="codeBlockContent_1u-d"><button type="button" aria-label="Copy code to clipboard" class="copyButton_10dd">Copy</button><div tabindex="0" class="prism-code language-sql codeBlock_3iAC"><div class="codeBlockLines_b7E3" style="color:#bfc7d5;background-color:#292d3e"><div class="token-line" style="color:#bfc7d5"><span class="token keyword" style="font-style:italic">CREATE</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TEMP</span><span class="token plain"> </span><span class="token keyword" style="font-style:italic">TABLE</span><span class="token plain"> test_foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">(</span><span class="token operator" style="color:rgb(137, 221, 255)">LIKE</span><span class="token plain"> foo</span><span class="token punctuation" style="color:rgb(199, 146, 234)">)</span><span class="token punctuation" style="color:rgb(199, 146, 234)">;</span></div></div></div></div></div><p>Is universal, no matter the result shape of <code>foo</code> you get a table with those columns.</p><p>For this to work we need to emit a declaration of <code>foo</code> before this code.  However,
since we have the full definition of <code>foo</code> handy that is no problem.  We remember
that we&#x27;ll need it by setting a flag in <code>helper_flags</code>.</p><p>The code for <code>close_foo</code> is even simpler if that&#x27;s possible.  The great thing is
all need to know the columns of <code>foo</code> has been removed from the test helper.  The
CQL compiler handles this as a matter of course and it is generally useful.
See <a href="https://cgsql.dev/cql-guide/ch05#reshaping-data-cursor-like-forms" target="_blank" rel="noopener noreferrer">Chapter 5</a>
for more examples.</p><p>All the others are equally simple and use similar tricks.  These were the first
test helpers.  They&#x27;re actually not that popular because they are so easy to create
yourself anyway.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="dummy-test"></a>Dummy Test<a aria-hidden="true" tabindex="-1" class="hash-link" href="#dummy-test" title="Direct link to heading">#</a></h3><p>the hard stuff...</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"></div><div class="col text--right"><em><small>Last updated on <time datetime="2021-10-11T23:32:10.000Z" class="docLastUpdatedAt_217_">10/11/2021</time> by <strong>rebecca-zieber</strong></small></em></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/cql-guide/int07"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Part 7: JSON Generation</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#preface" class="table-of-contents__link">Preface</a></li><li><a href="#test-helpers" class="table-of-contents__link">Test Helpers</a><ul><li><a href="#initialization" class="table-of-contents__link">Initialization</a></li><li><a href="#dummy-table-dummy-insert-dummy-select-dummy-result-set" class="table-of-contents__link">Dummy Table, Dummy Insert, Dummy Select, Dummy Result Set</a></li><li><a href="#dummy-test" class="table-of-contents__link">Dummy Test</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Learn</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/introduction">Getting Started</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://www.youtube.com/channel/UC2lTapw2Um90sZpGQVaynEg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Youtube</a></li><li class="footer__item"><a href="https://twitter.com/fbOpenSource" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebookincubator/CG-SQL" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Legal</h4><ul class="footer__items"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy</a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms</a></li></ul></div></div><div class="text--center"><div class="margin-bottom--sm"><a href="https://opensource.facebook.com" target="_blank" rel="noopener noreferrer" class="footerLogoLink_1zJy"><img class="footer__logo" alt="Facebook Open Source Logo" src="/img/oss_logo.png"></a></div><div>Copyright Â© 2021 Facebook, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.4cc7e11a.js"></script>
<script src="/runtime~main.6f564f35.js"></script>
<script src="/main.130a695d.js"></script>
<script src="/1.3a9ec2a8.js"></script>
<script src="/2.b42165a9.js"></script>
<script src="/3.9c3bdf8e.js"></script>
<script src="/1be78505.655346c0.js"></script>
<script src="/92.b9f2f94f.js"></script>
<script src="/5456faf3.d505401c.js"></script>
<script src="/17896441.25d1d0d8.js"></script>
<script src="/21c29d6a.c6fee2d7.js"></script>
</body>
</html>