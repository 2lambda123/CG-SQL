"use strict";(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[386],{3905:function(e,t,a){a.r(t),a.d(t,{MDXContext:function(){return u},MDXProvider:function(){return p},mdx:function(){return b},useMDXComponents:function(){return d},withMDXComponents:function(){return m}});var n=a(67294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(){return o=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var a=arguments[t];for(var n in a)Object.prototype.hasOwnProperty.call(a,n)&&(e[n]=a[n])}return e},o.apply(this,arguments)}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function i(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var u=n.createContext({}),m=function(e){return function(t){var a=d(t.components);return n.createElement(e,o({},t,{components:a}))}},d=function(e){var t=n.useContext(u),a=t;return e&&(a="function"==typeof e?e(t):i(i({},t),e)),a},p=function(e){var t=d(e.components);return n.createElement(u.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,l=e.parentName,u=s(e,["components","mdxType","originalType","parentName"]),m=d(a),p=r,h=m["".concat(l,".").concat(p)]||m[p]||c[p]||o;return a?n.createElement(h,i(i({ref:t},u),{},{components:a})):n.createElement(h,i({ref:t},u))}));function b(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,l=new Array(o);l[0]=h;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var u=2;u<o;u++)l[u]=a[u];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},28624:function(e,t,a){a.r(t),a.d(t,{assets:function(){return m},contentTitle:function(){return s},default:function(){return c},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return d}});var n=a(83117),r=a(80102),o=(a(67294),a(3905)),l=["components"],i={slug:"virtual-table-into",title:"Introducing Virtual Tables",author:"CG/SQL Team",author_title:"Maintainer of CG/SQL",author_url:"https://github.com/facebookincubator",author_image_url:"https://avatars2.githubusercontent.com/u/69631?s=200&v=4",tags:["facebook","cg-sql"]},s=void 0,u={permalink:"/blog/virtual-table-into",editUrl:"https://github.com/facebookincubator/CG-SQL/edit/master/website/blog/blog/2020-12-16-virtual-table-intro.md",source:"@site/blog/2020-12-16-virtual-table-intro.md",title:"Introducing Virtual Tables",description:"Language support for virtual tables has lagged since I always thought they were of little interest to",date:"2020-12-16T00:00:00.000Z",formattedDate:"December 16, 2020",tags:[{label:"facebook",permalink:"/blog/tags/facebook"},{label:"cg-sql",permalink:"/blog/tags/cg-sql"}],readingTime:4.205,hasTruncateMarker:!1,authors:[{name:"CG/SQL Team",title:"Maintainer of CG/SQL",url:"https://github.com/facebookincubator",imageURL:"https://avatars2.githubusercontent.com/u/69631?s=200&v=4"}],frontMatter:{slug:"virtual-table-into",title:"Introducing Virtual Tables",author:"CG/SQL Team",author_title:"Maintainer of CG/SQL",author_url:"https://github.com/facebookincubator",author_image_url:"https://avatars2.githubusercontent.com/u/69631?s=200&v=4",tags:["facebook","cg-sql"]},prevItem:{title:"Introducing Named Types",permalink:"/blog/named-types-into"},nextItem:{title:"Introducing  Argument Bundles",permalink:"/blog/arg-bungle-intro"}},m={authorsImageUrls:[void 0]},d=[{value:"Case 1 Example",id:"case-1-example",level:3},{value:"Case 2 Example",id:"case-2-example",level:3},{value:"Case 3 Example",id:"case-3-example",level:3},{value:"Other details",id:"other-details",level:3}],p={toc:d};function c(e){var t=e.components,a=(0,r.Z)(e,l);return(0,o.mdx)("wrapper",(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,o.mdx)("p",null,"Language support for virtual tables has lagged since I always thought they were of little interest to\nthe language anyway. The ",(0,o.mdx)("inlineCode",{parentName:"p"},"CREATE TABLE")," forms in general are only declarations (except if you're doing\nthe schema installer/upgrader output) and so you could just declare say a temp table that corresponds to the\nvirtual table that you made in the same way that you might declare say ",(0,o.mdx)("inlineCode",{parentName:"p"},"sqlite_master")," if you wanted to use it.\nAnd since you have to register the module anyway, you may as well create the virtual table at the same time."),(0,o.mdx)("p",null,"So there was no point in adding language support for the thing."),(0,o.mdx)("p",null,"Furthermore the ",(0,o.mdx)("inlineCode",{parentName:"p"},"CREATE VIRTUAL TABLE")," form includes no information about the schema of the table so you'd\nneed some kind of declaration anyway in order to tell the language what the columns are for the table you\njust created.  So again you may as well just declare it like a normal table and not include that table in your\nschema upgrade file and be done with it."),(0,o.mdx)("p",null,"And that was my thinking for the last 2 years. And then I learned something."),(0,o.mdx)("p",null,"Virtual tables are durable."),(0,o.mdx)("p",null,"Yeah, I always assumed that virtual tables were temp tables and they vanish and have to be redeclared every\nsession but that is not the case.  They are part of the durable schema so while you must pre-register the\nmodule associated with the virtual table, the virtual table is like other tables in that you only create it\nonce and from then on it's part of the schema every time the database loads until you ",(0,o.mdx)("inlineCode",{parentName:"p"},"DROP")," it."),(0,o.mdx)("p",null,"This changes everything."),(0,o.mdx)("p",null,"With virtual tables being durable they belong in the schema upgrade process.  And if they go there they also\nhave to go into the JSON output.  But we can't use the vanilla syntax that SQLite uses because that syntax is:"),(0,o.mdx)("ul",null,(0,o.mdx)("li",{parentName:"ul"},"not parseable, because the module arguments can be literally anything (or nothing), even a letter to your grandma."),(0,o.mdx)("li",{parentName:"ul"},"the arguments do not necessarily say anything about the table's schema at all")),(0,o.mdx)("p",null,"So in the CQL language I change the syntax a bit, the generalized form looks like this:"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"create virtual table virt_table using my_module [(module arguments)]  as (\n  id integer not null,\n  name text\n);\n")),(0,o.mdx)("p",null,"The part after the ",(0,o.mdx)("inlineCode",{parentName:"p"},"AS")," is used by CQL as a table declaration for the virtual table.  The grammar for that\nis exactly the same as a normal ",(0,o.mdx)("inlineCode",{parentName:"p"},"CREATE TABLE")," statement.  However that part is not transmitted to\nSQLite; when the table is created, SQLite sees only the part it cares about, the part before the ",(0,o.mdx)("inlineCode",{parentName:"p"},"AS"),"."),(0,o.mdx)("p",null,"Now this leaves the module arguments, they can be one of three things:"),(0,o.mdx)("ol",null,(0,o.mdx)("li",{parentName:"ol"},"no arguments at all"),(0,o.mdx)("li",{parentName:"ol"},"a list of identifiers, constants, and parenthesized sublists just like in the ",(0,o.mdx)("inlineCode",{parentName:"li"},"@attribute")," form"),(0,o.mdx)("li",{parentName:"ol"},"the words ",(0,o.mdx)("inlineCode",{parentName:"li"},"arguments following"))),(0,o.mdx)("h3",{id:"case-1-example"},"Case 1 Example"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"create virtual table virt_table using my_module as (\n  id integer not null,\n  name text\n);\n")),(0,o.mdx)("p",null,"becomes (to SQLite)"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"CREATE TABLE virt_table USING my_module;\n")),(0,o.mdx)("p",null,"Note: empty arguments ",(0,o.mdx)("inlineCode",{parentName:"p"},"USING my_module()")," are not allowed in the SQLite docs but do seem to work in SQLite.\nWe take the position that no args should be done with no parens, at least for now."),(0,o.mdx)("h3",{id:"case-2-example"},"Case 2 Example"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"create virtual table virt_table using my_module(foo, 'goo', (1.5, (bar, baz))) as (\n  id integer not null,\n  name text\n);\n")),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},'CREATE VIRTUAL TABLE virt_table USING my_module(foo, "goo", (1.5, (bar, baz)));\n')),(0,o.mdx)("p",null,"This form allows for very flexible arguments but not totally arbitrary arguments, so it can still be\nparsed and validated."),(0,o.mdx)("h3",{id:"case-3-example"},"Case 3 Example"),(0,o.mdx)("p",null,"This case recognizes the popular choice that the arguments are often the actual schema declaration\nfor the table in question. So"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"create virtual table virt_table using my_module(arguments following) as (\n  id integer not null,\n  name text\n);\n")),(0,o.mdx)("p",null,"becomes"),(0,o.mdx)("pre",null,(0,o.mdx)("code",{parentName:"pre"},"CREATE VIRTUAL TABLE virt_table USING my_module(\n  id INTEGER NOT NULL,\n  name TEXT\n);\n")),(0,o.mdx)("p",null,"The normalized text (keywords capitalized, whitespace normalized) of the table declaration in the ",(0,o.mdx)("inlineCode",{parentName:"p"},"as")," clause is used as the arguments."),(0,o.mdx)("h3",{id:"other-details"},"Other details"),(0,o.mdx)("p",null,"Virtual tables go into their own section in the JSON and they include the ",(0,o.mdx)("inlineCode",{parentName:"p"},"module")," and ",(0,o.mdx)("inlineCode",{parentName:"p"},"moduleArgs")," entries, they are additionally\nmarked ",(0,o.mdx)("inlineCode",{parentName:"p"},"isVirtual")," in case you want to use the same processing code for virtual tables as normal tables.  The JSON format is otherwise\nthe same, although some things can't happen in virtual tables (e.g. there is no ",(0,o.mdx)("inlineCode",{parentName:"p"},"TEMP")," option so ",(0,o.mdx)("inlineCode",{parentName:"p"},'"isTemp"')," must be false in the JSON."),(0,o.mdx)("p",null,"For purposes of schema processing, virtual tables are on the ",(0,o.mdx)("inlineCode",{parentName:"p"},"@recreate")," plan, just like indices, triggers, etc.  This is the only option since\nthe ",(0,o.mdx)("inlineCode",{parentName:"p"},"alter table")," form is not allowed on a virtual table."),(0,o.mdx)("p",null,'Semantic validation enforces "no alter statements on virtual tables" as well as other things like, no indices, and no triggers, since SQLite\ndoes not support any of those things.'),(0,o.mdx)("p",null,"Finally, because virtual tables are on the ",(0,o.mdx)("inlineCode",{parentName:"p"},"@recreate")," plan, you may not have foreign keys that reference virtual tables. Such keys seem\nlike a bad idea in any case."))}c.isMDXComponent=!0}}]);